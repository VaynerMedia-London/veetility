
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../CleaningFunctions/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>Utility Functions - Veetility Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#utility-functions-class-methods" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Veetility Docs" class="md-header__button md-logo" aria-label="Veetility Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Veetility Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Utility Functions
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Veetility Docs" class="md-nav__button md-logo" aria-label="Veetility Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Veetility Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Utility Functions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Utility Functions
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions" class="md-nav__link">
    veetility.utility_functions.UtilityFunctions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.best_fuzzy_match" class="md-nav__link">
    best_fuzzy_match()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.columnnames_to_lowercase" class="md-nav__link">
    columnnames_to_lowercase()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.convert_cumulative_to_daily" class="md-nav__link">
    convert_cumulative_to_daily()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.dupes_some_cols_but_differ_in_others" class="md-nav__link">
    dupes_some_cols_but_differ_in_others()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.get_active_git_branch" class="md-nav__link">
    get_active_git_branch()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.identify_match_multi_cols" class="md-nav__link">
    identify_match_multi_cols()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.identify_paid_or_organic" class="md-nav__link">
    identify_paid_or_organic()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.match_ads" class="md-nav__link">
    match_ads()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.match_shortcode_to_url" class="md-nav__link">
    match_shortcode_to_url()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.merge_match_perc" class="md-nav__link">
    merge_match_perc()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.pickle_data" class="md-nav__link">
    pickle_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.prepare_string_matching" class="md-nav__link">
    prepare_string_matching()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.read_from_gsheet" class="md-nav__link">
    read_from_gsheet()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.read_from_postgresql" class="md-nav__link">
    read_from_postgresql()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.read_json" class="md-nav__link">
    read_json()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.store_daily_organic_data" class="md-nav__link">
    store_daily_organic_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.table_exists" class="md-nav__link">
    table_exists()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.unpickle_data" class="md-nav__link">
    unpickle_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.write_json" class="md-nav__link">
    write_json()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.write_to_gsheet" class="md-nav__link">
    write_to_gsheet()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.write_to_postgresql" class="md-nav__link">
    write_to_postgresql()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../CleaningFunctions/" class="md-nav__link">
        Cleaning
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../QAFunctions/" class="md-nav__link">
        Quality Assessment
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../ViewThroughRate/" class="md-nav__link">
        View Through Rate
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../SlackNotifier/" class="md-nav__link">
        Slack Notifier
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../snowflake/" class="md-nav__link">
        Snowflake
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../LinkedIn_API/" class="md-nav__link">
        LinkedIn API
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions" class="md-nav__link">
    veetility.utility_functions.UtilityFunctions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.best_fuzzy_match" class="md-nav__link">
    best_fuzzy_match()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.columnnames_to_lowercase" class="md-nav__link">
    columnnames_to_lowercase()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.convert_cumulative_to_daily" class="md-nav__link">
    convert_cumulative_to_daily()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.dupes_some_cols_but_differ_in_others" class="md-nav__link">
    dupes_some_cols_but_differ_in_others()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.get_active_git_branch" class="md-nav__link">
    get_active_git_branch()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.identify_match_multi_cols" class="md-nav__link">
    identify_match_multi_cols()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.identify_paid_or_organic" class="md-nav__link">
    identify_paid_or_organic()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.match_ads" class="md-nav__link">
    match_ads()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.match_shortcode_to_url" class="md-nav__link">
    match_shortcode_to_url()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.merge_match_perc" class="md-nav__link">
    merge_match_perc()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.pickle_data" class="md-nav__link">
    pickle_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.prepare_string_matching" class="md-nav__link">
    prepare_string_matching()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.read_from_gsheet" class="md-nav__link">
    read_from_gsheet()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.read_from_postgresql" class="md-nav__link">
    read_from_postgresql()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.read_json" class="md-nav__link">
    read_json()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.store_daily_organic_data" class="md-nav__link">
    store_daily_organic_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.table_exists" class="md-nav__link">
    table_exists()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.unpickle_data" class="md-nav__link">
    unpickle_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.write_json" class="md-nav__link">
    write_json()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.write_to_gsheet" class="md-nav__link">
    write_to_gsheet()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.utility_functions.UtilityFunctions.write_to_postgresql" class="md-nav__link">
    write_to_postgresql()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="utility-functions-class-methods">Utility Functions Class Methods</h1>


<div class="doc doc-object doc-class">


<a id="veetility.utility_functions.UtilityFunctions"></a>
  <div class="doc doc-contents first">

  
      <p>A general purpose class for performing python pipeline functions such as reading/writing to google sheets, postgreSQL databases
storing data as pickle or JSON files, with error handling and automated retries.</p>
<p>Also includes more complicated functions such as for merging paid and organic social data using fuzzy matching and regex or 
storing cumulative data we receieve as a daily incremental total</p>


        <details class="quote">
          <summary>Source code in <code>veetility/utility_functions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">UtilityFunctions</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A general purpose class for performing python pipeline functions such as reading/writing to google sheets, postgreSQL databases</span>
<span class="sd">    storing data as pickle or JSON files, with error handling and automated retries.</span>

<span class="sd">    Also includes more complicated functions such as for merging paid and organic social data using fuzzy matching and regex or </span>
<span class="sd">    storing cumulative data we receieve as a daily incremental total&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="p">,</span> 
            <span class="n">gspread_auth_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">db_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">db_port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">log_name</span><span class="o">=</span><span class="s1">&#39;utility_functions&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise a google sheets connector and postgreSQL connector for the utility instance </span>

<span class="sd">        This means you can only connect to one google account and one database per instance </span>
<span class="sd">        of the UtilityFunctions class.</span>

<span class="sd">        The email address of the google account must be added to the google sheet as a collaborator</span>

<span class="sd">        Args:</span>
<span class="sd">            client_name (str): Used to specify the folder, </span>
<span class="sd">            gspread_auth_dict (dict): A dictionary containing google authorisation data</span>
<span class="sd">            db_user (str): The postgreSQL database username</span>
<span class="sd">            db_password (str): The postgreSQL database password</span>
<span class="sd">            db_host (str): The postgreSQL database host url</span>
<span class="sd">            db_port (str): The postgreSQL database port number as a string, usually 5432</span>
<span class="sd">            db_name (str): The postgreSQL database name</span>
<span class="sd">        Returns:</span>
<span class="sd">            None&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">gspread_auth_dict</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sa</span> <span class="o">=</span> <span class="n">gspread</span><span class="o">.</span><span class="n">service_account_from_dict</span><span class="p">(</span><span class="n">gspread_auth_dict</span><span class="p">)</span>         
        <span class="k">if</span> <span class="n">db_user</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_password</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_name</span> <span class="o">=</span> \
            <span class="n">db_user</span><span class="p">,</span> <span class="n">db_password</span><span class="p">,</span> <span class="n">db_host</span><span class="p">,</span> <span class="n">db_port</span><span class="p">,</span> <span class="n">db_name</span>
            <span class="n">postgres_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;postgresql://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_user</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_password</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_port</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_engine</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">postgres_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span> <span class="o">=</span> <span class="n">client_name</span>
        <span class="c1"># Initialise a logger for the utility functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">client_name</span><span class="p">,</span> <span class="n">log_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare_string_matching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">is_url</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removing unnecessary detail, whitespaces and converting to lower case.</span>

<span class="sd">        Prepare strings for matching say in a merge function by removing unnecessary </span>
<span class="sd">            detail, whitespaces and converting to lower case.</span>

<span class="sd">            Remove URLs and emojis as sometimes they cannot come through properly in Tracer data</span>
<span class="sd">            Replace non-ASCII characters with their closest ASCII equivalents</span>

<span class="sd">            Parameters</span>
<span class="sd">            -----------------</span>
<span class="sd">            string : str </span>
<span class="sd">                The string to be cleaned</span>
<span class="sd">            is_url : bool </span>
<span class="sd">                If True then remove URLs and characters after the &#39;?&#39; which are utm parameters</span>
<span class="sd">                These can be present in some URLs we receive and not others</span>
<span class="sd">            Returns </span>
<span class="sd">            ----------------</span>
<span class="sd">            string : str</span>
<span class="sd">                A cleaned string stripped of whitespace, punctuation, emojis, non-ASCII characters, and URLs.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">string</span>
        <span class="n">string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># Convert the input to a string and make it lower case</span>
        <span class="k">if</span> <span class="n">is_url</span><span class="p">:</span>
            <span class="c1"># Remove URLs and characters after the &#39;?&#39;</span>
            <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Get rid of everything after they start to be utm parameters</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1">#this is commonly for a post message</span>
            <span class="n">string</span> <span class="o">=</span> <span class="n">string</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="c1"># add a space to the end of the string so that the regex below works            </span>
            <span class="n">string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(https?://\S+)\s&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span> <span class="c1"># Remove URLs up to the first whitespace</span>

        <span class="n">string</span> <span class="o">=</span> <span class="n">emoji_pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span> <span class="c1"># remove emojis</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">unidecode</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>  <span class="c1"># replace non-ASCII characters with their closest ASCII equivalents</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\w\s]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span> <span class="c1"># remove punctuation</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">match_ads</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">df_1</span><span class="p">,</span> 
            <span class="n">df_2</span><span class="p">,</span> <span class="n">df_1_exact_col</span><span class="p">,</span> 
            <span class="n">df_2_exact_col</span><span class="p">,</span> <span class="n">extract_shortcode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">df_1_fuzzy_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">df_2_fuzzy_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">is_exact_col_link</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">matched_col_name</span><span class="o">=</span><span class="s1">&#39;boosted&#39;</span><span class="p">,</span> 
            <span class="n">merge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cols_to_merge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">pickle_name</span><span class="o">=</span><span class="s1">&#39;NoStore&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Match row items in df_2 onto row items in df_1 based on two sets of columns,using exact and fuzzy matching.</span>

<span class="sd">        First try to match the row items in df_1 using the first set of columns, if there is no match then try to match</span>
<span class="sd">        the row items in df_2 using the second set of columns and fuzzy matching.</span>
<span class="sd">        For example the first set of columns might be URLs, which tend to be exact matches, and the second set of columns</span>
<span class="sd">        might be post copy, which can have slight variations, for example the post copy from a tracker sheet might be</span>
<span class="sd">        slightly incorrect due to manual entry, therefore fuzzy matching with a threshold of how similar the strings</span>
<span class="sd">        need to be is used.</span>

<span class="sd">        Args:</span>
<span class="sd">            df_1 (DataFrame): The Dataframe that will be searched to see if any corresponding values in df_2, if merge=True df_2 will be left joined onto df_1</span>
<span class="sd">            df_2 (DataFrame): The Dataframe that if merge = True will be left joined onto df_1</span>
<span class="sd">            df_1_exact_col (str): The Column name from df_1 that will be first attempted to find exact matches</span>
<span class="sd">            df_2_exact_col (str): The Column name from df_2 that will be first attempted to find exact matches</span>
<span class="sd">            extract_shortcode (bool): Boolean Flag, if True then the exact match will be attempted on the shortcodes of the df_2_exact_col which should be a url</span>
<span class="sd">            df_1_fuzzy_col (str): The Column name from df_1 that will be attempted to fuzzy match if there was no exact match before.</span>
<span class="sd">            df_2_fuzzy_col (str): The Column name from df_2 that will be attempted to fuzzy match if there was no exact match before.</span>
<span class="sd">            is_exact_col_link (bool): Boolean Flag, is the set of columns to be exact matched hyperlinks? If so they will be cleaned to remove utm parameters.</span>
<span class="sd">            matched_col_name (str): String to name the column which will contain boolean values to indicate whether row items in df_1 found a match in df_2.</span>
<span class="sd">            merge (bool): Boolean Flag, if true then df_2 will be left joined onto df_1. Else df_1 will be left unchanged apart from column indicating whether there is a match.</span>
<span class="sd">            cols_to_merge (list, str): List of strings to merge on if &#39;merge&#39; = True.</span>
<span class="sd">            pickle_name (str): Name of the dictionary of best matches found by fuzzy matching to be stored as a pickle file. The next time the function is run with the same pickle_name, the pickle file is used to find matches without having to do slow fuzzy matching from scratch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            df_1 (DataFrame): The original df_1 with just a column to indicate whether a match has occured if merge = False else df_1 will have df_2 left joined on.</span>
<span class="sd">            df_2 (DataFrame): The original df_2 with cleaned columns and &#39;Match String&#39; column to help quality check why some rows have or haven&#39;t matched.</span>
<span class="sd">            df_2_no_match (DataFrame): A dataframe of df_2 row items that haven&#39;t found a match in df_1.&quot;&quot;&quot;</span>

        <span class="n">df_1</span> <span class="o">=</span> <span class="n">df_1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_1</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;matched&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;df&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)])</span>
        <span class="n">df_2</span> <span class="o">=</span> <span class="n">df_2</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_2</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;matched&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;df&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">cols_to_merge</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cols_to_merge</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">df_1_fuzzy_col</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># If only oen set of columns then first do an exact match then a fuzzy match on just that set of columns</span>
            <span class="n">df_1_fuzzy_col</span> <span class="o">=</span> <span class="n">df_1_exact_col</span>
            <span class="n">df_2_fuzzy_col</span> <span class="o">=</span> <span class="n">df_2_exact_col</span>

        <span class="c1"># Prepare strings in a raw form with no spaces or punctuation in order to increase chance of matching</span>
        <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_1</span><span class="p">[</span><span class="n">df_1_exact_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_string_matching</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">is_url</span><span class="o">=</span><span class="n">is_exact_col_link</span><span class="p">))</span>
        <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="n">df_2_exact_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_string_matching</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">is_url</span><span class="o">=</span><span class="n">is_exact_col_link</span><span class="p">))</span>

        <span class="c1"># Find out the number of unique values of the first cleaned column to match by</span>
        <span class="n">df_1_unique_exact</span> <span class="o">=</span> <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">df_2_unique_exact</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">extract_shortcode</span><span class="p">:</span>
            <span class="c1"># Create a dictionary of mappings between urls in df_2 and shortcodes in df_1</span>
            <span class="n">url_shortcode_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_shortcode_to_url</span><span class="p">(</span><span class="n">df_1_unique_exact</span><span class="p">,</span> <span class="n">df_2_unique_exact</span><span class="p">)</span>
            <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">url_shortcode_dict</span><span class="p">)</span>

        <span class="n">cols_to_merge</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;match_string&#39;</span><span class="p">)</span>

        <span class="c1"># Identify matches between the two dataframes on cols_to_merge,e.g. is there a row with &#39;platform&#39; and &#39;message&#39; in df_1 that matches a row in df_2</span>
        <span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_match_multi_cols</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">cols_to_merge</span><span class="p">,</span> <span class="n">cols_to_merge</span><span class="p">,</span> <span class="s1">&#39;matched_exact&#39;</span><span class="p">)</span>

        <span class="n">df_1</span><span class="p">[</span><span class="n">matched_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matched_fuzzy_df1?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Split Dataframes up into rows that had a URL match and one where the rows didn&#39;t match</span>
        <span class="c1"># Then the ones that didn&#39;t match will try and be matched with the cleaned caption</span>
        <span class="n">df_1_match</span> <span class="o">=</span> <span class="n">df_1</span><span class="p">[</span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matched_exact_df1?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>

        <span class="c1"># Exact column merge match</span>
        <span class="c1"># We don&#39;t match on match_id because we don&#39;t want the cols_to_merge to be duplicated with _x and _y</span>
        <span class="k">if</span> <span class="n">merge</span><span class="p">:</span>
            <span class="n">df_1_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_match_perc</span><span class="p">(</span><span class="n">df_1_match</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">cols_to_merge</span><span class="p">,</span> 
                                                    <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;First set of columns exact match&quot;</span><span class="p">)</span>

        <span class="c1"># Now the match string will be based off the column to be fuzzy matched    </span>
        <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_1</span><span class="p">[</span><span class="n">df_1_fuzzy_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_string_matching</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="n">df_2_fuzzy_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_string_matching</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="c1"># now create a dataframe of the rows that didn&#39;t have an exact match and try and fuzzy match them</span>
        <span class="n">df_1_no_match</span> <span class="o">=</span> <span class="n">df_1</span><span class="p">[</span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matched_exact_df1?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>

        <span class="c1"># Find the unique instances of cleaned captions to be passed to the fuzzy matching function</span>
        <span class="n">df_1_no_match_unique</span> <span class="o">=</span> <span class="n">df_1_no_match</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">df_2_fuzzy_unique</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># the fuzzy match function will return a dictionary of matches for each caption from df_1 with the value</span>
        <span class="c1"># being the fuzzy col of df_2 with the best match above a certain percentage threshold similarity</span>
        <span class="n">best_match_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_fuzzy_match</span><span class="p">(</span><span class="n">df_1_no_match_unique</span><span class="p">,</span> <span class="n">df_2_fuzzy_unique</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">pickle_name</span><span class="p">)</span>

        <span class="c1"># create a column that is the closest match in df_2 for every caption in df_1</span>
        <span class="c1"># This will be used to merge df_2 onto the remainder of none matching df_1</span>
        <span class="n">df_1_no_match</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_1_no_match</span><span class="p">[</span><span class="s2">&quot;match_string&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">best_match_dict</span><span class="p">)</span>

        <span class="c1"># Identify matches between the two dataframes on cols_to_merge,e.g. is there a row with &#39;platform&#39; and &#39;message&#39; in df_1 that matches a row in df_2</span>
        <span class="n">df_1_no_match</span><span class="p">,</span> <span class="n">df_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_match_multi_cols</span><span class="p">(</span><span class="n">df_1_no_match</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">cols_to_merge</span><span class="p">,</span> <span class="n">cols_to_merge</span><span class="p">,</span> <span class="s1">&#39;matched_fuzzy&#39;</span><span class="p">)</span>

        <span class="c1"># Fuzzy match merge the rows that didn&#39;t match on the exact column</span>
        <span class="k">if</span> <span class="n">merge</span><span class="p">:</span>
            <span class="n">df_1_no_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_match_perc</span><span class="p">(</span><span class="n">df_1_no_match</span><span class="p">,</span> <span class="n">df_2</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">df_2_fuzzy_col</span><span class="p">,</span> <span class="s1">&#39;matched_exact_df2?&#39;</span><span class="p">,</span> <span class="s1">&#39;matched_fuzzy_df2?&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                        <span class="n">on</span><span class="o">=</span><span class="n">cols_to_merge</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;Second set of columns fuzzy match&quot;</span><span class="p">)</span>

        <span class="n">df_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_1_match</span><span class="p">,</span> <span class="n">df_1_no_match</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># The matched_col_name indicates whether a match either exact or fuzzy was found</span>
        <span class="n">df_1</span><span class="p">[</span><span class="n">matched_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;matched_exact_df1?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;matched_fuzzy_df1?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">))</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df_2</span><span class="p">[</span><span class="n">matched_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;matched_exact_df2?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;matched_fuzzy_df2?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">))</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Num unique exact col values in df_1 = </span><span class="si">{</span><span class="n">df_1</span><span class="p">[</span><span class="n">df_1_exact_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Num unique fuzzy col values in df_1 = </span><span class="si">{</span><span class="n">df_1</span><span class="p">[</span><span class="n">df_1_fuzzy_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Num unique exact col values in df_2 = </span><span class="si">{</span><span class="n">df_2</span><span class="p">[</span><span class="n">df_2_exact_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Num unique fuzzy col values in df_2 = </span><span class="si">{</span><span class="n">df_2</span><span class="p">[</span><span class="n">df_2_fuzzy_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perc Matched df_1 exact col = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matched_exact_df1?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perc Matched df_1 fuzzy col = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matched_fuzzy_df1?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perc df_2 exact col could have matched = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;matched_exact_df2?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perc df_2 fuzzy col could have matched = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;matched_fuzzy_df2?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perc Matched df_1 matched = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_1</span><span class="p">[</span><span class="n">matched_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perc Matched df_2 matched = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_2</span><span class="p">[</span><span class="n">matched_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span>

    <span class="k">def</span> <span class="nf">identify_match_multi_cols</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">df_1</span><span class="p">,</span> 
            <span class="n">df_2</span><span class="p">,</span> <span class="n">df_1_cols_to_match</span><span class="p">,</span> 
            <span class="n">df_2_cols_to_match</span><span class="p">,</span> <span class="n">match_col_name</span><span class="p">,</span> 
            <span class="n">exclude_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This function will identify if a row in df_1 is in df_2 based on the columns specified in df_1_cols_to_match and df_2_cols_to_match</span>

<span class="sd">        Args:</span>
<span class="sd">            df_1 (pd.DataFrame): The first dataframe to identify matches in</span>
<span class="sd">            df_2 (pd.DataFrame): The second dataframe to identify matches in</span>
<span class="sd">            df_1_cols_to_match (list): The columns in df_1 to look for matches in df_2</span>
<span class="sd">            df_2_cols_to_match (list): The columns in df_2 to look for matches in df_1</span>
<span class="sd">            match_col_name (str): The name of the column to be created in df_1 to indicate if the row is in df_2</span>
<span class="sd">            exclude_values (list): The values to be excluded from the match. Default is [&#39;None&#39;, &#39;none&#39;, &#39;nan&#39;, &#39;&#39;]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">exclude_values</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exclude_values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">is_row_in_dataframe</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">target_df</span><span class="p">,</span> <span class="n">source_cols</span><span class="p">,</span> <span class="n">target_cols</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_df</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_cols</span><span class="p">)):</span>
                <span class="n">current_condition</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">target_df</span><span class="p">[</span><span class="n">target_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="n">source_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">source_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_values</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">target_df</span><span class="p">[</span><span class="n">target_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">source_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
                <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">current_condition</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">target_df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="n">df_1</span><span class="p">[</span><span class="n">match_col_name</span> <span class="o">+</span> <span class="s1">&#39;_df1?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">is_row_in_dataframe</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">df_1_cols_to_match</span><span class="p">,</span> <span class="n">df_2_cols_to_match</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df_2</span><span class="p">[</span><span class="n">match_col_name</span> <span class="o">+</span> <span class="s1">&#39;_df2?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">is_row_in_dataframe</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">df_1</span><span class="p">,</span> <span class="n">df_2_cols_to_match</span><span class="p">,</span> <span class="n">df_1_cols_to_match</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span>

    <span class="k">def</span> <span class="nf">best_fuzzy_match</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">list_1</span><span class="p">,</span> 
            <span class="n">list_2</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> 
            <span class="n">json_name</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes in two lists of strings and every string in list_1 is fuzzy matched onto every item in list_2</span>
<span class="sd">        The fuzzy match of a string in list_1 with a string in list_2 with the highest score will count as the </span>
<span class="sd">        match as long as it is above the threshold. The match is then stored as a key value pair in a dictionary</span>

<span class="sd">        The dictionary of matches will be saved as a pickle file to be used next time the function is run to save</span>
<span class="sd">        having to do searches on a string if we&#39;ve already found a match in the past</span>

<span class="sd">        Args:</span>
<span class="sd">            list_1 (list): First List of strings, every item will be searched for a fuzzy match in list_2</span>
<span class="sd">            list_2 (list): Second List of strings, every item in list_1 will be fuzzy matched with every item in list 2 and best fuzzy match score wins</span>
<span class="sd">            threshold (integer): value between 0 and 100 signifying percentage fuzzy match score at which a match is considered sufficiently close</span>
<span class="sd">            json_name (str): Name of json file to store dictionary of matches in</span>

<span class="sd">        Returns:</span>
<span class="sd">            best_match_dict (dict): Dictionary of matches (with highest fuzzy match score) between strings in list_1 and list_2 </span>
<span class="sd">                    key = string in list_1, value = string in list_2 &quot;&quot;&quot;</span>

        <span class="n">best_match_dict</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="n">stored_best_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">base_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LOG_DIR&#39;</span><span class="p">)</span>
        <span class="c1"># Create a client specific log directory</span>
        <span class="n">client_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_log_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="p">)</span>
        <span class="n">json_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">client_log_dir</span><span class="p">,</span> <span class="s1">&#39;JSON Files&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">json_folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">json_folder</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">json_name</span> <span class="o">!=</span> <span class="s1">&#39;NoStore&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">json_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;best_match_dict_</span><span class="si">{</span><span class="n">json_name</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">)):</span>
                <span class="n">stored_best_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;best_match_dict_</span><span class="si">{</span><span class="n">json_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;Dictionary&#39;</span><span class="p">,</span> <span class="n">json_folder</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loaded dict of len :</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stored_best_dict</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">string_1</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">list_1</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">string_1</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">best_match_dict</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                <span class="k">continue</span>
            <span class="c1"># If there is an exact match then just put the match as itself and no need to go through list</span>
            <span class="k">if</span> <span class="n">string_1</span> <span class="ow">in</span> <span class="n">list_2</span><span class="p">:</span>  
                <span class="n">best_match_dict</span><span class="p">[</span><span class="n">string_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_1</span>
                <span class="k">continue</span>

            <span class="c1">#If there is a match in the stored dictionary then use that</span>
            <span class="k">if</span> <span class="n">string_1</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">stored_best_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> 
                <span class="n">best_match_dict</span><span class="p">[</span><span class="n">string_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stored_best_dict</span><span class="p">[</span><span class="n">string_1</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="c1">#Then go through every string in the second list and fuzzy match to produce a score</span>
            <span class="c1">#If the score is below the threshold then set the score to 0</span>
            <span class="n">temp_match_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">string_2</span> <span class="ow">in</span> <span class="n">list_2</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">string_1</span><span class="p">,</span> <span class="n">string_2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">temp_match_dict</span><span class="p">[</span><span class="n">string_2</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

            <span class="c1">#if there were no matches above the threshold then return a match for that </span>
            <span class="c1">#string in list_1 equal to &quot;none&quot;</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">temp_match_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">best_match_dict</span><span class="p">[</span><span class="n">string_1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># find the match with the highest matching score and save that to the</span>
                <span class="c1"># best match dictionary</span>
                <span class="n">best_match</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">temp_match_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">best_match_dict</span><span class="p">[</span><span class="n">string_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_match</span>

        <span class="k">if</span> <span class="n">json_name</span> <span class="o">!=</span> <span class="s1">&#39;NoStore&#39;</span><span class="p">:</span>
            <span class="c1"># Remove matches that didn&#39;t find anythign as that will let new values be discovered</span>
            <span class="c1"># if new data comes in</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">best_match_dict</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;best_match_dict_</span><span class="si">{</span><span class="n">json_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;Dictionary&#39;</span><span class="p">,</span> <span class="n">json_folder</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">best_match_dict</span>

    <span class="k">def</span> <span class="nf">write_to_postgresql</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> 
            <span class="n">table_name</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes a dataframe to a PostgreSQL database table using a SQLalchemy engine defined elsewhere.</span>
<span class="sd">        If writing fails it waits 10 seconds then trys again</span>

<span class="sd">        Args:</span>
<span class="sd">            df (DataFrame): The Dataframe to send to the PostGreSQL table</span>
<span class="sd">            table_name (str): The name of the table to write the dataframe to</span>
<span class="sd">            if_exists (str): Either &#39;replace&#39; or &#39;append&#39; which describes what to do if a table with that name already exists</span>

<span class="sd">        Returns:</span>
<span class="sd">            error_message (str): An error message saying that the connection has failed &quot;&quot;&quot;</span>
        <span class="c1"># create a SQL alchemy engine to write the data to the database after cleaning</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">dt_string</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DateWrittenToDB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_string</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;index&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_engine</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">)</span>
            <span class="n">time_taken</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time Taken to write </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">time_taken</span><span class="si">}</span><span class="s2">secs&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sent Data to </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># Wait for 10 seconds then try again</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_engine</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">)</span>
                <span class="n">time_taken</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time Taken to write </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">time_taken</span><span class="si">}</span><span class="s2">secs&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error_message</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connection failed again </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s1"> error: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error_message</span>

    <span class="k">def</span> <span class="nf">store_daily_organic_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">output_table_name</span><span class="p">,</span> 
            <span class="n">num_days_to_store</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">date_col_name</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
            <span class="n">dayfirst</span><span class="o">=</span><span class="s2">&quot;EnterValue&quot;</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="s2">&quot;EnterValue&quot;</span><span class="p">,</span> 
            <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">,</span>
            <span class="n">check_created_col</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">created_col</span><span class="o">=</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> 
            <span class="n">refresh_lag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cumulative_metric_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">unique_id_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">require_run_after_hour</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_after_hour</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts a post level organic dataframe to a daily level dataframe and stores it in a PostGreSQL table.</span>

<span class="sd">        Most organic data is stored at the post level and this function converts it to a daily level dataframe</span>
<span class="sd">        and stores it in a PostGreSQL table. It also converts the cumulative metrics to daily difference metrics.</span>
<span class="sd">        The date column is parsed through with the correct format, dayfirst and yearfirst values needing to be specified.</span>
<span class="sd">        If the table already exists then it checks the date_updated column to see if the data has already been</span>
<span class="sd">        updated today. If it has then it doesn&#39;t update the table. If it hasn&#39;t then it updates the table.</span>
<span class="sd">        If the table doesn&#39;t exist then it creates it.</span>
<span class="sd">        If the require_run_after_hour is set to True then it will only run if the current time is after the</span>
<span class="sd">        run_after_hour time which is in 24 hour format but only the hour is used.</span>
<span class="sd">        If check_created_col is set to True then it will only run if the created column is less than the</span>
<span class="sd">        refresh_lag days ago. This is to ensure that the data is up to date before it is stored. This &quot;created&quot; </span>
<span class="sd">        columns appears in databases from tracer and tells us when Tracer last updated the row items. Tracer is </span>
<span class="sd">        a day behind hence the refresh_lag of 1 day.</span>
<span class="sd">        The date_row_added column is added to the dataframe and is the date that the row was added to the</span>
<span class="sd">        data output_table.</span>
<span class="sd">        The date_first_tracked column is added to the dataframe and is the date that a unique post as defined</span>
<span class="sd">        by the unique_id_cols was first tracked</span>
<span class="sd">        The date_diff column is added to the dataframe and is the number of days difference between when the post</span>
<span class="sd">        was first tracked and when that particular row item was added to the data output_table.</span>


<span class="sd">        Args:</span>
<span class="sd">            df (DataFrame): The dataframe to be converted to a daily level dataframe and stored in a PostGreSQL table</span>
<span class="sd">            output_table_name (str): The name of the table to store the data in</span>
<span class="sd">            num_days_to_store (int, optional): The number of days worth of data per post to store in the table. Defaults to 30.</span>
<span class="sd">            date_col_name (str, optional): The name of the date column in the dataframe that will be formatted. Defaults to &#39;date&#39;.</span>
<span class="sd">            dayfirst (str, optional): Whether the day is the first value in the date column. Defaults to &quot;EnterValue&quot;.</span>
<span class="sd">            yearfirst (str, optional): Whether the year is the first value in the date column. Defaults to &quot;EnterValue&quot;.</span>
<span class="sd">            format (str, optional): The format of the date column. Defaults to None.</span>
<span class="sd">            errors (str, optional): How to handle errors in the date column. Defaults to &#39;raise&#39;.</span>
<span class="sd">            check_created_col (bool, optional): Whether to check the created column to ensure the data is up to date. Defaults to True.</span>
<span class="sd">            created_col (str, optional): The name of the created column. Defaults to &#39;created&#39;.</span>
<span class="sd">            refresh_lag (int, optional): The number of days to check the created column is less than. Defaults to 1.</span>
<span class="sd">            cumulative_metric_cols (list, optional): The list of cumulative metrics to convert to daily difference metrics. Defaults to [&#39;impressions&#39;,&#39;reach&#39;,&#39;video_views&#39;,&#39;reactions&#39;,&#39;comments&#39;,&#39;shares&#39;].</span>
<span class="sd">            unique_id_cols (list, optional): The list of columns that uniquely identify a post. Defaults to None.</span>
<span class="sd">            require_run_after_hour (bool, optional): Whether to only run the function if the current time is after the run_after_hour time. Defaults to False.</span>
<span class="sd">            run_after_hour (int, optional): The hour of the day to run the function after in 24 hour format. Defaults to 15.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: the function writes the data to a postgresql table &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cumulative_metric_cols</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cumulative_metric_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;impressions&#39;</span><span class="p">,</span> <span class="s1">&#39;reach&#39;</span><span class="p">,</span> <span class="s1">&#39;video_views&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;shares&#39;</span>
                                      <span class="p">]</span>
        <span class="n">today_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="n">today_date</span> <span class="o">=</span> <span class="n">today_datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">require_run_after_hour</span> <span class="ow">and</span> <span class="p">(</span><span class="n">today_datetime</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="n">run_after_hour</span><span class="p">):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Require run after hour is set to True and it is before the run after hour time&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1">#Check Tracer data has actually updated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">output_table_name</span><span class="p">):</span>
            <span class="n">old_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_from_postgresql</span><span class="p">(</span><span class="n">output_table_name</span><span class="p">,</span> <span class="n">clean_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="n">date_col_name</span><span class="p">,</span>
                                               <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_df</span><span class="p">[</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">today_date</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;It looks data has already pushed to </span><span class="si">{</span><span class="n">output_table_name</span><span class="si">}</span><span class="s2"> today&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">created_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">today_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">refresh_lag</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">check_created_col</span><span class="p">):</span>
                    <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;It looks like the input df has not been updated yesterday. Therefore there is no fresh data to add on.&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
                <span class="n">cutoff_date</span> <span class="o">=</span> <span class="n">today_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">num_days_to_store</span><span class="p">)</span>

                <span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">,</span>
                                        <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">cutoff_date</span><span class="p">)]</span> <span class="c1"># Filter data only after the cutoff date</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">today_datetime</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_first_tracked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">unique_id_cols</span><span class="p">)[</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">old_df</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">cumulative_metric_cols</span><span class="p">:</span> 
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cum_&#39;</span><span class="o">+</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="c1"># Set the cumulative metrics to the same value as the daily metrics</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">output_table_name</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

                <span class="n">daily_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_cumulative_to_daily</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cumulative_metric_cols</span><span class="p">,</span> <span class="n">unique_id_cols</span><span class="p">,</span> <span class="s1">&#39;date_row_added&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">daily_df</span><span class="p">,</span> <span class="n">output_table_name</span> <span class="o">+</span> <span class="s1">&#39;_daily_conv&#39;</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1">#if the table doesn&#39;t exist create it with the whole dataset for the first time</span>
            <span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">,</span>
                                        <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">today_datetime</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_first_tracked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">today_datetime</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">output_table_name</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

            <span class="n">daily_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_cumulative_to_daily</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cumulative_metric_cols</span><span class="p">,</span> <span class="n">unique_id_cols</span><span class="p">,</span> <span class="s1">&#39;date_row_added&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">daily_df</span><span class="p">,</span> <span class="n">output_table_name</span> <span class="o">+</span> <span class="s1">&#39;_daily_conv&#39;</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">convert_cumulative_to_daily</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> 
            <span class="n">metric_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">unique_identifier_cols</span><span class="o">=</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> 
            <span class="n">date_row_added_col</span><span class="o">=</span><span class="s1">&#39;date_row_added&#39;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert cumulative metrics to daily metrics for a given dataframe.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (DataFrame): The dataframe to convert the cumulative metrics to daily metrics</span>
<span class="sd">            metric_list (list, optional): The list of metrics to convert. Defaults to [&#39;impressions&#39;,&#39;comments&#39;,&#39;clicks&#39;,</span>
<span class="sd">                                    &#39;link_clicks&#39;,&#39;likes&#39;,&#39;saved&#39;,&#39;shares&#39;,&#39;video_views&#39;].</span>
<span class="sd">            unique_identifier_cols (list, optional): The list of columns that uniquely identify a post. Defaults to &#39;url&#39;.</span>
<span class="sd">            date_row_added_col (str, optional): The name of the column that contains the date the row was added to the dataframe. Defaults to &#39;date_row_added&#39;.</span>
<span class="sd">        Returns:</span>
<span class="sd">            df (DataFrame): The dataframe with the cumulative metrics converted to daily metrics&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">metric_list</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metric_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;impressions&#39;</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;clicks&#39;</span><span class="p">,</span>
                <span class="s1">&#39;link_clicks&#39;</span><span class="p">,</span> <span class="s1">&#39;likes&#39;</span><span class="p">,</span> <span class="s1">&#39;saved&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;shares&#39;</span><span class="p">,</span> <span class="s1">&#39;video_views&#39;</span>
            <span class="p">]</span>
        <span class="c1">#rename the metric list to create by appending &#39;cum_&#39; to the start of each metric</span>
        <span class="n">cum_metric_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cum_&#39;</span> <span class="o">+</span> <span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metric_list</span><span class="p">]</span>
        <span class="c1">#Check if the cumulative metrics have been calculated before</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="s1">&#39;cum_&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]):</span>
            <span class="n">conversion_run_before</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">previous_cum_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;cum_&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">previous_cum_metrics</span> <span class="o">!=</span> <span class="n">cum_metric_list</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The cumulative metrics in the dataframe do not match the cumulative metrics in the metric list</span><span class="se">\</span>
<span class="s2">                                 input parameter&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conversion_run_before</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">conversion_run_before</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># If the cumulative metrics have not been calculated before then </span>
            <span class="c1"># Duplicate the metrics from the dataframe as by default the metrics are cumulative</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metric_list</span><span class="p">:</span>
                <span class="c1">#set the cumulative metrics to the same value as the daily metrics</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cum_&#39;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
                <span class="n">cum_metric_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cum_&#39;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unique_identifier_cols</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># If the entry is a string just convert it to a list</span>
            <span class="n">unique_identifier_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">unique_identifier_cols</span><span class="p">]</span>
        <span class="c1"># Sort the dataframe by the unique identifier columns and the date the row was added</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">unique_identifier_cols</span><span class="o">+</span><span class="p">[</span><span class="n">date_row_added_col</span><span class="p">])</span>
        <span class="c1"># Calculate the daily metrics by subtracting the previous day&#39;s cumulative metric from the current day&#39;s cumulative metric</span>
        <span class="n">metrics_updated</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">unique_identifier_cols</span><span class="p">)[</span><span class="n">cum_metric_list</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="n">metric_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_updated</span>
        <span class="n">df_metrics</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">metric_list</span><span class="p">]</span>
        <span class="c1"># Set negative values to zero, cumulative totals can decrease, potentially due to people accidently liking posts</span>
        <span class="n">df_metrics</span><span class="p">[</span><span class="n">df_metrics</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="p">[</span><span class="n">metric_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_metrics</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">get_active_git_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the name of the currently active Git branch.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the active Git branch cannot be found or there&#39;s any other error.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The name of the active Git branch.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use &#39;git&#39; command to get the symbolic reference for the HEAD (current branch)</span>
            <span class="c1"># The command is: git symbolic-ref --short HEAD</span>
            <span class="n">git_branch</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;symbolic-ref&quot;</span><span class="p">,</span> <span class="s2">&quot;--short&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">],</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">git_branch</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No active Git branch found.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">git_branch</span>

        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Catch the error from the subprocess call</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while trying to get active Git branch: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Catch any other exceptions</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">table_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a table with the given name exists in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            table_name (str): name of the table to check for existence.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if table exists, False otherwise.&quot;&quot;&quot;</span>
        <span class="n">all_table_names</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_engine</span><span class="p">)</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">table_name</span> <span class="ow">in</span> <span class="n">all_table_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">match_shortcode_to_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shortcode_list</span><span class="p">,</span> <span class="n">url_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Matches a list of shortcodes to a list of urls, creates a dictionary of the matches.</span>

<span class="sd">        Args:</span>
<span class="sd">            shortcode_list (list): A list of shortcodes to match to urls.</span>
<span class="sd">            url_list (list): A list of urls to match to shortcodes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            url_shortcode_dict (dict): A dictionary of the matches between shortcodes and urls.&quot;&quot;&quot;</span>
        <span class="n">url_shortcode_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">shortcode</span> <span class="ow">in</span> <span class="n">shortcode_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">shortcode</span><span class="p">):</span>
                    <span class="k">continue</span>
            <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">url_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shortcode</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
                    <span class="n">url_shortcode_dict</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">shortcode</span>
        <span class="k">return</span> <span class="n">url_shortcode_dict</span>


    <span class="k">def</span> <span class="nf">read_from_postgresql</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> 
            <span class="n">clean_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">dayfirst</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reads a table from a PostgreSQL database table using a pscopg2 connection.</span>
<span class="sd">        If fails it waits 10 seconds and tries again.</span>

<span class="sd">        Args:</span>
<span class="sd">            table_name (str): The name of the table to read from.</span>
<span class="sd">            clean_date (bool, optional): Whether or not to clean the date column. Defaults to True.</span>
<span class="sd">            date_col (str, optional): The column name of the date column to clean. </span>
<span class="sd">            dayfirst (str, optional): The day first format for date parsing. </span>
<span class="sd">            yearfirst (str, optional): The year first format for date parsing.</span>
<span class="sd">            format (str, optional): The format for date parsing. Defaults to None.</span>
<span class="sd">            errors (str, optional): The behavior for date parsing errors. Defaults to &#39;raise&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            df (pandas.DataFrame): The table data in a pandas dataframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">date_param_error_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">clean_date</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">date_col</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">date_param_error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;date_col&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dayfirst</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">date_param_error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;dayfirst&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">yearfirst</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">date_param_error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;yearfirst&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_param_error_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The following parameters are required to clean the date column: </span><span class="si">{</span><span class="n">date_param_error_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">min_max_date</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">date_col</span><span class="p">,</span> <span class="n">clean_date</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">clean_date</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">,</span>
                                        <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;- Min Date: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s1">, Max Date: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># Connect to the PostgreSQL database</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_host</span><span class="p">,</span>
                    <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_port</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_password</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to read the table</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
            <span class="n">time_taken</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">time_taken</span><span class="si">}</span><span class="s2">secs</span><span class="si">{</span><span class="n">min_max_date</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">date_col</span><span class="p">,</span><span class="w"> </span><span class="n">clean_date</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error_message</span><span class="p">:</span>
            <span class="c1"># If reading the table fails, log the error and wait 10 seconds before trying again</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> error: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
            <span class="n">time_taken</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time taken to read </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">time_taken</span><span class="si">}</span><span class="s2">secs</span><span class="si">{</span><span class="n">min_max_date</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">date_col</span><span class="p">,</span><span class="w"> </span><span class="n">clean_date</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Close the database connection</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">dupes_some_cols_but_differ_in_others</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> 
            <span class="n">subset_cols</span><span class="p">,</span> <span class="n">diff_cols</span><span class="p">,</span>
            <span class="n">return_mode</span><span class="o">=</span><span class="s1">&#39;only_differing_duplicates&#39;</span><span class="p">,</span> 
            <span class="n">max_value_keep_col</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identifies rows that are duplicates in some columns but differ in others.</span>

<span class="sd">        This is useful in some cases when you want to find specific types of duplicates</span>
<span class="sd">        caused by specific types of errors. For example social media posts that have the</span>
<span class="sd">        same URL but differ in the number of impressions.</span>

<span class="sd">        For the &quot;only_differing_duplicates&quot; return_mode, the function will return the rows that are duplicates in the </span>
<span class="sd">        subset_cols but differ in the diff_cols.</span>

<span class="sd">        For the &quot;max_value&quot; return_mode, the function will return the original and keep only the row with the max </span>
<span class="sd">        value in the max_value_keep_col</span>


<span class="sd">        Args:</span>
<span class="sd">            df (DataFrame): The dataframe to identify the rows in</span>
<span class="sd">            subset_cols (list): The columns to check for duplicates in</span>
<span class="sd">            diff_cols (list): The columns to check for differences in</span>
<span class="sd">            return_mode (str, optional): The mode to return the duplicates in. Options are &#39;only_differing_duplicates&#39; </span>
<span class="sd">                or &#39;max_value&#39;. Defaults to &#39;only_differing_duplicates&#39;</span>
<span class="sd">            max_value_keep_col (str, optional): The column to use to determine which row to use to find the max value of and therefore keep</span>
<span class="sd">                the row item with the highest value when return_mode is &#39;max_value&#39;. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            df_dupes (DataFrame): Depending on the return mode, either the rows that are duplicates in the subset_cols but differ in the diff_cols or</span>
<span class="sd">                the original dataframe with only the row with the max value in the max_value_keep_col &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">return_mode</span> <span class="o">==</span> <span class="s1">&#39;only_differing_duplicates&#39;</span><span class="p">:</span>
        <span class="c1"># Find rows that are duplicated based on subset_columns</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">subset_cols</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>

            <span class="c1"># Filter rows where any of the diff_columns have more than one unique value within each group</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">duplicates</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">subset_cols</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">diff_cols</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">elif</span> <span class="n">return_mode</span> <span class="o">==</span> <span class="s1">&#39;max_value&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">max_value_keep_col</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_value_keep_col must be provided when return_mode is &#39;max_value&#39;&quot;</span><span class="p">)</span>

            <span class="c1"># Sort the dataframe by max_value_keep_col in descending order</span>
            <span class="n">df_sorted</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">max_value_keep_col</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Drop duplicates based on subset_columns and keep the first occurrence (which has the max value due to sorting)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">df_sorted</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">subset_cols</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid return_mode. Choose either &#39;only_differing_duplicates&#39; or &#39;max_value&#39;&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">write_to_gsheet</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">workbook_name</span><span class="p">,</span> 
            <span class="n">sheet_name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> 
            <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">sheet_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write a dataframe to a google sheet</span>

<span class="sd">        Args:</span>
<span class="sd">            workbook_name (str): The name of the google sheet workbook.</span>
<span class="sd">            sheet_name (str): The name of the sheet to write data to.</span>
<span class="sd">            df (pandas.DataFrame): The dataframe to be written to the google sheet.</span>
<span class="sd">            if_exists (str, optional): Determines the behavior when the sheet already exists, options are &#39;replace&#39; or &#39;append&#39;. (default=&#39;replace&#39;)</span>
<span class="sd">            sheet_prefix (str, optional): A prefix to be added to the sheet name. (default=&#39;&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            None    &quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">dt_string</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SheetUpdated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_string</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Adding the sheet prefix to the sheet name</span>
            <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">sheet_prefix</span> <span class="o">+</span> <span class="n">sheet_name</span>
            <span class="c1"># Open the worksheet</span>
            <span class="n">sheet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sa</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">workbook_name</span><span class="p">)</span><span class="o">.</span><span class="n">worksheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">if_exists</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span> 
                <span class="c1"># Clear the sheet if if_exists is set to &#39;replace&#39;</span>
                <span class="n">sheet</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># Write the dataframe to the sheet</span>
            <span class="n">gd</span><span class="o">.</span><span class="n">set_with_dataframe</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">time_taken</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time Taken to write to google sheet </span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">time_taken</span><span class="si">}</span><span class="s2">secs&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error_message</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">gd</span><span class="o">.</span><span class="n">set_with_dataframe</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_from_gsheet</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">workbook_name</span><span class="p">,</span> 
            <span class="n">sheet_name</span><span class="p">,</span> <span class="n">clean_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
            <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span>
            <span class="n">dayfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> 
            <span class="n">yearfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> 
            <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read data from a google sheet and return it as a dataframe.</span>

<span class="sd">        Args:</span>
<span class="sd">            workbook_name (str): The name of the google sheet workbook.</span>
<span class="sd">            sheet_name (str): The name of the sheet to read data from.</span>
<span class="sd">            clean_date (bool): If true, the &#39;date_col&#39; column will be converted to datetime format. (default: True)</span>
<span class="sd">            date_col (str): The name of the column containing the date values to be cleaned. (default: &#39;EnterValue&#39;)</span>
<span class="sd">            dayfirst (bool): Whether to interpret the first value in an ambiguous 3-integer date (e.g. 01/05/09) as the day (True) or month (False). (default: &#39;EnterValue&#39;)</span>
<span class="sd">            yearfirst (bool): Similar to &#39;dayfirst&#39;, but for the year. (default: &#39;EnterValue&#39;)</span>
<span class="sd">            format (str): The format of the date values. (default: None)</span>
<span class="sd">            errors (str): The behavior when encountering errors in the date format. (default: &#39;raise&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            df (pandas.DataFrame): The dataframe containing the data from the google sheets&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">spreadsheet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sa</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">workbook_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error_message</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">spreadsheet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sa</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">workbook_name</span><span class="p">)</span>
        <span class="n">worksheet</span> <span class="o">=</span> <span class="n">spreadsheet</span><span class="o">.</span><span class="n">worksheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">get_all_records</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">clean_date</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">,</span>
                                            <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>


    <span class="k">def</span> <span class="nf">identify_paid_or_organic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify whether a given dataframe contains paid data&quot;&quot;&quot;</span>
        <span class="n">paid_or_organic</span> <span class="o">=</span> <span class="s1">&#39;Organic&#39;</span>
        <span class="c1"># Make columns to check lower case so can work on</span>
        <span class="c1"># Columns that have or haven&#39;t been cleaned</span>
        <span class="n">col_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="c1"># Check to see whether &quot;spend&quot; or &quot;spend_usd&quot; is in the column list</span>
        <span class="k">if</span> <span class="s1">&#39;spend&#39;</span> <span class="ow">in</span> <span class="n">col_list</span> <span class="ow">or</span> <span class="s1">&#39;spend_usd&#39;</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">:</span>
            <span class="n">paid_or_organic</span> <span class="o">=</span> <span class="s1">&#39;Paid&#39;</span>    
        <span class="k">return</span> <span class="n">paid_or_organic</span>

    <span class="k">def</span> <span class="nf">pickle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;Pickled Files&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pickle data and save it to a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Object): The data to be pickled.</span>
<span class="sd">            filename (str): The name of the file to save the pickled data to.</span>
<span class="sd">            folder (str, optional): The folder to save the pickled file to. Defaults to &quot;Pickled Files&quot;.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">unpickle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span><span class="s2">&quot;Pickled Files&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load pickled data from a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): The name of the file to load the pickled data from.</span>
<span class="sd">            folder (str, optional): The folder where the pickled file is located. Defaults to &quot;Pickled Files&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Object: The unpickled data&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> 
            <span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> 
            <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;JSON Files&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write a Python object to a json file.</span>

<span class="sd">        Args:</span>
<span class="sd">            object (Object): The Python object to be written to a json file.</span>
<span class="sd">            file_name (str): The name of the json file to be created.</span>
<span class="sd">            file_type (str): The type of the object. It must be &#39;DataFrame&#39;, &#39;List&#39; or &#39;Dictionary&#39;</span>
<span class="sd">            folder (str, optional): The folder to save the json file to. Defaults to &quot;JSON Files&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;List&#39;</span> <span class="ow">or</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;Dictionary&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;append&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;JSON write error, file_type error&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_json</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> 
            <span class="n">file_type</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;JSON Files&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read a json file and return a Python object.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_name (str): The name of the json file to be read.</span>
<span class="sd">            file_type (str): The type of the object. It must be &#39;DataFrame&#39;, &#39;List&#39; or &#39;Dictionary&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            Object: The object read from json file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;List&#39;</span> <span class="ow">or</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;Dictionary&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;append&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">infile</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;JSON read error, file_type error&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">columnnames_to_lowercase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change the columns in a dataframe into lowercase with spaces replaced by underscores&quot;&quot;&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">merge_match_perc</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> 
            <span class="n">left_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> 
            <span class="n">ignore_values_df2</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merges two dataframes and prints out the number of matches and the percentage of matches out of the total number of rows.</span>

<span class="sd">        Args:</span>
<span class="sd">            df_1 (pd.DataFrame): The first dataframe to merge</span>
<span class="sd">            df_2 (pd.DataFrame): The second dataframe to merge</span>
<span class="sd">            left_on (str): The column name to merge on in the first dataframe</span>
<span class="sd">            right_on (str): The column name to merge on in the second dataframe</span>
<span class="sd">            how (str, optional): The type of merge to perform. Defaults to &#39;left&#39;.</span>
<span class="sd">            tag (str, optional): A tag to add to the print statement. Defaults to &quot;&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            output_df (pd.DataFrame): A pandas dataframe that contains the merged data from the input dataframes.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ignore_values_df2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ignore_values_df2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">right_on</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;no_merge_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="n">right_on</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">ignore_values_df2</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">on</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;no_merge_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="n">on</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">ignore_values_df2</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">df_1_rows_before</span> <span class="o">=</span> <span class="n">df_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Number of rows in df_1</span>
        <span class="k">if</span> <span class="s1">&#39;_merge&#39;</span> <span class="ow">in</span> <span class="n">df_1</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="c1"># If df_1 has a _merge column, drop it</span>
            <span class="n">df_1</span> <span class="o">=</span> <span class="n">df_1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_merge&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">output_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;no_merge_flag&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">],</span> <span class="n">left_on</span><span class="o">=</span><span class="n">left_on</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="n">right_on</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">how</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">on</span><span class="p">,</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Drop the flag column in the merged dataframe</span>
        <span class="n">output_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;no_merge_flag&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">df_1_rows_after</span> <span class="o">=</span> <span class="n">output_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#number of rows in output_df after merge</span>

        <span class="c1"># Count the number of matches by using the &quot;_merge&quot; column that is created by &quot;indicator=True&quot;</span>
        <span class="n">num_matches</span> <span class="o">=</span> <span class="n">output_df</span><span class="p">[</span><span class="s1">&#39;_merge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="s1">&#39;both&#39;</span><span class="p">]</span>
        <span class="n">match_perc</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">num_matches</span> <span class="o">/</span> <span class="n">df_1_rows_after</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> df_1 has </span><span class="si">{</span><span class="n">df_1_rows_before</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_matches</span><span class="si">}</span><span class="s1"> matches, how = </span><span class="si">{</span><span class="n">how</span><span class="si">}</span><span class="s1">, out of </span><span class="si">{</span><span class="n">df_1_rows_after</span><span class="si">}</span><span class="s1"> rows (</span><span class="si">{</span><span class="n">match_perc</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows after minus rows before </span><span class="si">{</span><span class="n">df_1_rows_after</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">df_1_rows_before</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_df</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">client_name</span><span class="p">,</span> <span class="n">gspread_auth_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_name</span><span class="o">=</span><span class="s1">&#39;utility_functions&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Initialise a google sheets connector and postgreSQL connector for the utility instance </p>
<p>This means you can only connect to one google account and one database per instance 
of the UtilityFunctions class.</p>
<p>The email address of the google account must be added to the google sheet as a collaborator</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>client_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Used to specify the folder, </p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>gspread_auth_dict</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionary containing google authorisation data</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>db_user</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The postgreSQL database username</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>db_password</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The postgreSQL database password</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>db_host</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The postgreSQL database host url</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>db_port</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The postgreSQL database port number as a string, usually 5432</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>db_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The postgreSQL database name</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>None</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="p">,</span> 
        <span class="n">gspread_auth_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">db_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">db_port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">log_name</span><span class="o">=</span><span class="s1">&#39;utility_functions&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialise a google sheets connector and postgreSQL connector for the utility instance </span>

<span class="sd">    This means you can only connect to one google account and one database per instance </span>
<span class="sd">    of the UtilityFunctions class.</span>

<span class="sd">    The email address of the google account must be added to the google sheet as a collaborator</span>

<span class="sd">    Args:</span>
<span class="sd">        client_name (str): Used to specify the folder, </span>
<span class="sd">        gspread_auth_dict (dict): A dictionary containing google authorisation data</span>
<span class="sd">        db_user (str): The postgreSQL database username</span>
<span class="sd">        db_password (str): The postgreSQL database password</span>
<span class="sd">        db_host (str): The postgreSQL database host url</span>
<span class="sd">        db_port (str): The postgreSQL database port number as a string, usually 5432</span>
<span class="sd">        db_name (str): The postgreSQL database name</span>
<span class="sd">    Returns:</span>
<span class="sd">        None&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gspread_auth_dict</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sa</span> <span class="o">=</span> <span class="n">gspread</span><span class="o">.</span><span class="n">service_account_from_dict</span><span class="p">(</span><span class="n">gspread_auth_dict</span><span class="p">)</span>         
    <span class="k">if</span> <span class="n">db_user</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_password</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_name</span> <span class="o">=</span> \
        <span class="n">db_user</span><span class="p">,</span> <span class="n">db_password</span><span class="p">,</span> <span class="n">db_host</span><span class="p">,</span> <span class="n">db_port</span><span class="p">,</span> <span class="n">db_name</span>
        <span class="n">postgres_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;postgresql://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_user</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_password</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_host</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_port</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_engine</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">postgres_str</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span> <span class="o">=</span> <span class="n">client_name</span>
    <span class="c1"># Initialise a logger for the utility functions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">client_name</span><span class="p">,</span> <span class="n">log_name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.best_fuzzy_match" class="doc doc-heading">
<code class="highlight language-python"><span class="n">best_fuzzy_match</span><span class="p">(</span><span class="n">list_1</span><span class="p">,</span> <span class="n">list_2</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">json_name</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Takes in two lists of strings and every string in list_1 is fuzzy matched onto every item in list_2
The fuzzy match of a string in list_1 with a string in list_2 with the highest score will count as the 
match as long as it is above the threshold. The match is then stored as a key value pair in a dictionary</p>
<p>The dictionary of matches will be saved as a pickle file to be used next time the function is run to save
having to do searches on a string if we've already found a match in the past</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>list_1</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>First List of strings, every item will be searched for a fuzzy match in list_2</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>list_2</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>Second List of strings, every item in list_1 will be fuzzy matched with every item in list 2 and best fuzzy match score wins</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>threshold</code></td>
          <td>
                <code>integer</code>
          </td>
          <td><p>value between 0 and 100 signifying percentage fuzzy match score at which a match is considered sufficiently close</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>json_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of json file to store dictionary of matches in</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>best_match_dict</code></td>          <td>
                <code>dict</code>
          </td>
          <td><p>Dictionary of matches (with highest fuzzy match score) between strings in list_1 and list_2 
    key = string in list_1, value = string in list_2</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">best_fuzzy_match</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">list_1</span><span class="p">,</span> 
        <span class="n">list_2</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> 
        <span class="n">json_name</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes in two lists of strings and every string in list_1 is fuzzy matched onto every item in list_2</span>
<span class="sd">    The fuzzy match of a string in list_1 with a string in list_2 with the highest score will count as the </span>
<span class="sd">    match as long as it is above the threshold. The match is then stored as a key value pair in a dictionary</span>

<span class="sd">    The dictionary of matches will be saved as a pickle file to be used next time the function is run to save</span>
<span class="sd">    having to do searches on a string if we&#39;ve already found a match in the past</span>

<span class="sd">    Args:</span>
<span class="sd">        list_1 (list): First List of strings, every item will be searched for a fuzzy match in list_2</span>
<span class="sd">        list_2 (list): Second List of strings, every item in list_1 will be fuzzy matched with every item in list 2 and best fuzzy match score wins</span>
<span class="sd">        threshold (integer): value between 0 and 100 signifying percentage fuzzy match score at which a match is considered sufficiently close</span>
<span class="sd">        json_name (str): Name of json file to store dictionary of matches in</span>

<span class="sd">    Returns:</span>
<span class="sd">        best_match_dict (dict): Dictionary of matches (with highest fuzzy match score) between strings in list_1 and list_2 </span>
<span class="sd">                key = string in list_1, value = string in list_2 &quot;&quot;&quot;</span>

    <span class="n">best_match_dict</span> <span class="o">=</span> <span class="p">{}</span> 
    <span class="n">stored_best_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">base_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LOG_DIR&#39;</span><span class="p">)</span>
    <span class="c1"># Create a client specific log directory</span>
    <span class="n">client_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_log_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="p">)</span>
    <span class="n">json_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">client_log_dir</span><span class="p">,</span> <span class="s1">&#39;JSON Files&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">json_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">json_folder</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">json_name</span> <span class="o">!=</span> <span class="s1">&#39;NoStore&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">json_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;best_match_dict_</span><span class="si">{</span><span class="n">json_name</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">)):</span>
            <span class="n">stored_best_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;best_match_dict_</span><span class="si">{</span><span class="n">json_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;Dictionary&#39;</span><span class="p">,</span> <span class="n">json_folder</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loaded dict of len :</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stored_best_dict</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">string_1</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">list_1</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">string_1</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">best_match_dict</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
            <span class="k">continue</span>
        <span class="c1"># If there is an exact match then just put the match as itself and no need to go through list</span>
        <span class="k">if</span> <span class="n">string_1</span> <span class="ow">in</span> <span class="n">list_2</span><span class="p">:</span>  
            <span class="n">best_match_dict</span><span class="p">[</span><span class="n">string_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_1</span>
            <span class="k">continue</span>

        <span class="c1">#If there is a match in the stored dictionary then use that</span>
        <span class="k">if</span> <span class="n">string_1</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">stored_best_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> 
            <span class="n">best_match_dict</span><span class="p">[</span><span class="n">string_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stored_best_dict</span><span class="p">[</span><span class="n">string_1</span><span class="p">]</span>
            <span class="k">continue</span>

        <span class="c1">#Then go through every string in the second list and fuzzy match to produce a score</span>
        <span class="c1">#If the score is below the threshold then set the score to 0</span>
        <span class="n">temp_match_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">string_2</span> <span class="ow">in</span> <span class="n">list_2</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">string_1</span><span class="p">,</span> <span class="n">string_2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">temp_match_dict</span><span class="p">[</span><span class="n">string_2</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

        <span class="c1">#if there were no matches above the threshold then return a match for that </span>
        <span class="c1">#string in list_1 equal to &quot;none&quot;</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">temp_match_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">best_match_dict</span><span class="p">[</span><span class="n">string_1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># find the match with the highest matching score and save that to the</span>
            <span class="c1"># best match dictionary</span>
            <span class="n">best_match</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">temp_match_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">best_match_dict</span><span class="p">[</span><span class="n">string_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_match</span>

    <span class="k">if</span> <span class="n">json_name</span> <span class="o">!=</span> <span class="s1">&#39;NoStore&#39;</span><span class="p">:</span>
        <span class="c1"># Remove matches that didn&#39;t find anythign as that will let new values be discovered</span>
        <span class="c1"># if new data comes in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">best_match_dict</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;best_match_dict_</span><span class="si">{</span><span class="n">json_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;Dictionary&#39;</span><span class="p">,</span> <span class="n">json_folder</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">best_match_dict</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.columnnames_to_lowercase" class="doc doc-heading">
<code class="highlight language-python"><span class="n">columnnames_to_lowercase</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Change the columns in a dataframe into lowercase with spaces replaced by underscores</p>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">columnnames_to_lowercase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Change the columns in a dataframe into lowercase with spaces replaced by underscores&quot;&quot;&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.convert_cumulative_to_daily" class="doc doc-heading">
<code class="highlight language-python"><span class="n">convert_cumulative_to_daily</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">metric_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unique_identifier_cols</span><span class="o">=</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="n">date_row_added_col</span><span class="o">=</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Convert cumulative metrics to daily metrics for a given dataframe.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code>DataFrame</code>
          </td>
          <td><p>The dataframe to convert the cumulative metrics to daily metrics</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>metric_list</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>The list of metrics to convert. Defaults to ['impressions','comments','clicks',
                    'link_clicks','likes','saved','shares','video_views'].</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>unique_identifier_cols</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>The list of columns that uniquely identify a post. Defaults to 'url'.</p></td>
          <td>
                <code>&#39;url&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>date_row_added_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the column that contains the date the row was added to the dataframe. Defaults to 'date_row_added'.</p></td>
          <td>
                <code>&#39;date_row_added&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>df</code></td>          <td>
                <code>DataFrame</code>
          </td>
          <td><p>The dataframe with the cumulative metrics converted to daily metrics</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">convert_cumulative_to_daily</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> 
        <span class="n">metric_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unique_identifier_cols</span><span class="o">=</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> 
        <span class="n">date_row_added_col</span><span class="o">=</span><span class="s1">&#39;date_row_added&#39;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert cumulative metrics to daily metrics for a given dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (DataFrame): The dataframe to convert the cumulative metrics to daily metrics</span>
<span class="sd">        metric_list (list, optional): The list of metrics to convert. Defaults to [&#39;impressions&#39;,&#39;comments&#39;,&#39;clicks&#39;,</span>
<span class="sd">                                &#39;link_clicks&#39;,&#39;likes&#39;,&#39;saved&#39;,&#39;shares&#39;,&#39;video_views&#39;].</span>
<span class="sd">        unique_identifier_cols (list, optional): The list of columns that uniquely identify a post. Defaults to &#39;url&#39;.</span>
<span class="sd">        date_row_added_col (str, optional): The name of the column that contains the date the row was added to the dataframe. Defaults to &#39;date_row_added&#39;.</span>
<span class="sd">    Returns:</span>
<span class="sd">        df (DataFrame): The dataframe with the cumulative metrics converted to daily metrics&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">metric_list</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metric_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;impressions&#39;</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;clicks&#39;</span><span class="p">,</span>
            <span class="s1">&#39;link_clicks&#39;</span><span class="p">,</span> <span class="s1">&#39;likes&#39;</span><span class="p">,</span> <span class="s1">&#39;saved&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;shares&#39;</span><span class="p">,</span> <span class="s1">&#39;video_views&#39;</span>
        <span class="p">]</span>
    <span class="c1">#rename the metric list to create by appending &#39;cum_&#39; to the start of each metric</span>
    <span class="n">cum_metric_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cum_&#39;</span> <span class="o">+</span> <span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metric_list</span><span class="p">]</span>
    <span class="c1">#Check if the cumulative metrics have been calculated before</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="s1">&#39;cum_&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]):</span>
        <span class="n">conversion_run_before</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">previous_cum_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;cum_&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">previous_cum_metrics</span> <span class="o">!=</span> <span class="n">cum_metric_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The cumulative metrics in the dataframe do not match the cumulative metrics in the metric list</span><span class="se">\</span>
<span class="s2">                             input parameter&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conversion_run_before</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">conversion_run_before</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># If the cumulative metrics have not been calculated before then </span>
        <span class="c1"># Duplicate the metrics from the dataframe as by default the metrics are cumulative</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metric_list</span><span class="p">:</span>
            <span class="c1">#set the cumulative metrics to the same value as the daily metrics</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cum_&#39;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
            <span class="n">cum_metric_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cum_&#39;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unique_identifier_cols</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># If the entry is a string just convert it to a list</span>
        <span class="n">unique_identifier_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">unique_identifier_cols</span><span class="p">]</span>
    <span class="c1"># Sort the dataframe by the unique identifier columns and the date the row was added</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">unique_identifier_cols</span><span class="o">+</span><span class="p">[</span><span class="n">date_row_added_col</span><span class="p">])</span>
    <span class="c1"># Calculate the daily metrics by subtracting the previous day&#39;s cumulative metric from the current day&#39;s cumulative metric</span>
    <span class="n">metrics_updated</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">unique_identifier_cols</span><span class="p">)[</span><span class="n">cum_metric_list</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="n">metric_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_updated</span>
    <span class="n">df_metrics</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">metric_list</span><span class="p">]</span>
    <span class="c1"># Set negative values to zero, cumulative totals can decrease, potentially due to people accidently liking posts</span>
    <span class="n">df_metrics</span><span class="p">[</span><span class="n">df_metrics</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="n">metric_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_metrics</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.dupes_some_cols_but_differ_in_others" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dupes_some_cols_but_differ_in_others</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">subset_cols</span><span class="p">,</span> <span class="n">diff_cols</span><span class="p">,</span> <span class="n">return_mode</span><span class="o">=</span><span class="s1">&#39;only_differing_duplicates&#39;</span><span class="p">,</span> <span class="n">max_value_keep_col</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Identifies rows that are duplicates in some columns but differ in others.</p>
<p>This is useful in some cases when you want to find specific types of duplicates
caused by specific types of errors. For example social media posts that have the
same URL but differ in the number of impressions.</p>
<p>For the "only_differing_duplicates" return_mode, the function will return the rows that are duplicates in the 
subset_cols but differ in the diff_cols.</p>
<p>For the "max_value" return_mode, the function will return the original and keep only the row with the max 
value in the max_value_keep_col</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code>DataFrame</code>
          </td>
          <td><p>The dataframe to identify the rows in</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>subset_cols</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>The columns to check for duplicates in</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>diff_cols</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>The columns to check for differences in</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>return_mode</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The mode to return the duplicates in. Options are 'only_differing_duplicates' 
or 'max_value'. Defaults to 'only_differing_duplicates'</p></td>
          <td>
                <code>&#39;only_differing_duplicates&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>max_value_keep_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The column to use to determine which row to use to find the max value of and therefore keep
the row item with the highest value when return_mode is 'max_value'. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>df_dupes</code></td>          <td>
                <code>DataFrame</code>
          </td>
          <td><p>Depending on the return mode, either the rows that are duplicates in the subset_cols but differ in the diff_cols or
the original dataframe with only the row with the max value in the max_value_keep_col</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">dupes_some_cols_but_differ_in_others</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> 
        <span class="n">subset_cols</span><span class="p">,</span> <span class="n">diff_cols</span><span class="p">,</span>
        <span class="n">return_mode</span><span class="o">=</span><span class="s1">&#39;only_differing_duplicates&#39;</span><span class="p">,</span> 
        <span class="n">max_value_keep_col</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identifies rows that are duplicates in some columns but differ in others.</span>

<span class="sd">    This is useful in some cases when you want to find specific types of duplicates</span>
<span class="sd">    caused by specific types of errors. For example social media posts that have the</span>
<span class="sd">    same URL but differ in the number of impressions.</span>

<span class="sd">    For the &quot;only_differing_duplicates&quot; return_mode, the function will return the rows that are duplicates in the </span>
<span class="sd">    subset_cols but differ in the diff_cols.</span>

<span class="sd">    For the &quot;max_value&quot; return_mode, the function will return the original and keep only the row with the max </span>
<span class="sd">    value in the max_value_keep_col</span>


<span class="sd">    Args:</span>
<span class="sd">        df (DataFrame): The dataframe to identify the rows in</span>
<span class="sd">        subset_cols (list): The columns to check for duplicates in</span>
<span class="sd">        diff_cols (list): The columns to check for differences in</span>
<span class="sd">        return_mode (str, optional): The mode to return the duplicates in. Options are &#39;only_differing_duplicates&#39; </span>
<span class="sd">            or &#39;max_value&#39;. Defaults to &#39;only_differing_duplicates&#39;</span>
<span class="sd">        max_value_keep_col (str, optional): The column to use to determine which row to use to find the max value of and therefore keep</span>
<span class="sd">            the row item with the highest value when return_mode is &#39;max_value&#39;. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        df_dupes (DataFrame): Depending on the return mode, either the rows that are duplicates in the subset_cols but differ in the diff_cols or</span>
<span class="sd">            the original dataframe with only the row with the max value in the max_value_keep_col &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">return_mode</span> <span class="o">==</span> <span class="s1">&#39;only_differing_duplicates&#39;</span><span class="p">:</span>
    <span class="c1"># Find rows that are duplicated based on subset_columns</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">subset_cols</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>

        <span class="c1"># Filter rows where any of the diff_columns have more than one unique value within each group</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">duplicates</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">subset_cols</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">diff_cols</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">elif</span> <span class="n">return_mode</span> <span class="o">==</span> <span class="s1">&#39;max_value&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">max_value_keep_col</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_value_keep_col must be provided when return_mode is &#39;max_value&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Sort the dataframe by max_value_keep_col in descending order</span>
        <span class="n">df_sorted</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">max_value_keep_col</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Drop duplicates based on subset_columns and keep the first occurrence (which has the max value due to sorting)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">df_sorted</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">subset_cols</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid return_mode. Choose either &#39;only_differing_duplicates&#39; or &#39;max_value&#39;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.get_active_git_branch" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_active_git_branch</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Get the name of the currently active Git branch.</p>

  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>RuntimeError</code>
          </td>
          <td><p>If the active Git branch cannot be found or there's any other error.</p></td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>str</code></td>          <td>
          </td>
          <td><p>The name of the active Git branch.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_active_git_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the name of the currently active Git branch.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If the active Git branch cannot be found or there&#39;s any other error.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The name of the active Git branch.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use &#39;git&#39; command to get the symbolic reference for the HEAD (current branch)</span>
        <span class="c1"># The command is: git symbolic-ref --short HEAD</span>
        <span class="n">git_branch</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;symbolic-ref&quot;</span><span class="p">,</span> <span class="s2">&quot;--short&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">],</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
            <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">git_branch</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No active Git branch found.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">git_branch</span>

    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Catch the error from the subprocess call</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while trying to get active Git branch: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Catch any other exceptions</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.identify_match_multi_cols" class="doc doc-heading">
<code class="highlight language-python"><span class="n">identify_match_multi_cols</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">df_1_cols_to_match</span><span class="p">,</span> <span class="n">df_2_cols_to_match</span><span class="p">,</span> <span class="n">match_col_name</span><span class="p">,</span> <span class="n">exclude_values</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function will identify if a row in df_1 is in df_2 based on the columns specified in df_1_cols_to_match and df_2_cols_to_match</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df_1</code></td>
          <td>
                <code><span title="pandas">pd</span>.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>The first dataframe to identify matches in</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>df_2</code></td>
          <td>
                <code><span title="pandas">pd</span>.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>The second dataframe to identify matches in</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>df_1_cols_to_match</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>The columns in df_1 to look for matches in df_2</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>df_2_cols_to_match</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>The columns in df_2 to look for matches in df_1</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>match_col_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the column to be created in df_1 to indicate if the row is in df_2</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>exclude_values</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>The values to be excluded from the match. Default is ['None', 'none', 'nan', '']</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">identify_match_multi_cols</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df_1</span><span class="p">,</span> 
        <span class="n">df_2</span><span class="p">,</span> <span class="n">df_1_cols_to_match</span><span class="p">,</span> 
        <span class="n">df_2_cols_to_match</span><span class="p">,</span> <span class="n">match_col_name</span><span class="p">,</span> 
        <span class="n">exclude_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function will identify if a row in df_1 is in df_2 based on the columns specified in df_1_cols_to_match and df_2_cols_to_match</span>

<span class="sd">    Args:</span>
<span class="sd">        df_1 (pd.DataFrame): The first dataframe to identify matches in</span>
<span class="sd">        df_2 (pd.DataFrame): The second dataframe to identify matches in</span>
<span class="sd">        df_1_cols_to_match (list): The columns in df_1 to look for matches in df_2</span>
<span class="sd">        df_2_cols_to_match (list): The columns in df_2 to look for matches in df_1</span>
<span class="sd">        match_col_name (str): The name of the column to be created in df_1 to indicate if the row is in df_2</span>
<span class="sd">        exclude_values (list): The values to be excluded from the match. Default is [&#39;None&#39;, &#39;none&#39;, &#39;nan&#39;, &#39;&#39;]&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">exclude_values</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exclude_values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">is_row_in_dataframe</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">target_df</span><span class="p">,</span> <span class="n">source_cols</span><span class="p">,</span> <span class="n">target_cols</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_df</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_cols</span><span class="p">)):</span>
            <span class="n">current_condition</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">target_df</span><span class="p">[</span><span class="n">target_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="n">source_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">source_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_values</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">target_df</span><span class="p">[</span><span class="n">target_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">source_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">current_condition</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">target_df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="n">df_1</span><span class="p">[</span><span class="n">match_col_name</span> <span class="o">+</span> <span class="s1">&#39;_df1?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">is_row_in_dataframe</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">df_1_cols_to_match</span><span class="p">,</span> <span class="n">df_2_cols_to_match</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df_2</span><span class="p">[</span><span class="n">match_col_name</span> <span class="o">+</span> <span class="s1">&#39;_df2?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">is_row_in_dataframe</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">df_1</span><span class="p">,</span> <span class="n">df_2_cols_to_match</span><span class="p">,</span> <span class="n">df_1_cols_to_match</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.identify_paid_or_organic" class="doc doc-heading">
<code class="highlight language-python"><span class="n">identify_paid_or_organic</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Identify whether a given dataframe contains paid data</p>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">identify_paid_or_organic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify whether a given dataframe contains paid data&quot;&quot;&quot;</span>
    <span class="n">paid_or_organic</span> <span class="o">=</span> <span class="s1">&#39;Organic&#39;</span>
    <span class="c1"># Make columns to check lower case so can work on</span>
    <span class="c1"># Columns that have or haven&#39;t been cleaned</span>
    <span class="n">col_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="c1"># Check to see whether &quot;spend&quot; or &quot;spend_usd&quot; is in the column list</span>
    <span class="k">if</span> <span class="s1">&#39;spend&#39;</span> <span class="ow">in</span> <span class="n">col_list</span> <span class="ow">or</span> <span class="s1">&#39;spend_usd&#39;</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">:</span>
        <span class="n">paid_or_organic</span> <span class="o">=</span> <span class="s1">&#39;Paid&#39;</span>    
    <span class="k">return</span> <span class="n">paid_or_organic</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.match_ads" class="doc doc-heading">
<code class="highlight language-python"><span class="n">match_ads</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">df_1_exact_col</span><span class="p">,</span> <span class="n">df_2_exact_col</span><span class="p">,</span> <span class="n">extract_shortcode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">df_1_fuzzy_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">df_2_fuzzy_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_exact_col_link</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">matched_col_name</span><span class="o">=</span><span class="s1">&#39;boosted&#39;</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cols_to_merge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pickle_name</span><span class="o">=</span><span class="s1">&#39;NoStore&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Match row items in df_2 onto row items in df_1 based on two sets of columns,using exact and fuzzy matching.</p>
<p>First try to match the row items in df_1 using the first set of columns, if there is no match then try to match
the row items in df_2 using the second set of columns and fuzzy matching.
For example the first set of columns might be URLs, which tend to be exact matches, and the second set of columns
might be post copy, which can have slight variations, for example the post copy from a tracker sheet might be
slightly incorrect due to manual entry, therefore fuzzy matching with a threshold of how similar the strings
need to be is used.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df_1</code></td>
          <td>
                <code>DataFrame</code>
          </td>
          <td><p>The Dataframe that will be searched to see if any corresponding values in df_2, if merge=True df_2 will be left joined onto df_1</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>df_2</code></td>
          <td>
                <code>DataFrame</code>
          </td>
          <td><p>The Dataframe that if merge = True will be left joined onto df_1</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>df_1_exact_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The Column name from df_1 that will be first attempted to find exact matches</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>df_2_exact_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The Column name from df_2 that will be first attempted to find exact matches</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>extract_shortcode</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Boolean Flag, if True then the exact match will be attempted on the shortcodes of the df_2_exact_col which should be a url</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>df_1_fuzzy_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The Column name from df_1 that will be attempted to fuzzy match if there was no exact match before.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>df_2_fuzzy_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The Column name from df_2 that will be attempted to fuzzy match if there was no exact match before.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>is_exact_col_link</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Boolean Flag, is the set of columns to be exact matched hyperlinks? If so they will be cleaned to remove utm parameters.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>matched_col_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>String to name the column which will contain boolean values to indicate whether row items in df_1 found a match in df_2.</p></td>
          <td>
                <code>&#39;boosted&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>merge</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Boolean Flag, if true then df_2 will be left joined onto df_1. Else df_1 will be left unchanged apart from column indicating whether there is a match.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>cols_to_merge</code></td>
          <td>
                <code>list, str</code>
          </td>
          <td><p>List of strings to merge on if 'merge' = True.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>pickle_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the dictionary of best matches found by fuzzy matching to be stored as a pickle file. The next time the function is run with the same pickle_name, the pickle file is used to find matches without having to do slow fuzzy matching from scratch.</p></td>
          <td>
                <code>&#39;NoStore&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>df_1</code></td>          <td>
                <code>DataFrame</code>
          </td>
          <td><p>The original df_1 with just a column to indicate whether a match has occured if merge = False else df_1 will have df_2 left joined on.</p></td>
        </tr>
        <tr>
<td><code>df_2</code></td>          <td>
                <code>DataFrame</code>
          </td>
          <td><p>The original df_2 with cleaned columns and 'Match String' column to help quality check why some rows have or haven't matched.</p></td>
        </tr>
        <tr>
<td><code>df_2_no_match</code></td>          <td>
                <code>DataFrame</code>
          </td>
          <td><p>A dataframe of df_2 row items that haven't found a match in df_1.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">match_ads</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df_1</span><span class="p">,</span> 
        <span class="n">df_2</span><span class="p">,</span> <span class="n">df_1_exact_col</span><span class="p">,</span> 
        <span class="n">df_2_exact_col</span><span class="p">,</span> <span class="n">extract_shortcode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">df_1_fuzzy_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">df_2_fuzzy_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">is_exact_col_link</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">matched_col_name</span><span class="o">=</span><span class="s1">&#39;boosted&#39;</span><span class="p">,</span> 
        <span class="n">merge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cols_to_merge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">pickle_name</span><span class="o">=</span><span class="s1">&#39;NoStore&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Match row items in df_2 onto row items in df_1 based on two sets of columns,using exact and fuzzy matching.</span>

<span class="sd">    First try to match the row items in df_1 using the first set of columns, if there is no match then try to match</span>
<span class="sd">    the row items in df_2 using the second set of columns and fuzzy matching.</span>
<span class="sd">    For example the first set of columns might be URLs, which tend to be exact matches, and the second set of columns</span>
<span class="sd">    might be post copy, which can have slight variations, for example the post copy from a tracker sheet might be</span>
<span class="sd">    slightly incorrect due to manual entry, therefore fuzzy matching with a threshold of how similar the strings</span>
<span class="sd">    need to be is used.</span>

<span class="sd">    Args:</span>
<span class="sd">        df_1 (DataFrame): The Dataframe that will be searched to see if any corresponding values in df_2, if merge=True df_2 will be left joined onto df_1</span>
<span class="sd">        df_2 (DataFrame): The Dataframe that if merge = True will be left joined onto df_1</span>
<span class="sd">        df_1_exact_col (str): The Column name from df_1 that will be first attempted to find exact matches</span>
<span class="sd">        df_2_exact_col (str): The Column name from df_2 that will be first attempted to find exact matches</span>
<span class="sd">        extract_shortcode (bool): Boolean Flag, if True then the exact match will be attempted on the shortcodes of the df_2_exact_col which should be a url</span>
<span class="sd">        df_1_fuzzy_col (str): The Column name from df_1 that will be attempted to fuzzy match if there was no exact match before.</span>
<span class="sd">        df_2_fuzzy_col (str): The Column name from df_2 that will be attempted to fuzzy match if there was no exact match before.</span>
<span class="sd">        is_exact_col_link (bool): Boolean Flag, is the set of columns to be exact matched hyperlinks? If so they will be cleaned to remove utm parameters.</span>
<span class="sd">        matched_col_name (str): String to name the column which will contain boolean values to indicate whether row items in df_1 found a match in df_2.</span>
<span class="sd">        merge (bool): Boolean Flag, if true then df_2 will be left joined onto df_1. Else df_1 will be left unchanged apart from column indicating whether there is a match.</span>
<span class="sd">        cols_to_merge (list, str): List of strings to merge on if &#39;merge&#39; = True.</span>
<span class="sd">        pickle_name (str): Name of the dictionary of best matches found by fuzzy matching to be stored as a pickle file. The next time the function is run with the same pickle_name, the pickle file is used to find matches without having to do slow fuzzy matching from scratch.</span>

<span class="sd">    Returns:</span>
<span class="sd">        df_1 (DataFrame): The original df_1 with just a column to indicate whether a match has occured if merge = False else df_1 will have df_2 left joined on.</span>
<span class="sd">        df_2 (DataFrame): The original df_2 with cleaned columns and &#39;Match String&#39; column to help quality check why some rows have or haven&#39;t matched.</span>
<span class="sd">        df_2_no_match (DataFrame): A dataframe of df_2 row items that haven&#39;t found a match in df_1.&quot;&quot;&quot;</span>

    <span class="n">df_1</span> <span class="o">=</span> <span class="n">df_1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_1</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;matched&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;df&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)])</span>
    <span class="n">df_2</span> <span class="o">=</span> <span class="n">df_2</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_2</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;matched&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;df&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)])</span>

    <span class="k">if</span> <span class="n">cols_to_merge</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cols_to_merge</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">df_1_fuzzy_col</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># If only oen set of columns then first do an exact match then a fuzzy match on just that set of columns</span>
        <span class="n">df_1_fuzzy_col</span> <span class="o">=</span> <span class="n">df_1_exact_col</span>
        <span class="n">df_2_fuzzy_col</span> <span class="o">=</span> <span class="n">df_2_exact_col</span>

    <span class="c1"># Prepare strings in a raw form with no spaces or punctuation in order to increase chance of matching</span>
    <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_1</span><span class="p">[</span><span class="n">df_1_exact_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_string_matching</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">is_url</span><span class="o">=</span><span class="n">is_exact_col_link</span><span class="p">))</span>
    <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="n">df_2_exact_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_string_matching</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">is_url</span><span class="o">=</span><span class="n">is_exact_col_link</span><span class="p">))</span>

    <span class="c1"># Find out the number of unique values of the first cleaned column to match by</span>
    <span class="n">df_1_unique_exact</span> <span class="o">=</span> <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">df_2_unique_exact</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">extract_shortcode</span><span class="p">:</span>
        <span class="c1"># Create a dictionary of mappings between urls in df_2 and shortcodes in df_1</span>
        <span class="n">url_shortcode_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_shortcode_to_url</span><span class="p">(</span><span class="n">df_1_unique_exact</span><span class="p">,</span> <span class="n">df_2_unique_exact</span><span class="p">)</span>
        <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">url_shortcode_dict</span><span class="p">)</span>

    <span class="n">cols_to_merge</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;match_string&#39;</span><span class="p">)</span>

    <span class="c1"># Identify matches between the two dataframes on cols_to_merge,e.g. is there a row with &#39;platform&#39; and &#39;message&#39; in df_1 that matches a row in df_2</span>
    <span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_match_multi_cols</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">cols_to_merge</span><span class="p">,</span> <span class="n">cols_to_merge</span><span class="p">,</span> <span class="s1">&#39;matched_exact&#39;</span><span class="p">)</span>

    <span class="n">df_1</span><span class="p">[</span><span class="n">matched_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matched_fuzzy_df1?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Split Dataframes up into rows that had a URL match and one where the rows didn&#39;t match</span>
    <span class="c1"># Then the ones that didn&#39;t match will try and be matched with the cleaned caption</span>
    <span class="n">df_1_match</span> <span class="o">=</span> <span class="n">df_1</span><span class="p">[</span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matched_exact_df1?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>

    <span class="c1"># Exact column merge match</span>
    <span class="c1"># We don&#39;t match on match_id because we don&#39;t want the cols_to_merge to be duplicated with _x and _y</span>
    <span class="k">if</span> <span class="n">merge</span><span class="p">:</span>
        <span class="n">df_1_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_match_perc</span><span class="p">(</span><span class="n">df_1_match</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">cols_to_merge</span><span class="p">,</span> 
                                                <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;First set of columns exact match&quot;</span><span class="p">)</span>

    <span class="c1"># Now the match string will be based off the column to be fuzzy matched    </span>
    <span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_1</span><span class="p">[</span><span class="n">df_1_fuzzy_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_string_matching</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="n">df_2_fuzzy_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_string_matching</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="c1"># now create a dataframe of the rows that didn&#39;t have an exact match and try and fuzzy match them</span>
    <span class="n">df_1_no_match</span> <span class="o">=</span> <span class="n">df_1</span><span class="p">[</span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matched_exact_df1?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>

    <span class="c1"># Find the unique instances of cleaned captions to be passed to the fuzzy matching function</span>
    <span class="n">df_1_no_match_unique</span> <span class="o">=</span> <span class="n">df_1_no_match</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">df_2_fuzzy_unique</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># the fuzzy match function will return a dictionary of matches for each caption from df_1 with the value</span>
    <span class="c1"># being the fuzzy col of df_2 with the best match above a certain percentage threshold similarity</span>
    <span class="n">best_match_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_fuzzy_match</span><span class="p">(</span><span class="n">df_1_no_match_unique</span><span class="p">,</span> <span class="n">df_2_fuzzy_unique</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">pickle_name</span><span class="p">)</span>

    <span class="c1"># create a column that is the closest match in df_2 for every caption in df_1</span>
    <span class="c1"># This will be used to merge df_2 onto the remainder of none matching df_1</span>
    <span class="n">df_1_no_match</span><span class="p">[</span><span class="s1">&#39;match_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_1_no_match</span><span class="p">[</span><span class="s2">&quot;match_string&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">best_match_dict</span><span class="p">)</span>

    <span class="c1"># Identify matches between the two dataframes on cols_to_merge,e.g. is there a row with &#39;platform&#39; and &#39;message&#39; in df_1 that matches a row in df_2</span>
    <span class="n">df_1_no_match</span><span class="p">,</span> <span class="n">df_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_match_multi_cols</span><span class="p">(</span><span class="n">df_1_no_match</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">cols_to_merge</span><span class="p">,</span> <span class="n">cols_to_merge</span><span class="p">,</span> <span class="s1">&#39;matched_fuzzy&#39;</span><span class="p">)</span>

    <span class="c1"># Fuzzy match merge the rows that didn&#39;t match on the exact column</span>
    <span class="k">if</span> <span class="n">merge</span><span class="p">:</span>
        <span class="n">df_1_no_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_match_perc</span><span class="p">(</span><span class="n">df_1_no_match</span><span class="p">,</span> <span class="n">df_2</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">df_2_fuzzy_col</span><span class="p">,</span> <span class="s1">&#39;matched_exact_df2?&#39;</span><span class="p">,</span> <span class="s1">&#39;matched_fuzzy_df2?&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                    <span class="n">on</span><span class="o">=</span><span class="n">cols_to_merge</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;Second set of columns fuzzy match&quot;</span><span class="p">)</span>

    <span class="n">df_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_1_match</span><span class="p">,</span> <span class="n">df_1_no_match</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># The matched_col_name indicates whether a match either exact or fuzzy was found</span>
    <span class="n">df_1</span><span class="p">[</span><span class="n">matched_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;matched_exact_df1?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;matched_fuzzy_df1?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">))</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df_2</span><span class="p">[</span><span class="n">matched_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;matched_exact_df2?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;matched_fuzzy_df2?&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">))</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Num unique exact col values in df_1 = </span><span class="si">{</span><span class="n">df_1</span><span class="p">[</span><span class="n">df_1_exact_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Num unique fuzzy col values in df_1 = </span><span class="si">{</span><span class="n">df_1</span><span class="p">[</span><span class="n">df_1_fuzzy_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Num unique exact col values in df_2 = </span><span class="si">{</span><span class="n">df_2</span><span class="p">[</span><span class="n">df_2_exact_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Num unique fuzzy col values in df_2 = </span><span class="si">{</span><span class="n">df_2</span><span class="p">[</span><span class="n">df_2_fuzzy_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perc Matched df_1 exact col = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matched_exact_df1?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perc Matched df_1 fuzzy col = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_1</span><span class="p">[</span><span class="s1">&#39;matched_fuzzy_df1?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perc df_2 exact col could have matched = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;matched_exact_df2?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perc df_2 fuzzy col could have matched = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;matched_fuzzy_df2?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perc Matched df_1 matched = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_1</span><span class="p">[</span><span class="n">matched_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Perc Matched df_2 matched = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">df_2</span><span class="p">[</span><span class="n">matched_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.match_shortcode_to_url" class="doc doc-heading">
<code class="highlight language-python"><span class="n">match_shortcode_to_url</span><span class="p">(</span><span class="n">shortcode_list</span><span class="p">,</span> <span class="n">url_list</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Matches a list of shortcodes to a list of urls, creates a dictionary of the matches.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>shortcode_list</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>A list of shortcodes to match to urls.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>url_list</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>A list of urls to match to shortcodes.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>url_shortcode_dict</code></td>          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionary of the matches between shortcodes and urls.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">match_shortcode_to_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shortcode_list</span><span class="p">,</span> <span class="n">url_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matches a list of shortcodes to a list of urls, creates a dictionary of the matches.</span>

<span class="sd">    Args:</span>
<span class="sd">        shortcode_list (list): A list of shortcodes to match to urls.</span>
<span class="sd">        url_list (list): A list of urls to match to shortcodes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        url_shortcode_dict (dict): A dictionary of the matches between shortcodes and urls.&quot;&quot;&quot;</span>
    <span class="n">url_shortcode_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">shortcode</span> <span class="ow">in</span> <span class="n">shortcode_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">shortcode</span><span class="p">):</span>
                <span class="k">continue</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">url_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shortcode</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
                <span class="n">url_shortcode_dict</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">shortcode</span>
    <span class="k">return</span> <span class="n">url_shortcode_dict</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.merge_match_perc" class="doc doc-heading">
<code class="highlight language-python"><span class="n">merge_match_perc</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ignore_values_df2</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Merges two dataframes and prints out the number of matches and the percentage of matches out of the total number of rows.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df_1</code></td>
          <td>
                <code><span title="pandas">pd</span>.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>The first dataframe to merge</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>df_2</code></td>
          <td>
                <code><span title="pandas">pd</span>.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>The second dataframe to merge</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>left_on</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The column name to merge on in the first dataframe</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>right_on</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The column name to merge on in the second dataframe</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>how</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The type of merge to perform. Defaults to 'left'.</p></td>
          <td>
                <code>&#39;left&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tag</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>A tag to add to the print statement. Defaults to "".</p></td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>output_df</code></td>          <td>
                <code><span title="pandas">pd</span>.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>A pandas dataframe that contains the merged data from the input dataframes.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">merge_match_perc</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="p">,</span> 
        <span class="n">left_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> 
        <span class="n">ignore_values_df2</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merges two dataframes and prints out the number of matches and the percentage of matches out of the total number of rows.</span>

<span class="sd">    Args:</span>
<span class="sd">        df_1 (pd.DataFrame): The first dataframe to merge</span>
<span class="sd">        df_2 (pd.DataFrame): The second dataframe to merge</span>
<span class="sd">        left_on (str): The column name to merge on in the first dataframe</span>
<span class="sd">        right_on (str): The column name to merge on in the second dataframe</span>
<span class="sd">        how (str, optional): The type of merge to perform. Defaults to &#39;left&#39;.</span>
<span class="sd">        tag (str, optional): A tag to add to the print statement. Defaults to &quot;&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        output_df (pd.DataFrame): A pandas dataframe that contains the merged data from the input dataframes.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">ignore_values_df2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ignore_values_df2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">right_on</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;no_merge_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="n">right_on</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">ignore_values_df2</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">on</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;no_merge_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="n">on</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">ignore_values_df2</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">df_1_rows_before</span> <span class="o">=</span> <span class="n">df_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Number of rows in df_1</span>
    <span class="k">if</span> <span class="s1">&#39;_merge&#39;</span> <span class="ow">in</span> <span class="n">df_1</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="c1"># If df_1 has a _merge column, drop it</span>
        <span class="n">df_1</span> <span class="o">=</span> <span class="n">df_1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_merge&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">output_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span> <span class="n">df_2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;no_merge_flag&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">],</span> <span class="n">left_on</span><span class="o">=</span><span class="n">left_on</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="n">right_on</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">how</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">on</span><span class="p">,</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Drop the flag column in the merged dataframe</span>
    <span class="n">output_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;no_merge_flag&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">df_1_rows_after</span> <span class="o">=</span> <span class="n">output_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#number of rows in output_df after merge</span>

    <span class="c1"># Count the number of matches by using the &quot;_merge&quot; column that is created by &quot;indicator=True&quot;</span>
    <span class="n">num_matches</span> <span class="o">=</span> <span class="n">output_df</span><span class="p">[</span><span class="s1">&#39;_merge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[</span><span class="s1">&#39;both&#39;</span><span class="p">]</span>
    <span class="n">match_perc</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">num_matches</span> <span class="o">/</span> <span class="n">df_1_rows_after</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> df_1 has </span><span class="si">{</span><span class="n">df_1_rows_before</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_matches</span><span class="si">}</span><span class="s1"> matches, how = </span><span class="si">{</span><span class="n">how</span><span class="si">}</span><span class="s1">, out of </span><span class="si">{</span><span class="n">df_1_rows_after</span><span class="si">}</span><span class="s1"> rows (</span><span class="si">{</span><span class="n">match_perc</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rows after minus rows before </span><span class="si">{</span><span class="n">df_1_rows_after</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">df_1_rows_before</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_df</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.pickle_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">pickle_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;Pickled Files&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Pickle data and save it to a file.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>data</code></td>
          <td>
                <code>Object</code>
          </td>
          <td><p>The data to be pickled.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>filename</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the file to save the pickled data to.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>folder</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The folder to save the pickled file to. Defaults to "Pickled Files".</p></td>
          <td>
                <code>&#39;Pickled Files&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pickle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;Pickled Files&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pickle data and save it to a file.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (Object): The data to be pickled.</span>
<span class="sd">        filename (str): The name of the file to save the pickled data to.</span>
<span class="sd">        folder (str, optional): The folder to save the pickled file to. Defaults to &quot;Pickled Files&quot;.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.prepare_string_matching" class="doc doc-heading">
<code class="highlight language-python"><span class="n">prepare_string_matching</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">is_url</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Removing unnecessary detail, whitespaces and converting to lower case.</p>
<p>Prepare strings for matching say in a merge function by removing unnecessary 
    detail, whitespaces and converting to lower case.</p>
<pre><code>Remove URLs and emojis as sometimes they cannot come through properly in Tracer data
Replace non-ASCII characters with their closest ASCII equivalents

Parameters
-----------------
string : str 
    The string to be cleaned
is_url : bool 
    If True then remove URLs and characters after the '?' which are utm parameters
    These can be present in some URLs we receive and not others
Returns 
----------------
string : str
    A cleaned string stripped of whitespace, punctuation, emojis, non-ASCII characters, and URLs.
</code></pre>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">prepare_string_matching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">is_url</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removing unnecessary detail, whitespaces and converting to lower case.</span>

<span class="sd">    Prepare strings for matching say in a merge function by removing unnecessary </span>
<span class="sd">        detail, whitespaces and converting to lower case.</span>

<span class="sd">        Remove URLs and emojis as sometimes they cannot come through properly in Tracer data</span>
<span class="sd">        Replace non-ASCII characters with their closest ASCII equivalents</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------------</span>
<span class="sd">        string : str </span>
<span class="sd">            The string to be cleaned</span>
<span class="sd">        is_url : bool </span>
<span class="sd">            If True then remove URLs and characters after the &#39;?&#39; which are utm parameters</span>
<span class="sd">            These can be present in some URLs we receive and not others</span>
<span class="sd">        Returns </span>
<span class="sd">        ----------------</span>
<span class="sd">        string : str</span>
<span class="sd">            A cleaned string stripped of whitespace, punctuation, emojis, non-ASCII characters, and URLs.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">string</span>
    <span class="n">string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># Convert the input to a string and make it lower case</span>
    <span class="k">if</span> <span class="n">is_url</span><span class="p">:</span>
        <span class="c1"># Remove URLs and characters after the &#39;?&#39;</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Get rid of everything after they start to be utm parameters</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1">#this is commonly for a post message</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">string</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="c1"># add a space to the end of the string so that the regex below works            </span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(https?://\S+)\s&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span> <span class="c1"># Remove URLs up to the first whitespace</span>

    <span class="n">string</span> <span class="o">=</span> <span class="n">emoji_pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span> <span class="c1"># remove emojis</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">unidecode</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>  <span class="c1"># replace non-ASCII characters with their closest ASCII equivalents</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\w\s]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span> <span class="c1"># remove punctuation</span>
    <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.read_from_gsheet" class="doc doc-heading">
<code class="highlight language-python"><span class="n">read_from_gsheet</span><span class="p">(</span><span class="n">workbook_name</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">clean_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> <span class="n">dayfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Read data from a google sheet and return it as a dataframe.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>workbook_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the google sheet workbook.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>sheet_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the sheet to read data from.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>clean_date</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If true, the 'date_col' column will be converted to datetime format. (default: True)</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>date_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the column containing the date values to be cleaned. (default: 'EnterValue')</p></td>
          <td>
                <code>&#39;EnterValue&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>dayfirst</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Whether to interpret the first value in an ambiguous 3-integer date (e.g. 01/05/09) as the day (True) or month (False). (default: 'EnterValue')</p></td>
          <td>
                <code>&#39;EnterValue&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>yearfirst</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Similar to 'dayfirst', but for the year. (default: 'EnterValue')</p></td>
          <td>
                <code>&#39;EnterValue&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>format</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The format of the date values. (default: None)</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>errors</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The behavior when encountering errors in the date format. (default: 'raise')</p></td>
          <td>
                <code>&#39;raise&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>df</code></td>          <td>
                <code>pandas.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>The dataframe containing the data from the google sheets</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">read_from_gsheet</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">workbook_name</span><span class="p">,</span> 
        <span class="n">sheet_name</span><span class="p">,</span> <span class="n">clean_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span>
        <span class="n">dayfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> 
        <span class="n">yearfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> 
        <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read data from a google sheet and return it as a dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        workbook_name (str): The name of the google sheet workbook.</span>
<span class="sd">        sheet_name (str): The name of the sheet to read data from.</span>
<span class="sd">        clean_date (bool): If true, the &#39;date_col&#39; column will be converted to datetime format. (default: True)</span>
<span class="sd">        date_col (str): The name of the column containing the date values to be cleaned. (default: &#39;EnterValue&#39;)</span>
<span class="sd">        dayfirst (bool): Whether to interpret the first value in an ambiguous 3-integer date (e.g. 01/05/09) as the day (True) or month (False). (default: &#39;EnterValue&#39;)</span>
<span class="sd">        yearfirst (bool): Similar to &#39;dayfirst&#39;, but for the year. (default: &#39;EnterValue&#39;)</span>
<span class="sd">        format (str): The format of the date values. (default: None)</span>
<span class="sd">        errors (str): The behavior when encountering errors in the date format. (default: &#39;raise&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        df (pandas.DataFrame): The dataframe containing the data from the google sheets&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">spreadsheet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sa</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">workbook_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error_message</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">spreadsheet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sa</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">workbook_name</span><span class="p">)</span>
    <span class="n">worksheet</span> <span class="o">=</span> <span class="n">spreadsheet</span><span class="o">.</span><span class="n">worksheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">worksheet</span><span class="o">.</span><span class="n">get_all_records</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">clean_date</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">,</span>
                                        <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.read_from_postgresql" class="doc doc-heading">
<code class="highlight language-python"><span class="n">read_from_postgresql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">clean_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dayfirst</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Reads a table from a PostgreSQL database table using a pscopg2 connection.
If fails it waits 10 seconds and tries again.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>table_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the table to read from.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>clean_date</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Whether or not to clean the date column. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>date_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The column name of the date column to clean. </p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>dayfirst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The day first format for date parsing. </p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>yearfirst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The year first format for date parsing.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>format</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The format for date parsing. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>errors</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The behavior for date parsing errors. Defaults to 'raise'.</p></td>
          <td>
                <code>&#39;raise&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>df</code></td>          <td>
                <code>pandas.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>The table data in a pandas dataframe.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">read_from_postgresql</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> 
        <span class="n">clean_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">dayfirst</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads a table from a PostgreSQL database table using a pscopg2 connection.</span>
<span class="sd">    If fails it waits 10 seconds and tries again.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name (str): The name of the table to read from.</span>
<span class="sd">        clean_date (bool, optional): Whether or not to clean the date column. Defaults to True.</span>
<span class="sd">        date_col (str, optional): The column name of the date column to clean. </span>
<span class="sd">        dayfirst (str, optional): The day first format for date parsing. </span>
<span class="sd">        yearfirst (str, optional): The year first format for date parsing.</span>
<span class="sd">        format (str, optional): The format for date parsing. Defaults to None.</span>
<span class="sd">        errors (str, optional): The behavior for date parsing errors. Defaults to &#39;raise&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        df (pandas.DataFrame): The table data in a pandas dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date_param_error_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">clean_date</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">date_col</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">date_param_error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;date_col&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dayfirst</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">date_param_error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;dayfirst&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yearfirst</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">date_param_error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;yearfirst&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_param_error_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The following parameters are required to clean the date column: </span><span class="si">{</span><span class="n">date_param_error_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">min_max_date</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">date_col</span><span class="p">,</span> <span class="n">clean_date</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">clean_date</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">,</span>
                                    <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;- Min Date: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s1">, Max Date: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># Connect to the PostgreSQL database</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_name</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_host</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_port</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_password</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try to read the table</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="n">time_taken</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">time_taken</span><span class="si">}</span><span class="s2">secs</span><span class="si">{</span><span class="n">min_max_date</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">date_col</span><span class="p">,</span><span class="w"> </span><span class="n">clean_date</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error_message</span><span class="p">:</span>
        <span class="c1"># If reading the table fails, log the error and wait 10 seconds before trying again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> error: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="n">time_taken</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time taken to read </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">time_taken</span><span class="si">}</span><span class="s2">secs</span><span class="si">{</span><span class="n">min_max_date</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">date_col</span><span class="p">,</span><span class="w"> </span><span class="n">clean_date</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Close the database connection</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.read_json" class="doc doc-heading">
<code class="highlight language-python"><span class="n">read_json</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;JSON Files&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Read a json file and return a Python object.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the json file to be read.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>file_type</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The type of the object. It must be 'DataFrame', 'List' or 'Dictionary'</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>Object</code></td>          <td>
          </td>
          <td><p>The object read from json file.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">read_json</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> 
        <span class="n">file_type</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;JSON Files&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a json file and return a Python object.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_name (str): The name of the json file to be read.</span>
<span class="sd">        file_type (str): The type of the object. It must be &#39;DataFrame&#39;, &#39;List&#39; or &#39;Dictionary&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        Object: The object read from json file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;List&#39;</span> <span class="ow">or</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;Dictionary&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;append&#39;</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">infile</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;JSON read error, file_type error&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.store_daily_organic_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">store_daily_organic_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">output_table_name</span><span class="p">,</span> <span class="n">num_days_to_store</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">date_col_name</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dayfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">,</span> <span class="n">check_created_col</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">created_col</span><span class="o">=</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="n">refresh_lag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cumulative_metric_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unique_id_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">require_run_after_hour</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_after_hour</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Converts a post level organic dataframe to a daily level dataframe and stores it in a PostGreSQL table.</p>
<p>Most organic data is stored at the post level and this function converts it to a daily level dataframe
and stores it in a PostGreSQL table. It also converts the cumulative metrics to daily difference metrics.
The date column is parsed through with the correct format, dayfirst and yearfirst values needing to be specified.
If the table already exists then it checks the date_updated column to see if the data has already been
updated today. If it has then it doesn't update the table. If it hasn't then it updates the table.
If the table doesn't exist then it creates it.
If the require_run_after_hour is set to True then it will only run if the current time is after the
run_after_hour time which is in 24 hour format but only the hour is used.
If check_created_col is set to True then it will only run if the created column is less than the
refresh_lag days ago. This is to ensure that the data is up to date before it is stored. This "created" 
columns appears in databases from tracer and tells us when Tracer last updated the row items. Tracer is 
a day behind hence the refresh_lag of 1 day.
The date_row_added column is added to the dataframe and is the date that the row was added to the
data output_table.
The date_first_tracked column is added to the dataframe and is the date that a unique post as defined
by the unique_id_cols was first tracked
The date_diff column is added to the dataframe and is the number of days difference between when the post
was first tracked and when that particular row item was added to the data output_table.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code>DataFrame</code>
          </td>
          <td><p>The dataframe to be converted to a daily level dataframe and stored in a PostGreSQL table</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_table_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the table to store the data in</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>num_days_to_store</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The number of days worth of data per post to store in the table. Defaults to 30.</p></td>
          <td>
                <code>30</code>
          </td>
        </tr>
        <tr>
          <td><code>date_col_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the date column in the dataframe that will be formatted. Defaults to 'date'.</p></td>
          <td>
                <code>&#39;date&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>dayfirst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Whether the day is the first value in the date column. Defaults to "EnterValue".</p></td>
          <td>
                <code>&#39;EnterValue&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>yearfirst</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Whether the year is the first value in the date column. Defaults to "EnterValue".</p></td>
          <td>
                <code>&#39;EnterValue&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>format</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The format of the date column. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>errors</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>How to handle errors in the date column. Defaults to 'raise'.</p></td>
          <td>
                <code>&#39;raise&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>check_created_col</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Whether to check the created column to ensure the data is up to date. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>created_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the created column. Defaults to 'created'.</p></td>
          <td>
                <code>&#39;created&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>refresh_lag</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The number of days to check the created column is less than. Defaults to 1.</p></td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>cumulative_metric_cols</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>The list of cumulative metrics to convert to daily difference metrics. Defaults to ['impressions','reach','video_views','reactions','comments','shares'].</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>unique_id_cols</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>The list of columns that uniquely identify a post. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>require_run_after_hour</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Whether to only run the function if the current time is after the run_after_hour time. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>run_after_hour</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The hour of the day to run the function after in 24 hour format. Defaults to 15.</p></td>
          <td>
                <code>15</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>None</code></td>          <td>
          </td>
          <td><p>the function writes the data to a postgresql table</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">store_daily_organic_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">output_table_name</span><span class="p">,</span> 
        <span class="n">num_days_to_store</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">date_col_name</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
        <span class="n">dayfirst</span><span class="o">=</span><span class="s2">&quot;EnterValue&quot;</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="s2">&quot;EnterValue&quot;</span><span class="p">,</span> 
        <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">,</span>
        <span class="n">check_created_col</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">created_col</span><span class="o">=</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> 
        <span class="n">refresh_lag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cumulative_metric_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">unique_id_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">require_run_after_hour</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_after_hour</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a post level organic dataframe to a daily level dataframe and stores it in a PostGreSQL table.</span>

<span class="sd">    Most organic data is stored at the post level and this function converts it to a daily level dataframe</span>
<span class="sd">    and stores it in a PostGreSQL table. It also converts the cumulative metrics to daily difference metrics.</span>
<span class="sd">    The date column is parsed through with the correct format, dayfirst and yearfirst values needing to be specified.</span>
<span class="sd">    If the table already exists then it checks the date_updated column to see if the data has already been</span>
<span class="sd">    updated today. If it has then it doesn&#39;t update the table. If it hasn&#39;t then it updates the table.</span>
<span class="sd">    If the table doesn&#39;t exist then it creates it.</span>
<span class="sd">    If the require_run_after_hour is set to True then it will only run if the current time is after the</span>
<span class="sd">    run_after_hour time which is in 24 hour format but only the hour is used.</span>
<span class="sd">    If check_created_col is set to True then it will only run if the created column is less than the</span>
<span class="sd">    refresh_lag days ago. This is to ensure that the data is up to date before it is stored. This &quot;created&quot; </span>
<span class="sd">    columns appears in databases from tracer and tells us when Tracer last updated the row items. Tracer is </span>
<span class="sd">    a day behind hence the refresh_lag of 1 day.</span>
<span class="sd">    The date_row_added column is added to the dataframe and is the date that the row was added to the</span>
<span class="sd">    data output_table.</span>
<span class="sd">    The date_first_tracked column is added to the dataframe and is the date that a unique post as defined</span>
<span class="sd">    by the unique_id_cols was first tracked</span>
<span class="sd">    The date_diff column is added to the dataframe and is the number of days difference between when the post</span>
<span class="sd">    was first tracked and when that particular row item was added to the data output_table.</span>


<span class="sd">    Args:</span>
<span class="sd">        df (DataFrame): The dataframe to be converted to a daily level dataframe and stored in a PostGreSQL table</span>
<span class="sd">        output_table_name (str): The name of the table to store the data in</span>
<span class="sd">        num_days_to_store (int, optional): The number of days worth of data per post to store in the table. Defaults to 30.</span>
<span class="sd">        date_col_name (str, optional): The name of the date column in the dataframe that will be formatted. Defaults to &#39;date&#39;.</span>
<span class="sd">        dayfirst (str, optional): Whether the day is the first value in the date column. Defaults to &quot;EnterValue&quot;.</span>
<span class="sd">        yearfirst (str, optional): Whether the year is the first value in the date column. Defaults to &quot;EnterValue&quot;.</span>
<span class="sd">        format (str, optional): The format of the date column. Defaults to None.</span>
<span class="sd">        errors (str, optional): How to handle errors in the date column. Defaults to &#39;raise&#39;.</span>
<span class="sd">        check_created_col (bool, optional): Whether to check the created column to ensure the data is up to date. Defaults to True.</span>
<span class="sd">        created_col (str, optional): The name of the created column. Defaults to &#39;created&#39;.</span>
<span class="sd">        refresh_lag (int, optional): The number of days to check the created column is less than. Defaults to 1.</span>
<span class="sd">        cumulative_metric_cols (list, optional): The list of cumulative metrics to convert to daily difference metrics. Defaults to [&#39;impressions&#39;,&#39;reach&#39;,&#39;video_views&#39;,&#39;reactions&#39;,&#39;comments&#39;,&#39;shares&#39;].</span>
<span class="sd">        unique_id_cols (list, optional): The list of columns that uniquely identify a post. Defaults to None.</span>
<span class="sd">        require_run_after_hour (bool, optional): Whether to only run the function if the current time is after the run_after_hour time. Defaults to False.</span>
<span class="sd">        run_after_hour (int, optional): The hour of the day to run the function after in 24 hour format. Defaults to 15.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None: the function writes the data to a postgresql table &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cumulative_metric_cols</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cumulative_metric_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;impressions&#39;</span><span class="p">,</span> <span class="s1">&#39;reach&#39;</span><span class="p">,</span> <span class="s1">&#39;video_views&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;shares&#39;</span>
                                  <span class="p">]</span>
    <span class="n">today_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="n">today_date</span> <span class="o">=</span> <span class="n">today_datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">require_run_after_hour</span> <span class="ow">and</span> <span class="p">(</span><span class="n">today_datetime</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="n">run_after_hour</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Require run after hour is set to True and it is before the run after hour time&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1">#Check Tracer data has actually updated</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">output_table_name</span><span class="p">):</span>
        <span class="n">old_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_from_postgresql</span><span class="p">(</span><span class="n">output_table_name</span><span class="p">,</span> <span class="n">clean_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="n">date_col_name</span><span class="p">,</span>
                                           <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_df</span><span class="p">[</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">today_date</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;It looks data has already pushed to </span><span class="si">{</span><span class="n">output_table_name</span><span class="si">}</span><span class="s2"> today&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">created_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">today_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">refresh_lag</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">check_created_col</span><span class="p">):</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;It looks like the input df has not been updated yesterday. Therefore there is no fresh data to add on.&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
            <span class="n">cutoff_date</span> <span class="o">=</span> <span class="n">today_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">num_days_to_store</span><span class="p">)</span>

            <span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">,</span>
                                    <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">cutoff_date</span><span class="p">)]</span> <span class="c1"># Filter data only after the cutoff date</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">today_datetime</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_first_tracked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">unique_id_cols</span><span class="p">)[</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">old_df</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">cumulative_metric_cols</span><span class="p">:</span> 
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cum_&#39;</span><span class="o">+</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="c1"># Set the cumulative metrics to the same value as the daily metrics</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">output_table_name</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

            <span class="n">daily_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_cumulative_to_daily</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cumulative_metric_cols</span><span class="p">,</span> <span class="n">unique_id_cols</span><span class="p">,</span> <span class="s1">&#39;date_row_added&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">daily_df</span><span class="p">,</span> <span class="n">output_table_name</span> <span class="o">+</span> <span class="s1">&#39;_daily_conv&#39;</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1">#if the table doesn&#39;t exist create it with the whole dataset for the first time</span>
        <span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">,</span>
                                    <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">today_datetime</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_first_tracked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">today_datetime</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">output_table_name</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

        <span class="n">daily_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_cumulative_to_daily</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cumulative_metric_cols</span><span class="p">,</span> <span class="n">unique_id_cols</span><span class="p">,</span> <span class="s1">&#39;date_row_added&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">daily_df</span><span class="p">,</span> <span class="n">output_table_name</span> <span class="o">+</span> <span class="s1">&#39;_daily_conv&#39;</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.table_exists" class="doc doc-heading">
<code class="highlight language-python"><span class="n">table_exists</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Check if a table with the given name exists in the database.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>table_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>name of the table to check for existence.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>bool</code></td>          <td>
          </td>
          <td><p>True if table exists, False otherwise.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">table_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a table with the given name exists in the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name (str): name of the table to check for existence.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if table exists, False otherwise.&quot;&quot;&quot;</span>
    <span class="n">all_table_names</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_engine</span><span class="p">)</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">table_name</span> <span class="ow">in</span> <span class="n">all_table_names</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.unpickle_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">unpickle_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;Pickled Files&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Load pickled data from a file.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>filename</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the file to load the pickled data from.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>folder</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The folder where the pickled file is located. Defaults to "Pickled Files".</p></td>
          <td>
                <code>&#39;Pickled Files&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>Object</code></td>          <td>
          </td>
          <td><p>The unpickled data</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">unpickle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span><span class="s2">&quot;Pickled Files&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load pickled data from a file.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str): The name of the file to load the pickled data from.</span>
<span class="sd">        folder (str, optional): The folder where the pickled file is located. Defaults to &quot;Pickled Files&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Object: The unpickled data&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.write_json" class="doc doc-heading">
<code class="highlight language-python"><span class="n">write_json</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;JSON Files&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Write a Python object to a json file.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>object</code></td>
          <td>
                <code>Object</code>
          </td>
          <td><p>The Python object to be written to a json file.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the json file to be created.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>file_type</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The type of the object. It must be 'DataFrame', 'List' or 'Dictionary'</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>folder</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The folder to save the json file to. Defaults to "JSON Files".</p></td>
          <td>
                <code>&#39;JSON Files&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> 
        <span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> 
        <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;JSON Files&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a Python object to a json file.</span>

<span class="sd">    Args:</span>
<span class="sd">        object (Object): The Python object to be written to a json file.</span>
<span class="sd">        file_name (str): The name of the json file to be created.</span>
<span class="sd">        file_type (str): The type of the object. It must be &#39;DataFrame&#39;, &#39;List&#39; or &#39;Dictionary&#39;</span>
<span class="sd">        folder (str, optional): The folder to save the json file to. Defaults to &quot;JSON Files&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;DataFrame&#39;</span><span class="p">:</span>
        <span class="nb">object</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;split&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;List&#39;</span> <span class="ow">or</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;Dictionary&#39;</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;append&#39;</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;JSON write error, file_type error&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.write_to_gsheet" class="doc doc-heading">
<code class="highlight language-python"><span class="n">write_to_gsheet</span><span class="p">(</span><span class="n">workbook_name</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">sheet_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Write a dataframe to a google sheet</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>workbook_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the google sheet workbook.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>sheet_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the sheet to write data to.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>df</code></td>
          <td>
                <code>pandas.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>The dataframe to be written to the google sheet.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>if_exists</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Determines the behavior when the sheet already exists, options are 'replace' or 'append'. (default='replace')</p></td>
          <td>
                <code>&#39;replace&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>sheet_prefix</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>A prefix to be added to the sheet name. (default='')</p></td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>None</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write_to_gsheet</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">workbook_name</span><span class="p">,</span> 
        <span class="n">sheet_name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> 
        <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">sheet_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a dataframe to a google sheet</span>

<span class="sd">    Args:</span>
<span class="sd">        workbook_name (str): The name of the google sheet workbook.</span>
<span class="sd">        sheet_name (str): The name of the sheet to write data to.</span>
<span class="sd">        df (pandas.DataFrame): The dataframe to be written to the google sheet.</span>
<span class="sd">        if_exists (str, optional): Determines the behavior when the sheet already exists, options are &#39;replace&#39; or &#39;append&#39;. (default=&#39;replace&#39;)</span>
<span class="sd">        sheet_prefix (str, optional): A prefix to be added to the sheet name. (default=&#39;&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        None    &quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">dt_string</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SheetUpdated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_string</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Adding the sheet prefix to the sheet name</span>
        <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">sheet_prefix</span> <span class="o">+</span> <span class="n">sheet_name</span>
        <span class="c1"># Open the worksheet</span>
        <span class="n">sheet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sa</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">workbook_name</span><span class="p">)</span><span class="o">.</span><span class="n">worksheet</span><span class="p">(</span><span class="n">sheet_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">if_exists</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span> 
            <span class="c1"># Clear the sheet if if_exists is set to &#39;replace&#39;</span>
            <span class="n">sheet</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># Write the dataframe to the sheet</span>
        <span class="n">gd</span><span class="o">.</span><span class="n">set_with_dataframe</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
        <span class="n">time_taken</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time Taken to write to google sheet </span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">time_taken</span><span class="si">}</span><span class="s2">secs&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error_message</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">gd</span><span class="o">.</span><span class="n">set_with_dataframe</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.utility_functions.UtilityFunctions.write_to_postgresql" class="doc doc-heading">
<code class="highlight language-python"><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Writes a dataframe to a PostgreSQL database table using a SQLalchemy engine defined elsewhere.
If writing fails it waits 10 seconds then trys again</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code>DataFrame</code>
          </td>
          <td><p>The Dataframe to send to the PostGreSQL table</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>table_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the table to write the dataframe to</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>if_exists</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Either 'replace' or 'append' which describes what to do if a table with that name already exists</p></td>
          <td>
                <code>&#39;replace&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>error_message</code></td>          <td>
                <code>str</code>
          </td>
          <td><p>An error message saying that the connection has failed</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/utility_functions.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write_to_postgresql</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> 
        <span class="n">table_name</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes a dataframe to a PostgreSQL database table using a SQLalchemy engine defined elsewhere.</span>
<span class="sd">    If writing fails it waits 10 seconds then trys again</span>

<span class="sd">    Args:</span>
<span class="sd">        df (DataFrame): The Dataframe to send to the PostGreSQL table</span>
<span class="sd">        table_name (str): The name of the table to write the dataframe to</span>
<span class="sd">        if_exists (str): Either &#39;replace&#39; or &#39;append&#39; which describes what to do if a table with that name already exists</span>

<span class="sd">    Returns:</span>
<span class="sd">        error_message (str): An error message saying that the connection has failed &quot;&quot;&quot;</span>
    <span class="c1"># create a SQL alchemy engine to write the data to the database after cleaning</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">dt_string</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DateWrittenToDB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_string</span>
    <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;index&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_engine</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">)</span>
        <span class="n">time_taken</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time Taken to write </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">time_taken</span><span class="si">}</span><span class="s2">secs&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sent Data to </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># Wait for 10 seconds then try again</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_engine</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">)</span>
            <span class="n">time_taken</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time Taken to write </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">time_taken</span><span class="si">}</span><span class="s2">secs&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error_message</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connection failed again </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s1"> error: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">error_message</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
    
  </body>
</html>