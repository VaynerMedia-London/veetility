
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../CleaningFunctions/">
      
      
        <link rel="next" href="../ViewThroughRate/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>Quality Assessment - Veetility Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#quality-assessments-methods" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Veetility Docs" class="md-header__button md-logo" aria-label="Veetility Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Veetility Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Quality Assessment
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Veetility Docs" class="md-nav__button md-logo" aria-label="Veetility Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Veetility Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../UtilityFunctions/" class="md-nav__link">
        Utility Functions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../CleaningFunctions/" class="md-nav__link">
        Cleaning
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Quality Assessment
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Quality Assessment
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments" class="md-nav__link">
    veetility.quality_assessments.QualityAssessments
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.boosted_function_qa" class="md-nav__link">
    boosted_function_qa()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.check_data_recency" class="md-nav__link">
    check_data_recency()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.check_impressions_no_engagements" class="md-nav__link">
    check_impressions_no_engagements()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.comparison_with_previous_data" class="md-nav__link">
    comparison_with_previous_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.duplicates_qa" class="md-nav__link">
    duplicates_qa()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.naming_convention_checker" class="md-nav__link">
    naming_convention_checker()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.null_values_checker" class="md-nav__link">
    null_values_checker()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../ViewThroughRate/" class="md-nav__link">
        View Through Rate
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../SlackNotifier/" class="md-nav__link">
        Slack Notifier
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../snowflake/" class="md-nav__link">
        Snowflake
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../LinkedIn_API/" class="md-nav__link">
        LinkedIn API
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments" class="md-nav__link">
    veetility.quality_assessments.QualityAssessments
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.boosted_function_qa" class="md-nav__link">
    boosted_function_qa()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.check_data_recency" class="md-nav__link">
    check_data_recency()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.check_impressions_no_engagements" class="md-nav__link">
    check_impressions_no_engagements()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.comparison_with_previous_data" class="md-nav__link">
    comparison_with_previous_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.duplicates_qa" class="md-nav__link">
    duplicates_qa()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.naming_convention_checker" class="md-nav__link">
    naming_convention_checker()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#veetility.quality_assessments.QualityAssessments.null_values_checker" class="md-nav__link">
    null_values_checker()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="quality-assessments-methods">Quality Assessments Methods</h1>


<div class="doc doc-object doc-class">


<a id="veetility.quality_assessments.QualityAssessments"></a>
  <div class="doc doc-contents first">



        <details class="quote">
          <summary>Source code in <code>veetility/quality_assessments.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">QualityAssessments</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">util_object</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">util_object</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">util</span> <span class="o">=</span> <span class="n">util_object</span>

    <span class="k">def</span> <span class="nf">null_values_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">df</span><span class="p">,</span>
                            <span class="n">cols_to_group</span><span class="p">,</span>
                            <span class="n">gsheet_name</span><span class="p">,</span>
                            <span class="n">tab_name</span><span class="p">,</span>
                            <span class="n">cols_to_ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">null_definitions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">output_method</span><span class="o">=</span><span class="s1">&#39;gsheet&#39;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes in a dataframe and columns to groupby and checks how many null values or null equivalents</span>
<span class="sd">        there are in the rest of the columns.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): The Input Dataframe of any type where you want to check for nulls.</span>
<span class="sd">            cols_to_group (list of str): The list of columns to perform a groupby operation with the null </span>
<span class="sd">                                        percentage counts will be a percentage of nulls in these groupbys.</span>
<span class="sd">            cols_to_ignore (list of str): The list of columns to ignore when checking for nulls. Default is None.</span>
<span class="sd">            gsheet_name (str): The name of the google sheet workbook to pass to the google sheet function.</span>
<span class="sd">            tab_name (str): The name of the tab in the google sheet workbook to pass to the google sheet function.</span>
<span class="sd">                                            The google sheet must be setup with this tab already created.</span>
<span class="sd">            null_definitions (list): A list containing elements to be defined as a null value.</span>
<span class="sd">            output_method (str): A string identifying whether the output is to be sent to a Google sheet </span>
<span class="sd">                                        (&#39;gsheet&#39;) or returned as a dataframe (&#39;Dataframe&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            null_count_df (pandas.DataFrame): Dataframe showing the percentage of nulls in each column grouped </span>
<span class="sd">                                           by the &#39;cols_to_group&#39;.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">null_definitions</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">null_definitions</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;None&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cols_to_ignore</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols_to_ignore</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">null</span> <span class="ow">in</span> <span class="n">null_definitions</span><span class="p">:</span> 
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="s1">&#39;NullValue&#39;</span><span class="p">)</span>

        <span class="n">null_count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">cols_to_group</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">other_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols_to_group</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols_to_ignore</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">other_cols</span><span class="p">:</span>
            <span class="n">col_groupby</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cols_to_group</span><span class="p">)[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;NullValue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">/</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">null_count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">null_count_df</span><span class="p">,</span> <span class="n">col_groupby</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output_method</span> <span class="o">==</span> <span class="s1">&#39;gsheet&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_gsheet</span><span class="p">(</span><span class="n">gsheet_name</span><span class="p">,</span> <span class="n">tab_name</span><span class="p">,</span> <span class="n">null_count_df</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output_method</span> <span class="o">==</span> <span class="s1">&#39;Dataframe&#39;</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">null_count_df</span>

    <span class="k">def</span> <span class="nf">check_data_recency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                           <span class="n">df</span><span class="p">,</span> 
                           <span class="n">cols_to_group</span><span class="p">,</span>
                           <span class="n">gsheet_name</span><span class="p">,</span> 
                           <span class="n">tab_name</span><span class="o">=</span><span class="s1">&#39;DataRecency&#39;</span><span class="p">,</span>
                           <span class="n">three_days_for_monday</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                           <span class="n">dayfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> 
                           <span class="n">yearfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> 
                           <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                           <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Post a google sheet showing how many days since different channels have been active.</span>
<span class="sd">        Also return a list of channels that have been inactive for more than 2 days which</span>
<span class="sd">        might be indicative of an error</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): Dataframe of data containing a &#39;date&#39; column</span>
<span class="sd">            cols_to_group (list or str): Columns to groupby effectively creating the &#39;channels&#39;</span>
<span class="sd">            gsheet_name (str): Name of the google sheet to write to</span>
<span class="sd">            tab_name (str): Name of the tab in the Google sheet</span>
<span class="sd">            three_days_for_monday (bool): If the check is run on a Monday, give 3 days before declaring a channel as inactive because of the weekend.</span>
<span class="sd">            date_col (str): Column name for the date to find the maximum value for based on grouping by `cols_to_group`. If &#39;created&#39; is used when working with Tracer data, then this will find out when the data was last updated by Tracer, regardless of whether the actual date of the post was 30 days ago.</span>
<span class="sd">            dayfirst (bool): If True, parses dates with the day first, eg 10/11/12 is parsed as 2012-11-10. If False, parses dates with the month first, eg 10/11/12 is parsed as 2010-11-12. If None, this is set to True if the day is in the first position in the format string, False otherwise. If dayfirst is set to True, parsing will be faster, but will fail for ambiguous dates, such as 01/02/03.</span>
<span class="sd">            yearfirst (bool): If True parses dates with the year first, eg 10/11/12 is parsed as 2010-11-12. If both dayfirst and yearfirst are True, yearfirst is preceded (same as dateutil). If False, parses dates with the month first, eg 10/11/12 is parsed as 2012-11-10. If None, this defaults to False. Setting yearfirst to True is not recommended, as it can result in ambiguous dates.</span>
<span class="sd">            format (str): Format to use for strptime. If None, the format is inferred from the first non-NaN element of the column. If the format is inferred, it will be used in subsequent parsing, even if the format changes. To specify a format string that will be used in parsing regardless of the inferred format, use pd.to_datetime with format.</span>
<span class="sd">            errors (str): If &#39;raise&#39;, then invalid parsing will raise an exception. If &#39;coerce&#39;, then invalid parsing will be set as NaT. If &#39;ignore&#39;, then invalid parsing will return the input.</span>

<span class="sd">        Returns:</span>
<span class="sd">            error_message (str): String error message describing which channels are recently inactive. This message can then be sent</span>
<span class="sd">                                to a slack function&quot;&quot;&quot;</span>

        <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">organic_or_paid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">identify_paid_or_organic</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">organic_or_paid</span><span class="p">)</span>
        <span class="n">buffer_days_since_active</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="c1">#remove any timezone information from the date_col and check the date is being read in in correct format</span>
        <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span>
                                      <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>

        <span class="n">data_recency</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cols_to_group</span><span class="p">)[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">today</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">date_col</span><span class="p">:</span><span class="s1">&#39;DaysSinceActive&#39;</span><span class="p">})</span>  

        <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_gsheet</span><span class="p">(</span><span class="n">gsheet_name</span><span class="p">,</span> <span class="n">tab_name</span><span class="p">,</span> <span class="n">data_recency</span><span class="p">,</span> <span class="n">sheet_prefix</span><span class="o">=</span><span class="n">organic_or_paid</span><span class="p">)</span>

        <span class="c1">#create a tag string to identify a channel, a concatenation of all the column values specified in &#39;cols_to_group&#39;</span>
        <span class="k">def</span> <span class="nf">concat_cols</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_group</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

        <span class="n">data_recency</span><span class="p">[</span><span class="s1">&#39;Channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_recency</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">concat_cols</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#The option for giving 3 days of buffer for monday is available in case no advertising/posting is done </span>
        <span class="c1">#over the weekend and you don&#39;t want many channels appearing as if they are inactive on Monday morning</span>
        <span class="k">if</span> <span class="n">today</span><span class="o">.</span><span class="n">day_of_week</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">three_days_for_monday</span><span class="p">:</span> 
            <span class="n">buffer_days_since_active</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="n">channels_recently_inactive</span> <span class="o">=</span> <span class="n">data_recency</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DaysSinceActive &gt;</span><span class="si">{</span><span class="n">buffer_days_since_active</span><span class="si">}</span><span class="s1"> and DaysSinceActive &lt;=6&#39;</span><span class="p">)</span>
        <span class="n">channels_recently_inactive_list</span> <span class="o">=</span> <span class="n">channels_recently_inactive</span><span class="p">[</span><span class="s1">&#39;Channel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels_recently_inactive_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">organic_or_paid</span><span class="si">}</span><span class="s1"> Channels Recently that are recently inactive </span><span class="si">{</span><span class="s2">&quot; , &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channels_recently_inactive_list</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="n">error_message</span>

    <span class="k">def</span> <span class="nf">boosted_function_qa</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">paid_df</span><span class="p">,</span> 
            <span class="n">organic_df</span><span class="p">,</span> <span class="n">gsheet_name</span><span class="p">,</span> 
            <span class="n">tab_name</span><span class="o">=</span><span class="s1">&#39;OrganicWithBigImpressions&#39;</span><span class="p">,</span> 
            <span class="n">impressions_threshold</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes in organic data and paid data and reports how many are mislabelled as boosted</span>

<span class="sd">        Args:</span>
<span class="sd">            paid_df (pandas.DataFrame): Daily ad spend, boosted posts identified in the &#39;workstream&#39; column</span>
<span class="sd">            organic_df (pandas.DataFrame): Organic Post performance Data </span>
<span class="sd">            impressions_threshold (pandas.DataFrame): The number of impressions above which it is unlikely the post is purely organic</span>

<span class="sd">        Returns:</span>
<span class="sd">            error_message (str): A string detailing what the error is so that it can be passed to a notification service like slack&quot;&quot;&quot;</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">organic_df</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># count number of unique paid posts wi  th workstream organic minus oranic posts labelled as boosted</span>
        <span class="c1"># number of boosted post from paid naming convention Tags</span>
        <span class="n">paid_boosted_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paid_df</span><span class="p">[</span><span class="n">paid_df</span><span class="p">[</span><span class="s1">&#39;workstream&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;boosted&#39;</span><span class="p">][</span><span class="s1">&#39;post_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c1"># number of posts our boosted matching function has identified as boosted</span>
        <span class="n">organic_boosted_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">organic_df</span><span class="p">[</span><span class="n">organic_df</span><span class="p">[</span><span class="s1">&#39;workstream&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;boosted&#39;</span><span class="p">][</span><span class="s1">&#39;post_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">missing_boosted</span> <span class="o">=</span> <span class="n">paid_boosted_count</span><span class="o">-</span><span class="n">organic_boosted_count</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">missing_boosted</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> \
                <span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="n">missing_boosted</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">missing_boosted</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">paid_boosted_count</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">%) posts mislabelled as Pure Organic</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

        <span class="c1"># A post that is labelled as organic but has impressions over the impressions_threshold may actually be boosted </span>
        <span class="c1"># but hasn&#39;t been identified as such</span>
        <span class="n">misslabelled_og_rows</span> <span class="o">=</span> <span class="n">organic_df</span><span class="p">[(</span><span class="n">organic_df</span><span class="p">[</span><span class="s1">&#39;workstream&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Pure Organic&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
                                        <span class="p">((</span><span class="n">organic_df</span><span class="p">[</span><span class="s1">&#39;impressions&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">impressions_threshold</span><span class="p">)</span> <span class="o">|</span> \
                                        <span class="p">(</span><span class="n">organic_df</span><span class="p">[</span><span class="s1">&#39;video_views&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">impressions_threshold</span><span class="p">))]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">misslabelled_og_rows</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> \
                <span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">misslabelled_og_rows</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s1"> Pure Organic posts with over </span><span class="si">{</span><span class="n">impressions_threshold</span><span class="si">}</span><span class="s1"> impressions or video views</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_gsheet</span><span class="p">(</span><span class="n">gsheet_name</span><span class="p">,</span> <span class="n">tab_name</span><span class="p">,</span> <span class="n">misslabelled_og_rows</span><span class="p">)</span>
        <span class="c1"># return TT or IG values with empty message field</span>
        <span class="c1"># for the date function exlude the dates we paused for the queen</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error_message</span>

    <span class="k">def</span> <span class="nf">comparison_with_previous_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">name_of_df</span><span class="p">,</span> 
            <span class="n">cols_to_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">perc_increase_threshold</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">perc_decrease_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">check_cols_set</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unique_id_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cols_to_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">manual_override</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; This function allows you to compare the column totals of a dataframe with the totals calculated on a previous time to detect any changes that could be indicative of an error.</span>

<span class="sd">            The historic column totals are stored in a datatable for reference and the function will check the current totals with the most recent previous totals and raise an exception </span>
<span class="sd">            if the totals have changed by more than the specified thresholds.</span>

<span class="sd">            The function will also check if the columns in the dataframe have changed from the previous time and raise an exception if they have.</span>

<span class="sd">            If the previous totals were wrong because of an error and the latest values in the dataframe are correct then you can set manual_override to True and the function will </span>
<span class="sd">            add a new row to the historic db with the new values. This manual override can only be done once in a row to stop someone forgetting they put manual override on and </span>
<span class="sd">            leaving it running in the script which would mean the function would never pick up any errors </span>

<span class="sd">            Args:</span>
<span class="sd">                df (pd.DataFrame): Input dataframe that the historic checks are going to be performed on.</span>
<span class="sd">                name_of_df (str): Name of the dataframe, this will be used to name a file to save for future comparison.</span>
<span class="sd">                cols_to_check (List[str]): A list of strings that detail the columns to be totaled which will then </span>
<span class="sd">                    be compared with previous data.</span>
<span class="sd">                perc_increase_threshold (float): The percentage increase threshold above </span>
<span class="sd">                    which it is deemed that the totals have raised too rapidly and an error has occured.</span>
<span class="sd">                perc_decrease_threshold (float): The percentage decrease threshold below </span>
<span class="sd">                    which it is deemed that the totals decreased and an error has occured.</span>
<span class="sd">                check_cols_set (bool): If true, store the set of columns present for comparison to see if any new </span>
<span class="sd">                    columns have been added or removed next time, in which case it is deemed an error has occured.</span>
<span class="sd">                unique_id_cols (List[str]): A list of  the columns that are unique identifiers in order to do a unique ID count to help identify</span>
<span class="sd">                    any cause of the change in totals of the cols_to_check.   </span>
<span class="sd">                cols_to_group (List[str]): A list the columns that are to be grouped by, and the cols_to_check will be summed for each group. This will be stored as a string in the data table</span>
<span class="sd">                    which can be used as a reference to see which groups have caused the change in totals. </span>
<span class="sd">                raise_exceptions (bool): If true, then raise an exception if an error has occured instead of just returning an error message.</span>
<span class="sd">                    smanual_override (bool): If true, then add a new row to the historic db with the new values with the new value which is outside the tolerance bounds but is now not considered an error</span>
<span class="sd">                date_col (str): The name of the date column in the dataframe</span>
<span class="sd">                dayfirst (bool): If True, parses dates with the day first, eg 10/11/12 is parsed as 2012-11-10. If False, parses dates with the month first, eg 10/11/12 is parsed as 2010-11-12. </span>
<span class="sd">                    If None, this is set to True if the day is in the first position in the format string, False otherwise. If dayfirst is set to True, parsing will be faster, but will fail for ambiguous dates, such as 01/02/03.</span>
<span class="sd">                yearfirst (bool): If True parses dates with the year first, eg 10/11/12 is parsed as 2010-11-12. If both dayfirst and yearfirst are True, yearfirst is preceded (same as dateutil). </span>
<span class="sd">                    If False, parses dates with the month first, eg 10/11/12 is parsed as 2012-11-10. If None, this defaults to False. Setting yearfirst to True is not recommended, as it can result in ambiguous dates.</span>

<span class="sd">            Returns:</span>
<span class="sd">                error_message (str): String detailing what the error is so that it can be passed to a notification service like slack.</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception: If raise_exceptions = True and an error has occured.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">cols_to_check</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;impressions&#39;</span><span class="p">,</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span>
        <span class="n">error_message</span><span class="p">,</span> <span class="n">error_occured</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">client_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">name_of_table</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;previous_totals_check_</span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">name_of_df</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_check</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Create a dictionary of the sums of the columns specified in cols_to_check</span>
        <span class="n">new_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;min_date&#39;</span><span class="p">],</span><span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;max_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_check</span><span class="p">:</span>
            <span class="n">new_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">check_cols_set</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">unique_id_cols</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;num_unique_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">unique_id_cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>

        <span class="c1"># Check if the historic database already exists, if not create it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">name_of_table</span><span class="p">):</span>
            <span class="n">historic_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">read_from_postgresql</span><span class="p">(</span><span class="n">name_of_table</span><span class="p">,</span> <span class="n">clean_date</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">historic_db</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DateWrittenToDB&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># This column is not needed for comparison, it gets created when writing to the db</span>
            <span class="n">historic_db</span> <span class="o">=</span> <span class="n">historic_db</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">historic_db</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">historic_db</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">historic_db</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">new_dict</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">historic_db</span><span class="p">,</span> <span class="n">name_of_table</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">error_message</span>

        <span class="c1">#Turn the most recent entry in the historic db into a dict</span>
        <span class="n">old_dict</span> <span class="o">=</span> <span class="n">historic_db</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># for each key in the old dict, check if it is in the new dict and if it is, check if it has increased or decreased too much</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">old_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;columns&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">]):</span>
                    <span class="c1">#error_occured = True</span>
                    <span class="n">columns_removed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">]))</span>
                    <span class="n">columns_added</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                    <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;The columns seems to have changed from last time,</span><span class="se">\n</span><span class="s1">&#39;</span>\
                                            <span class="sa">f</span><span class="s1">&#39; Columns that were added = </span><span class="si">{</span><span class="n">columns_added</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                            <span class="sa">f</span><span class="s1">&#39; Columns that were removed = </span><span class="si">{</span><span class="n">columns_removed</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_to_check</span><span class="p">:</span> <span class="c1">#If the key is not a numerical type column that needs checking then don&#39;t run the numerical checks</span>
                <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">perc_decrease_threshold</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">error_occured</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;The total of </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> seems to have decreased from last time</span><span class="se">\n</span><span class="s1">&#39;</span>\
                                        <span class="sa">f</span><span class="s1">&#39; Prev Value = </span><span class="si">{</span><span class="n">old_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s1"> , New Value = </span><span class="si">{</span><span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">value</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">perc_increase_threshold</span><span class="o">/</span><span class="mi">100</span><span class="p">):</span>
                <span class="n">error_occured</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;The total of </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> has increased by more than</span><span class="se">\n</span><span class="s1">&#39;</span>\
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">perc_increase_threshold</span><span class="si">}</span><span class="s1">% from last time</span><span class="se">\n</span><span class="s1">&#39;</span>\
                                        <span class="sa">f</span><span class="s1">&#39; Prev Value = </span><span class="si">{</span><span class="n">old_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s1">, New Value = </span><span class="si">{</span><span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="c1"># If cols_to_group is specified, then group by those columns and store the info in the dict</span>
        <span class="k">if</span> <span class="n">cols_to_group</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cols_to_group</span><span class="p">)[</span><span class="n">cols_to_check</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>

        <span class="c1">#The &quot;Columns&quot; and the &quot;info&quot; columns take up a low of space, so we only keep the last 5 entries in the db</span>
        <span class="k">if</span> <span class="n">check_cols_set</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> 
            <span class="n">cols_to_reduce_data</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">,</span><span class="s1">&#39;columns&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols_to_reduce_data</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>

        <span class="c1"># If manual override is set to False, then add a new row to the historic db with the new values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">manual_override</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">error_occured</span><span class="p">:</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Comparison with historic df </span><span class="si">{</span><span class="n">name_of_df</span><span class="si">}</span><span class="s1">: &#39;</span> <span class="o">+</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span> <span class="o">+</span> <span class="n">error_message</span><span class="p">)</span> <span class="c1"># If error messages has been added to then log it</span>
            <span class="k">if</span> <span class="n">raise_exceptions</span> <span class="ow">and</span> <span class="n">error_occured</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">error_occured</span><span class="p">:</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;manual_override&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">db_with_new_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">historic_db</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">new_dict</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">db_with_new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">db_with_new_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">cols_to_reduce_data</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">db_with_new_row</span><span class="p">,</span> <span class="n">name_of_table</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># If manual override is set to True, then add a new row to the historic db with the new values</span>
            <span class="c1">#If the previous entry was not a manual override, then add a new row with the new &quot;correct&quot; value</span>
            <span class="k">if</span> <span class="n">old_dict</span><span class="p">[</span><span class="s1">&#39;manual_override&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Manual Override set to True, adding new row to historic db with different values now deemed to be correct&#39;</span><span class="p">)</span> 
                <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;manual_override&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">db_with_new_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">historic_db</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">new_dict</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">db_with_new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">db_with_new_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">cols_to_reduce_data</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">db_with_new_row</span><span class="p">,</span> <span class="n">name_of_table</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">old_dict</span><span class="p">[</span><span class="s1">&#39;manual_override&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span><span class="c1"># If the previous entry was a manual override, don&#39;t let multiple overrides happen in a row to stop someone forgetting they put manual override on and leaving it running in the script</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Manual override already in place, not adding another row, please check the new value is&#39;</span>\
                                    <span class="s1">&#39;correct and set manual override back to False&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error_message</span>


    <span class="k">def</span> <span class="nf">duplicates_qa</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">name_of_df</span><span class="p">,</span> 
            <span class="n">perc_dupes_thresh</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cols_to_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">cols_to_add</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;duplicates&#39;</span><span class="p">,</span> 
            <span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks for duplicates in a dataframe and returns the duplicates or the dataframe without duplicates.</span>

<span class="sd">        The function first checks to see whether the input dataframe is paid or organic data. If it is paid data then the columns to check for duplicates are</span>
<span class="sd">        [&#39;date&#39;,&#39;platform&#39;,&#39;country&#39;,&#39;media_type&#39;,&#39;cohort&#39;,&#39;message&#39;,&#39;ad_name&#39;,&#39;spend&#39;].</span>

<span class="sd">        For organic data the standard columns it will check for are [&#39;platform&#39;, &#39;country&#39;,&#39;media_type&#39; ,&#39;message&#39;,&#39;url&#39;]</span>

<span class="sd">        You can specify other columns to check for duplicates by passing a list to the cols_to_check argument. You can also add to the standard columns by passing</span>
<span class="sd">        a list to the cols_to_add argument.</span>

<span class="sd">        You can specify whether to return the original df, the df with duplicates removed or just the duplicates or nothing by passing &#39;original&#39;, </span>
<span class="sd">        &#39;duplicates&#39; or &#39;duplicates_removed&#39; or &#39;nothing&#39; to the return_type argument.</span>

<span class="sd">        If the return type is duplicates_removed, an error message will also be returned, with the error message being blank if no duplicates are found. This can be passed</span>
<span class="sd">        to a notification function for example.</span>


<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): The Dataframe to be checked for duplicates</span>
<span class="sd">            name_of_df (str): The name of the dataframe to be used for logging purposes</span>
<span class="sd">            perc_dupes_thresh (int, optional): The percentage of duplicates that are allowed before an error is raised. Defaults to 3.</span>
<span class="sd">            cols_to_check (Optional[list], optional): The columns to check for duplicates. Defaults to None.</span>
<span class="sd">            cols_to_add (Optional[list], optional): The columns to add to the standard cols_to_check to duplicates check. Defaults to None.</span>
<span class="sd">            return_type (str, optional): The type of return. Either &#39;duplicates&#39; or &#39;duplicates_removed&#39;. Defaults to &#39;duplicates&#39;.</span>
<span class="sd">            raise_exceptions (bool, optional): If true raise an exception if duplicates are found. Defaults to True.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If raise_exceptions = True and duplicates are found</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: Returns the duplicates,the df without duplicates or the original df depending on the return_type&quot;&quot;&quot;</span>

        <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Num of rows in </span><span class="si">{</span><span class="n">name_of_df</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">num_rows</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">paid_or_organic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">identify_paid_or_organic</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Paid or Organic? : </span><span class="si">{</span><span class="n">paid_or_organic</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cols_to_check</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">paid_or_organic</span> <span class="o">==</span> <span class="s1">&#39;Paid&#39;</span><span class="p">:</span>
                <span class="c1">#Include date in paid duplicate check because the same ad is repeated across consequitve days</span>
                <span class="c1">#Spend is a good indicator of duplicates in paid data</span>
                <span class="k">if</span> <span class="s1">&#39;spend_usd&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">spend_col</span> <span class="o">=</span> <span class="s1">&#39;spend_usd&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spend_col</span> <span class="o">=</span> <span class="s1">&#39;spend&#39;</span>

                <span class="n">cols_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;media_type&#39;</span><span class="p">,</span> <span class="s1">&#39;cohort&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;ad_name&#39;</span><span class="p">,</span> <span class="n">spend_col</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">paid_or_organic</span> <span class="o">==</span> <span class="s1">&#39;Organic&#39;</span><span class="p">:</span>
                <span class="n">cols_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;media_type&#39;</span> <span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;date_row_added&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">cols_to_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cols_to_add</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols_to_check</span> <span class="o">=</span> <span class="n">cols_to_check</span> <span class="o">+</span> <span class="n">cols_to_add</span>

        <span class="c1">#detect whether a column has the word &#39;age&#39; in it and if so add that column to the cols_to_check</span>
        <span class="c1"># age_columns = [x for x in df.columns if (&#39;age&#39; in x) and (&#39;message&#39; not in x)]</span>
        <span class="c1"># if len(age_columns) &gt; 0:</span>
        <span class="c1">#     logger.info(f&#39;Age columns detected: {age_columns}&#39;)</span>
        <span class="c1">#     cols_to_check = cols_to_check + age_columns</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols_to_check</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">num_duplicates</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">cols_to_check</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_duplicates</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">name_of_df</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">cols_to_check</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">perc_dupes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">cols_to_check</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span> <span class="o">/</span> <span class="n">num_rows</span>
        <span class="n">exceed_thresh</span> <span class="o">=</span> <span class="n">perc_dupes</span> <span class="o">&gt;</span> <span class="n">perc_dupes_thresh</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;% Dupes of whole subset - </span><span class="si">{</span><span class="n">name_of_df</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">perc_dupes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exceed_thresh</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;% Dupes in </span><span class="si">{</span><span class="n">name_of_df</span><span class="si">}</span><span class="s1"> exceeds </span><span class="si">{</span><span class="n">perc_dupes_thresh</span><span class="si">}</span><span class="s1">%&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">raise_exceptions</span> <span class="ow">and</span> <span class="n">exceed_thresh</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;duplicates&#39;</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">cols_to_check</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">cols_to_check</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;duplicates_removed&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">cols_to_check</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">error_message</span>

        <span class="k">elif</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;original&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">elif</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;nothing&#39;</span><span class="p">:</span>
            <span class="k">return</span> 


    <span class="k">def</span> <span class="nf">check_impressions_no_engagements</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">gsheet_name</span><span class="p">,</span> 
            <span class="n">tab_name</span><span class="o">=</span><span class="s1">&#39;NoImpressionsButEngagements&#39;</span><span class="p">,</span> 
            <span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to check if a row item has engagements but no impressions and no video views. </span>
<span class="sd">        This shouldn&#39;t happen and is indicative of an error with Tracer but can be valid as some </span>
<span class="sd">        platforms count viral engagements differently.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (DataFrame): Input dataframe of advertising data with columns &#39;impressions&#39; or &#39;video_views&#39;</span>
<span class="sd">            gsheet_name (str): name of the google sheet</span>
<span class="sd">            tab_name (str, optional): name of the tab. Defaults to &#39;NoImpressionsButEngagements&#39;.</span>
<span class="sd">            raise_exceptions (bool, optional): Boolean flag if set to true will raise an exception if an offending row item is discovered. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            error_message (str): String detailing what the error is so that it can be passed to a notification service like slack.&quot;&quot;&quot;</span>

        <span class="n">paid_or_organic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">identify_paid_or_organic</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="c1"># https://docs.google.com/spreadsheets/d/1refbPLje6B48qvSRNXrK3U_OAfzjzeuTrzgfqq9O-yw/edit#gid=0</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">paid_or_organic</span><span class="si">}</span><span class="s1"> Data Quality Check Function Failed&#39;</span>
        <span class="n">engagements_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;shares&#39;</span><span class="p">]</span>
        <span class="n">engagements_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="n">engagements_cols</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Check for zeros in impression columns but non zeros in likes, impressions, and other metrics</span>
        <span class="n">no_impr_but_engage</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;impressions&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">engagements_mask</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># TikTok organic doesn&#39;t have impressions, instead it has video views. There is an error if</span>
        <span class="c1"># Video views is equal to zero but there are engagements</span>
        <span class="n">tiktok_org_no_impr_but_engage</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TikTok&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;workstream&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;boosted&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                                <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;video_views&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">engagements_mask</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">reels_org_no_impr_but_engage</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;placement&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Reels&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;workstream&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;boosted&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                                <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;video_views&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">engagements_mask</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># paid with  impressions but has engagements</span>
        <span class="n">no_impressions_but_engage_rows</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">no_impr_but_engage</span> <span class="o">+</span> <span class="n">tiktok_org_no_impr_but_engage</span> 
                                            <span class="o">+</span> <span class="n">reels_org_no_impr_but_engage</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_impressions_but_engage_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">no_impressions_but_engage_rows</span><span class="p">)</span><span class="si">}</span><span class="s1"> rows with&#39;</span>\
                <span class="s1">&#39; zeros in impressions columns but non-zeros in likes, comments, shares and video_views</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">no_impressions_but_engage_rows</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># error_message = error_message + &quot; &quot; + &quot;Split By platform&quot;</span>
            <span class="c1"># error_message = error_message + &quot; &quot; + pd.crosstab(erroneous_df[&#39;platform&#39;],erroneous_df[&#39;media_type&#39;],margins=True,dropna=False)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_gsheet</span><span class="p">(</span><span class="n">gsheet_name</span><span class="p">,</span> <span class="n">tab_name</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">no_impressions_but_engage_rows</span><span class="p">],</span>
                            <span class="n">sheet_prefix</span><span class="o">=</span><span class="n">paid_or_organic</span><span class="p">)</span>
            <span class="n">exception_occurred</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raise_exceptions</span> <span class="ow">and</span> <span class="n">exception_occurred</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">error_message</span>

    <span class="k">def</span> <span class="nf">naming_convention_checker</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">gsheet_name</span><span class="p">,</span> 
            <span class="n">naming_convention</span><span class="p">,</span> 
            <span class="n">campaignname_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adgroupname_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">adname_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">campaign_col</span><span class="o">=</span><span class="s1">&#39;campaign_name&#39;</span><span class="p">,</span> 
            <span class="n">adgroup_col</span><span class="o">=</span><span class="s1">&#39;group_name&#39;</span><span class="p">,</span> <span class="n">adname_col</span><span class="o">=</span><span class="s1">&#39;ad_name&#39;</span><span class="p">,</span>
            <span class="n">spend_col</span><span class="o">=</span><span class="s1">&#39;spend_usd&#39;</span><span class="p">,</span> <span class="n">start_char</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> 
            <span class="n">middle_char</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">end_char</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span>
            <span class="n">platform_col</span><span class="o">=</span><span class="s1">&#39;platform&#39;</span><span class="p">,</span> 
            <span class="n">check_meta_platform</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks for naming convention errors in a given DataFrame and outputs the errors to a Google Sheet.</span>

<span class="sd">        The function takes in a DataFrame containing paid data with columns for campaign name, ad group name, and ad name, </span>
<span class="sd">        as well as a DataFrame containing the accepted tags and values for each level of naming (campaign, ad group, ad name). </span>
<span class="sd">        Dictionarys for each level fo checking are required this specifies what tags should be checked for, e.g. should a check</span>
<span class="sd">        for the correct values in &#39;platform&#39; be performed. If a dictionary for a certain level is not provided that level will</span>
<span class="sd">        not be checked. The function will output a table in a Google Sheet showing all errors in naming conventions, </span>
<span class="sd">        with a tab for each level of errors.</span>

<span class="sd">        The Google Sheet should be set up with a tab name for each level of errors to check for, </span>
<span class="sd">        i.e. &#39;CampaignNameErrors&#39;, &#39;AdGroupNameErrors&#39;, &#39;AdNameErrors&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (DataFrame): The DataFrame containing paid data with campaign name, ad group name, and ad name columns.</span>
<span class="sd">            naming_convention (DataFrame): The DataFrame containing the accepted tags and values for each level of naming.</span>
<span class="sd">            campaignname_dict (dict, optional): A dictionary of the tags to be checked for the campaign name, with the column label as the key and the shortcode as the value.</span>
<span class="sd">            adgroupname_dict (dict, optional): A dictionary of the tags to be checked for the ad group name, with the column label as the key and the shortcode as the value.</span>
<span class="sd">            adname_dict (dict, optional): A dictionary of the tags to be checked for the ad name, with the column label as the key and the shortcode as the value.</span>
<span class="sd">            campaign_col (str, optional): The column in the input DataFrame that corresponds to the campaign name. Defaults to &#39;campaign_name&#39;.</span>
<span class="sd">            adgroup_col (str, optional): The column in the input DataFrame that corresponds to the ad group name. Defaults to &#39;group_name&#39;.</span>
<span class="sd">            adname_col (str, optional): The column in the input DataFrame that corresponds to the ad name. Defaults to &#39;name&#39;.</span>
<span class="sd">            start_char (str, optional): The starting character for the tag in the naming convention. Defaults to &#39;_&#39;.</span>
<span class="sd">            middle_char (str, optional): The character that separates the tag from the value in the naming convention. Defaults to &#39;:&#39;.</span>
<span class="sd">            end_char (str, optional): The ending character for the tag in the naming convention. Defaults to &#39;_&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Writes to a Google Sheet a table with the index being a unique instance of the campaign.&quot;&quot;&quot;</span>

        <span class="n">conv_level_tuple</span> <span class="o">=</span> <span class="p">((</span><span class="n">campaignname_dict</span><span class="p">,</span> <span class="n">campaign_col</span><span class="p">,</span> <span class="s1">&#39;CampaignNameErrors&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">adgroupname_dict</span><span class="p">,</span> <span class="n">adgroup_col</span><span class="p">,</span> <span class="s1">&#39;AdGroupNameErrors&#39;</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">adname_dict</span><span class="p">,</span> <span class="n">adname_col</span><span class="p">,</span> <span class="s1">&#39;AdNameErrors&#39;</span><span class="p">))</span>
        <span class="c1"># df = clean.clean_column_names(df)</span>
        <span class="c1">#Obtain the column names of all the Keys available in the convention tracker sheet</span>
        <span class="c1">#https://docs.google.com/spreadsheets/d/1Wtwd6xT9zRLhPICWSWDNZ2mXBy74_xszLVX2ZqO_odo/edit#gid=605935420</span>
        <span class="n">key_values_conv_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; Key&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">naming_convention</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39; Key&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">remove_empties_from_list</span><span class="p">(</span><span class="n">input_list</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;Obtaining a list of keys from the tracker sheet column often results in multiple empty</span>
<span class="sd">                strings, this function removes them from the list&#39;&#39;&#39;</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">input_list</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">return_value</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">acceptable_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;This checks for each campaign, group_name or ad_name string, for a certain tag e.g.&#39;pl&#39;</span>
<span class="sd">            whether the tag is even present and if so whether a correct value is present&quot;&quot;&quot;</span>
            <span class="n">search_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">start_char</span><span class="si">}{</span><span class="n">tag</span><span class="si">}{</span><span class="n">middle_char</span><span class="si">}</span><span class="s1">(.*?)</span><span class="si">{</span><span class="n">end_char</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">search_result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">search_string</span><span class="p">,</span> <span class="n">string</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="c1">#add a underscore at so search string has an endpoint to find</span>
            <span class="k">if</span> <span class="n">search_result</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;NoKey&#39;</span>
            <span class="k">elif</span> <span class="n">search_result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;NoKey&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">acceptable_values</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;CorrectKeyPresent&quot;</span>
                <span class="k">if</span> <span class="n">search_result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">acceptable_values</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;Correct&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;Incorrect Value&#39;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conv_level_tuple</span><span class="p">):</span>
            <span class="n">checking_cols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s1">&#39;video_views&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">cols_to_sum</span> <span class="o">=</span> <span class="p">[</span><span class="n">spend_col</span><span class="p">,</span> <span class="s1">&#39;video_views&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cols_to_sum</span> <span class="o">=</span> <span class="n">spend_col</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">agg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_sum</span><span class="p">}</span>
                <span class="n">agg_dict</span><span class="p">[</span><span class="n">platform_col</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;first&#39;</span>
                <span class="n">output_df</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_dict</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">check_meta_platform</span><span class="p">:</span>
                    <span class="n">checking_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;platform_meta_check&#39;</span><span class="p">)</span>
                    <span class="k">def</span> <span class="nf">check_meta_platform_function</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">platform_col</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Facebook&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">middle_char</span><span class="si">}</span><span class="s1">IG</span><span class="si">{</span><span class="n">end_char</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="n">adname_col</span><span class="p">]:</span>
                                <span class="k">return</span> <span class="s1">&#39;IG in ad name but platform is Facebook&#39;</span>
                        <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">platform_col</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Instagram&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">middle_char</span><span class="si">}</span><span class="s1">FB</span><span class="si">{</span><span class="n">end_char</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="n">adname_col</span><span class="p">]:</span>
                                <span class="k">return</span> <span class="s1">&#39;FB in ad name but platform is Instagram&#39;</span>

                    <span class="n">output_df</span><span class="p">[</span><span class="s1">&#39;platform_meta_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">check_meta_platform_function</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#For each level of the naming convention, i.e. campaign, adgroup, adname</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_df</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="n">cols_to_sum</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1">#no convention dict provided therefore ignore</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1">#For each label and tag in the required set </span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">key_values_conv_cols</span><span class="p">:</span>
                    <span class="n">acceptable_values</span><span class="o">=</span> <span class="n">remove_empties_from_list</span><span class="p">(</span><span class="n">naming_convention</span><span class="p">[</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39; Key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">output_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_df</span><span class="p">[</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">return_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">acceptable_values</span><span class="p">))</span>
                    <span class="n">checking_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_df</span><span class="p">[</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">return_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
                    <span class="n">checking_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>

            <span class="n">output_df</span> <span class="o">=</span> <span class="n">output_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">checking_cols</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_gsheet</span><span class="p">(</span><span class="n">workbook_name</span> <span class="o">=</span> <span class="n">gsheet_name</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span> <span class="n">level</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">df</span> <span class="o">=</span> <span class="n">output_df</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="veetility.quality_assessments.QualityAssessments.boosted_function_qa" class="doc doc-heading">
<code class="highlight language-python"><span class="n">boosted_function_qa</span><span class="p">(</span><span class="n">paid_df</span><span class="p">,</span> <span class="n">organic_df</span><span class="p">,</span> <span class="n">gsheet_name</span><span class="p">,</span> <span class="n">tab_name</span><span class="o">=</span><span class="s1">&#39;OrganicWithBigImpressions&#39;</span><span class="p">,</span> <span class="n">impressions_threshold</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Takes in organic data and paid data and reports how many are mislabelled as boosted</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>paid_df</code></td>
          <td>
                <code>pandas.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>Daily ad spend, boosted posts identified in the 'workstream' column</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>organic_df</code></td>
          <td>
                <code>pandas.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>Organic Post performance Data </p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>impressions_threshold</code></td>
          <td>
                <code>pandas.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>The number of impressions above which it is unlikely the post is purely organic</p></td>
          <td>
                <code>100000</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>error_message</code></td>          <td>
                <code>str</code>
          </td>
          <td><p>A string detailing what the error is so that it can be passed to a notification service like slack</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/quality_assessments.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">boosted_function_qa</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">paid_df</span><span class="p">,</span> 
        <span class="n">organic_df</span><span class="p">,</span> <span class="n">gsheet_name</span><span class="p">,</span> 
        <span class="n">tab_name</span><span class="o">=</span><span class="s1">&#39;OrganicWithBigImpressions&#39;</span><span class="p">,</span> 
        <span class="n">impressions_threshold</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes in organic data and paid data and reports how many are mislabelled as boosted</span>

<span class="sd">    Args:</span>
<span class="sd">        paid_df (pandas.DataFrame): Daily ad spend, boosted posts identified in the &#39;workstream&#39; column</span>
<span class="sd">        organic_df (pandas.DataFrame): Organic Post performance Data </span>
<span class="sd">        impressions_threshold (pandas.DataFrame): The number of impressions above which it is unlikely the post is purely organic</span>

<span class="sd">    Returns:</span>
<span class="sd">        error_message (str): A string detailing what the error is so that it can be passed to a notification service like slack&quot;&quot;&quot;</span>
    <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">organic_df</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># count number of unique paid posts wi  th workstream organic minus oranic posts labelled as boosted</span>
    <span class="c1"># number of boosted post from paid naming convention Tags</span>
    <span class="n">paid_boosted_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paid_df</span><span class="p">[</span><span class="n">paid_df</span><span class="p">[</span><span class="s1">&#39;workstream&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;boosted&#39;</span><span class="p">][</span><span class="s1">&#39;post_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

    <span class="c1"># number of posts our boosted matching function has identified as boosted</span>
    <span class="n">organic_boosted_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">organic_df</span><span class="p">[</span><span class="n">organic_df</span><span class="p">[</span><span class="s1">&#39;workstream&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;boosted&#39;</span><span class="p">][</span><span class="s1">&#39;post_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">missing_boosted</span> <span class="o">=</span> <span class="n">paid_boosted_count</span><span class="o">-</span><span class="n">organic_boosted_count</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">missing_boosted</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> \
            <span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="n">missing_boosted</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">missing_boosted</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">paid_boosted_count</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">%) posts mislabelled as Pure Organic</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

    <span class="c1"># A post that is labelled as organic but has impressions over the impressions_threshold may actually be boosted </span>
    <span class="c1"># but hasn&#39;t been identified as such</span>
    <span class="n">misslabelled_og_rows</span> <span class="o">=</span> <span class="n">organic_df</span><span class="p">[(</span><span class="n">organic_df</span><span class="p">[</span><span class="s1">&#39;workstream&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Pure Organic&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
                                    <span class="p">((</span><span class="n">organic_df</span><span class="p">[</span><span class="s1">&#39;impressions&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">impressions_threshold</span><span class="p">)</span> <span class="o">|</span> \
                                    <span class="p">(</span><span class="n">organic_df</span><span class="p">[</span><span class="s1">&#39;video_views&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">impressions_threshold</span><span class="p">))]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">misslabelled_og_rows</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> \
            <span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">misslabelled_og_rows</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s1"> Pure Organic posts with over </span><span class="si">{</span><span class="n">impressions_threshold</span><span class="si">}</span><span class="s1"> impressions or video views</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_gsheet</span><span class="p">(</span><span class="n">gsheet_name</span><span class="p">,</span> <span class="n">tab_name</span><span class="p">,</span> <span class="n">misslabelled_og_rows</span><span class="p">)</span>
    <span class="c1"># return TT or IG values with empty message field</span>
    <span class="c1"># for the date function exlude the dates we paused for the queen</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">error_message</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.quality_assessments.QualityAssessments.check_data_recency" class="doc doc-heading">
<code class="highlight language-python"><span class="n">check_data_recency</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols_to_group</span><span class="p">,</span> <span class="n">gsheet_name</span><span class="p">,</span> <span class="n">tab_name</span><span class="o">=</span><span class="s1">&#39;DataRecency&#39;</span><span class="p">,</span> <span class="n">three_days_for_monday</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dayfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Post a google sheet showing how many days since different channels have been active.
Also return a list of channels that have been inactive for more than 2 days which
might be indicative of an error</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code>pandas.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>Dataframe of data containing a 'date' column</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cols_to_group</code></td>
          <td>
                <code>list or str</code>
          </td>
          <td><p>Columns to groupby effectively creating the 'channels'</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>gsheet_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the google sheet to write to</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tab_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the tab in the Google sheet</p></td>
          <td>
                <code>&#39;DataRecency&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>three_days_for_monday</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If the check is run on a Monday, give 3 days before declaring a channel as inactive because of the weekend.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>date_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Column name for the date to find the maximum value for based on grouping by <code>cols_to_group</code>. If 'created' is used when working with Tracer data, then this will find out when the data was last updated by Tracer, regardless of whether the actual date of the post was 30 days ago.</p></td>
          <td>
                <code>&#39;date&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>dayfirst</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, parses dates with the day first, eg 10/11/12 is parsed as 2012-11-10. If False, parses dates with the month first, eg 10/11/12 is parsed as 2010-11-12. If None, this is set to True if the day is in the first position in the format string, False otherwise. If dayfirst is set to True, parsing will be faster, but will fail for ambiguous dates, such as 01/02/03.</p></td>
          <td>
                <code>&#39;EnterValue&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>yearfirst</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True parses dates with the year first, eg 10/11/12 is parsed as 2010-11-12. If both dayfirst and yearfirst are True, yearfirst is preceded (same as dateutil). If False, parses dates with the month first, eg 10/11/12 is parsed as 2012-11-10. If None, this defaults to False. Setting yearfirst to True is not recommended, as it can result in ambiguous dates.</p></td>
          <td>
                <code>&#39;EnterValue&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>format</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Format to use for strptime. If None, the format is inferred from the first non-NaN element of the column. If the format is inferred, it will be used in subsequent parsing, even if the format changes. To specify a format string that will be used in parsing regardless of the inferred format, use pd.to_datetime with format.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>errors</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>If 'raise', then invalid parsing will raise an exception. If 'coerce', then invalid parsing will be set as NaT. If 'ignore', then invalid parsing will return the input.</p></td>
          <td>
                <code>&#39;raise&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>error_message</code></td>          <td>
                <code>str</code>
          </td>
          <td><p>String error message describing which channels are recently inactive. This message can then be sent
                to a slack function</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/quality_assessments.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">check_data_recency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                       <span class="n">df</span><span class="p">,</span> 
                       <span class="n">cols_to_group</span><span class="p">,</span>
                       <span class="n">gsheet_name</span><span class="p">,</span> 
                       <span class="n">tab_name</span><span class="o">=</span><span class="s1">&#39;DataRecency&#39;</span><span class="p">,</span>
                       <span class="n">three_days_for_monday</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                       <span class="n">dayfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> 
                       <span class="n">yearfirst</span><span class="o">=</span><span class="s1">&#39;EnterValue&#39;</span><span class="p">,</span> 
                       <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                       <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Post a google sheet showing how many days since different channels have been active.</span>
<span class="sd">    Also return a list of channels that have been inactive for more than 2 days which</span>
<span class="sd">    might be indicative of an error</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pandas.DataFrame): Dataframe of data containing a &#39;date&#39; column</span>
<span class="sd">        cols_to_group (list or str): Columns to groupby effectively creating the &#39;channels&#39;</span>
<span class="sd">        gsheet_name (str): Name of the google sheet to write to</span>
<span class="sd">        tab_name (str): Name of the tab in the Google sheet</span>
<span class="sd">        three_days_for_monday (bool): If the check is run on a Monday, give 3 days before declaring a channel as inactive because of the weekend.</span>
<span class="sd">        date_col (str): Column name for the date to find the maximum value for based on grouping by `cols_to_group`. If &#39;created&#39; is used when working with Tracer data, then this will find out when the data was last updated by Tracer, regardless of whether the actual date of the post was 30 days ago.</span>
<span class="sd">        dayfirst (bool): If True, parses dates with the day first, eg 10/11/12 is parsed as 2012-11-10. If False, parses dates with the month first, eg 10/11/12 is parsed as 2010-11-12. If None, this is set to True if the day is in the first position in the format string, False otherwise. If dayfirst is set to True, parsing will be faster, but will fail for ambiguous dates, such as 01/02/03.</span>
<span class="sd">        yearfirst (bool): If True parses dates with the year first, eg 10/11/12 is parsed as 2010-11-12. If both dayfirst and yearfirst are True, yearfirst is preceded (same as dateutil). If False, parses dates with the month first, eg 10/11/12 is parsed as 2012-11-10. If None, this defaults to False. Setting yearfirst to True is not recommended, as it can result in ambiguous dates.</span>
<span class="sd">        format (str): Format to use for strptime. If None, the format is inferred from the first non-NaN element of the column. If the format is inferred, it will be used in subsequent parsing, even if the format changes. To specify a format string that will be used in parsing regardless of the inferred format, use pd.to_datetime with format.</span>
<span class="sd">        errors (str): If &#39;raise&#39;, then invalid parsing will raise an exception. If &#39;coerce&#39;, then invalid parsing will be set as NaT. If &#39;ignore&#39;, then invalid parsing will return the input.</span>

<span class="sd">    Returns:</span>
<span class="sd">        error_message (str): String error message describing which channels are recently inactive. This message can then be sent</span>
<span class="sd">                            to a slack function&quot;&quot;&quot;</span>

    <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">organic_or_paid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">identify_paid_or_organic</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">organic_or_paid</span><span class="p">)</span>
    <span class="n">buffer_days_since_active</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="c1">#remove any timezone information from the date_col and check the date is being read in in correct format</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span>
                                  <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>

    <span class="n">data_recency</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cols_to_group</span><span class="p">)[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">today</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">date_col</span><span class="p">:</span><span class="s1">&#39;DaysSinceActive&#39;</span><span class="p">})</span>  

    <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_gsheet</span><span class="p">(</span><span class="n">gsheet_name</span><span class="p">,</span> <span class="n">tab_name</span><span class="p">,</span> <span class="n">data_recency</span><span class="p">,</span> <span class="n">sheet_prefix</span><span class="o">=</span><span class="n">organic_or_paid</span><span class="p">)</span>

    <span class="c1">#create a tag string to identify a channel, a concatenation of all the column values specified in &#39;cols_to_group&#39;</span>
    <span class="k">def</span> <span class="nf">concat_cols</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_group</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

    <span class="n">data_recency</span><span class="p">[</span><span class="s1">&#39;Channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_recency</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">concat_cols</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">#The option for giving 3 days of buffer for monday is available in case no advertising/posting is done </span>
    <span class="c1">#over the weekend and you don&#39;t want many channels appearing as if they are inactive on Monday morning</span>
    <span class="k">if</span> <span class="n">today</span><span class="o">.</span><span class="n">day_of_week</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">three_days_for_monday</span><span class="p">:</span> 
        <span class="n">buffer_days_since_active</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="n">channels_recently_inactive</span> <span class="o">=</span> <span class="n">data_recency</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DaysSinceActive &gt;</span><span class="si">{</span><span class="n">buffer_days_since_active</span><span class="si">}</span><span class="s1"> and DaysSinceActive &lt;=6&#39;</span><span class="p">)</span>
    <span class="n">channels_recently_inactive_list</span> <span class="o">=</span> <span class="n">channels_recently_inactive</span><span class="p">[</span><span class="s1">&#39;Channel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels_recently_inactive_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">organic_or_paid</span><span class="si">}</span><span class="s1"> Channels Recently that are recently inactive </span><span class="si">{</span><span class="s2">&quot; , &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channels_recently_inactive_list</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">return</span> <span class="n">error_message</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.quality_assessments.QualityAssessments.check_impressions_no_engagements" class="doc doc-heading">
<code class="highlight language-python"><span class="n">check_impressions_no_engagements</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">gsheet_name</span><span class="p">,</span> <span class="n">tab_name</span><span class="o">=</span><span class="s1">&#39;NoImpressionsButEngagements&#39;</span><span class="p">,</span> <span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Function to check if a row item has engagements but no impressions and no video views. 
This shouldn't happen and is indicative of an error with Tracer but can be valid as some 
platforms count viral engagements differently.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code>DataFrame</code>
          </td>
          <td><p>Input dataframe of advertising data with columns 'impressions' or 'video_views'</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>gsheet_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>name of the google sheet</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tab_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>name of the tab. Defaults to 'NoImpressionsButEngagements'.</p></td>
          <td>
                <code>&#39;NoImpressionsButEngagements&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>raise_exceptions</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Boolean flag if set to true will raise an exception if an offending row item is discovered. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>error_message</code></td>          <td>
                <code>str</code>
          </td>
          <td><p>String detailing what the error is so that it can be passed to a notification service like slack.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/quality_assessments.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">check_impressions_no_engagements</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">gsheet_name</span><span class="p">,</span> 
        <span class="n">tab_name</span><span class="o">=</span><span class="s1">&#39;NoImpressionsButEngagements&#39;</span><span class="p">,</span> 
        <span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to check if a row item has engagements but no impressions and no video views. </span>
<span class="sd">    This shouldn&#39;t happen and is indicative of an error with Tracer but can be valid as some </span>
<span class="sd">    platforms count viral engagements differently.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (DataFrame): Input dataframe of advertising data with columns &#39;impressions&#39; or &#39;video_views&#39;</span>
<span class="sd">        gsheet_name (str): name of the google sheet</span>
<span class="sd">        tab_name (str, optional): name of the tab. Defaults to &#39;NoImpressionsButEngagements&#39;.</span>
<span class="sd">        raise_exceptions (bool, optional): Boolean flag if set to true will raise an exception if an offending row item is discovered. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        error_message (str): String detailing what the error is so that it can be passed to a notification service like slack.&quot;&quot;&quot;</span>

    <span class="n">paid_or_organic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">identify_paid_or_organic</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="c1"># https://docs.google.com/spreadsheets/d/1refbPLje6B48qvSRNXrK3U_OAfzjzeuTrzgfqq9O-yw/edit#gid=0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
    <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">paid_or_organic</span><span class="si">}</span><span class="s1"> Data Quality Check Function Failed&#39;</span>
    <span class="n">engagements_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;likes&#39;</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;shares&#39;</span><span class="p">]</span>
    <span class="n">engagements_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="n">engagements_cols</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Check for zeros in impression columns but non zeros in likes, impressions, and other metrics</span>
    <span class="n">no_impr_but_engage</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;impressions&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">engagements_mask</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># TikTok organic doesn&#39;t have impressions, instead it has video views. There is an error if</span>
    <span class="c1"># Video views is equal to zero but there are engagements</span>
    <span class="n">tiktok_org_no_impr_but_engage</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TikTok&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;workstream&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;boosted&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;video_views&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">engagements_mask</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">reels_org_no_impr_but_engage</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;placement&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Reels&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;workstream&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;boosted&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                                            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;video_views&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">engagements_mask</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># paid with  impressions but has engagements</span>
    <span class="n">no_impressions_but_engage_rows</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">no_impr_but_engage</span> <span class="o">+</span> <span class="n">tiktok_org_no_impr_but_engage</span> 
                                        <span class="o">+</span> <span class="n">reels_org_no_impr_but_engage</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_impressions_but_engage_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">no_impressions_but_engage_rows</span><span class="p">)</span><span class="si">}</span><span class="s1"> rows with&#39;</span>\
            <span class="s1">&#39; zeros in impressions columns but non-zeros in likes, comments, shares and video_views</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">no_impressions_but_engage_rows</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># error_message = error_message + &quot; &quot; + &quot;Split By platform&quot;</span>
        <span class="c1"># error_message = error_message + &quot; &quot; + pd.crosstab(erroneous_df[&#39;platform&#39;],erroneous_df[&#39;media_type&#39;],margins=True,dropna=False)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_gsheet</span><span class="p">(</span><span class="n">gsheet_name</span><span class="p">,</span> <span class="n">tab_name</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">no_impressions_but_engage_rows</span><span class="p">],</span>
                        <span class="n">sheet_prefix</span><span class="o">=</span><span class="n">paid_or_organic</span><span class="p">)</span>
        <span class="n">exception_occurred</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raise_exceptions</span> <span class="ow">and</span> <span class="n">exception_occurred</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">error_message</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.quality_assessments.QualityAssessments.comparison_with_previous_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">comparison_with_previous_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name_of_df</span><span class="p">,</span> <span class="n">cols_to_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">perc_increase_threshold</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">perc_decrease_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">check_cols_set</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unique_id_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cols_to_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">manual_override</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function allows you to compare the column totals of a dataframe with the totals calculated on a previous time to detect any changes that could be indicative of an error.</p>
<p>The historic column totals are stored in a datatable for reference and the function will check the current totals with the most recent previous totals and raise an exception 
if the totals have changed by more than the specified thresholds.</p>
<p>The function will also check if the columns in the dataframe have changed from the previous time and raise an exception if they have.</p>
<p>If the previous totals were wrong because of an error and the latest values in the dataframe are correct then you can set manual_override to True and the function will 
add a new row to the historic db with the new values. This manual override can only be done once in a row to stop someone forgetting they put manual override on and 
leaving it running in the script which would mean the function would never pick up any errors </p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><span title="pandas">pd</span>.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>Input dataframe that the historic checks are going to be performed on.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>name_of_df</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the dataframe, this will be used to name a file to save for future comparison.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cols_to_check</code></td>
          <td>
                <code>List[str]</code>
          </td>
          <td><p>A list of strings that detail the columns to be totaled which will then 
be compared with previous data.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>perc_increase_threshold</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>The percentage increase threshold above 
which it is deemed that the totals have raised too rapidly and an error has occured.</p></td>
          <td>
                <code>20</code>
          </td>
        </tr>
        <tr>
          <td><code>perc_decrease_threshold</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>The percentage decrease threshold below 
which it is deemed that the totals decreased and an error has occured.</p></td>
          <td>
                <code>0.5</code>
          </td>
        </tr>
        <tr>
          <td><code>check_cols_set</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If true, store the set of columns present for comparison to see if any new 
columns have been added or removed next time, in which case it is deemed an error has occured.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>unique_id_cols</code></td>
          <td>
                <code>List[str]</code>
          </td>
          <td><p>A list of  the columns that are unique identifiers in order to do a unique ID count to help identify
any cause of the change in totals of the cols_to_check.   </p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>cols_to_group</code></td>
          <td>
                <code>List[str]</code>
          </td>
          <td><p>A list the columns that are to be grouped by, and the cols_to_check will be summed for each group. This will be stored as a string in the data table
which can be used as a reference to see which groups have caused the change in totals. </p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>raise_exceptions</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If true, then raise an exception if an error has occured instead of just returning an error message.
smanual_override (bool): If true, then add a new row to the historic db with the new values with the new value which is outside the tolerance bounds but is now not considered an error</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>date_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the date column in the dataframe</p></td>
          <td>
                <code>&#39;date&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>dayfirst</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, parses dates with the day first, eg 10/11/12 is parsed as 2012-11-10. If False, parses dates with the month first, eg 10/11/12 is parsed as 2010-11-12. 
If None, this is set to True if the day is in the first position in the format string, False otherwise. If dayfirst is set to True, parsing will be faster, but will fail for ambiguous dates, such as 01/02/03.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>yearfirst</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True parses dates with the year first, eg 10/11/12 is parsed as 2010-11-12. If both dayfirst and yearfirst are True, yearfirst is preceded (same as dateutil). 
If False, parses dates with the month first, eg 10/11/12 is parsed as 2012-11-10. If None, this defaults to False. Setting yearfirst to True is not recommended, as it can result in ambiguous dates.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>error_message</code></td>          <td>
                <code>str</code>
          </td>
          <td><p>String detailing what the error is so that it can be passed to a notification service like slack.</p></td>
        </tr>
    </tbody>
  </table>

  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>Exception</code>
          </td>
          <td><p>If raise_exceptions = True and an error has occured.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/quality_assessments.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">comparison_with_previous_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">name_of_df</span><span class="p">,</span> 
        <span class="n">cols_to_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">perc_increase_threshold</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">perc_decrease_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">check_cols_set</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unique_id_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cols_to_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">manual_override</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">date_col</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This function allows you to compare the column totals of a dataframe with the totals calculated on a previous time to detect any changes that could be indicative of an error.</span>

<span class="sd">        The historic column totals are stored in a datatable for reference and the function will check the current totals with the most recent previous totals and raise an exception </span>
<span class="sd">        if the totals have changed by more than the specified thresholds.</span>

<span class="sd">        The function will also check if the columns in the dataframe have changed from the previous time and raise an exception if they have.</span>

<span class="sd">        If the previous totals were wrong because of an error and the latest values in the dataframe are correct then you can set manual_override to True and the function will </span>
<span class="sd">        add a new row to the historic db with the new values. This manual override can only be done once in a row to stop someone forgetting they put manual override on and </span>
<span class="sd">        leaving it running in the script which would mean the function would never pick up any errors </span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): Input dataframe that the historic checks are going to be performed on.</span>
<span class="sd">            name_of_df (str): Name of the dataframe, this will be used to name a file to save for future comparison.</span>
<span class="sd">            cols_to_check (List[str]): A list of strings that detail the columns to be totaled which will then </span>
<span class="sd">                be compared with previous data.</span>
<span class="sd">            perc_increase_threshold (float): The percentage increase threshold above </span>
<span class="sd">                which it is deemed that the totals have raised too rapidly and an error has occured.</span>
<span class="sd">            perc_decrease_threshold (float): The percentage decrease threshold below </span>
<span class="sd">                which it is deemed that the totals decreased and an error has occured.</span>
<span class="sd">            check_cols_set (bool): If true, store the set of columns present for comparison to see if any new </span>
<span class="sd">                columns have been added or removed next time, in which case it is deemed an error has occured.</span>
<span class="sd">            unique_id_cols (List[str]): A list of  the columns that are unique identifiers in order to do a unique ID count to help identify</span>
<span class="sd">                any cause of the change in totals of the cols_to_check.   </span>
<span class="sd">            cols_to_group (List[str]): A list the columns that are to be grouped by, and the cols_to_check will be summed for each group. This will be stored as a string in the data table</span>
<span class="sd">                which can be used as a reference to see which groups have caused the change in totals. </span>
<span class="sd">            raise_exceptions (bool): If true, then raise an exception if an error has occured instead of just returning an error message.</span>
<span class="sd">                smanual_override (bool): If true, then add a new row to the historic db with the new values with the new value which is outside the tolerance bounds but is now not considered an error</span>
<span class="sd">            date_col (str): The name of the date column in the dataframe</span>
<span class="sd">            dayfirst (bool): If True, parses dates with the day first, eg 10/11/12 is parsed as 2012-11-10. If False, parses dates with the month first, eg 10/11/12 is parsed as 2010-11-12. </span>
<span class="sd">                If None, this is set to True if the day is in the first position in the format string, False otherwise. If dayfirst is set to True, parsing will be faster, but will fail for ambiguous dates, such as 01/02/03.</span>
<span class="sd">            yearfirst (bool): If True parses dates with the year first, eg 10/11/12 is parsed as 2010-11-12. If both dayfirst and yearfirst are True, yearfirst is preceded (same as dateutil). </span>
<span class="sd">                If False, parses dates with the month first, eg 10/11/12 is parsed as 2012-11-10. If None, this defaults to False. Setting yearfirst to True is not recommended, as it can result in ambiguous dates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            error_message (str): String detailing what the error is so that it can be passed to a notification service like slack.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If raise_exceptions = True and an error has occured.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">cols_to_check</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cols_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;impressions&#39;</span><span class="p">,</span><span class="s1">&#39;likes&#39;</span><span class="p">]</span>
    <span class="n">error_message</span><span class="p">,</span> <span class="n">error_occured</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">False</span>
    <span class="n">client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">client_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">name_of_table</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;previous_totals_check_</span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">name_of_df</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="n">dayfirst</span><span class="p">,</span> <span class="n">yearfirst</span><span class="o">=</span><span class="n">yearfirst</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_check</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Create a dictionary of the sums of the columns specified in cols_to_check</span>
    <span class="n">new_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;min_date&#39;</span><span class="p">],</span><span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;max_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_check</span><span class="p">:</span>
        <span class="n">new_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">check_cols_set</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">unique_id_cols</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;num_unique_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">unique_id_cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>

    <span class="c1"># Check if the historic database already exists, if not create it</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">name_of_table</span><span class="p">):</span>
        <span class="n">historic_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">read_from_postgresql</span><span class="p">(</span><span class="n">name_of_table</span><span class="p">,</span> <span class="n">clean_date</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">historic_db</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DateWrittenToDB&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># This column is not needed for comparison, it gets created when writing to the db</span>
        <span class="n">historic_db</span> <span class="o">=</span> <span class="n">historic_db</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">historic_db</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">historic_db</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">historic_db</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">new_dict</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">historic_db</span><span class="p">,</span> <span class="n">name_of_table</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error_message</span>

    <span class="c1">#Turn the most recent entry in the historic db into a dict</span>
    <span class="n">old_dict</span> <span class="o">=</span> <span class="n">historic_db</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># for each key in the old dict, check if it is in the new dict and if it is, check if it has increased or decreased too much</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">old_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;columns&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">]):</span>
                <span class="c1">#error_occured = True</span>
                <span class="n">columns_removed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">]))</span>
                <span class="n">columns_added</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;The columns seems to have changed from last time,</span><span class="se">\n</span><span class="s1">&#39;</span>\
                                        <span class="sa">f</span><span class="s1">&#39; Columns that were added = </span><span class="si">{</span><span class="n">columns_added</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> \
                                        <span class="sa">f</span><span class="s1">&#39; Columns that were removed = </span><span class="si">{</span><span class="n">columns_removed</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_to_check</span><span class="p">:</span> <span class="c1">#If the key is not a numerical type column that needs checking then don&#39;t run the numerical checks</span>
            <span class="k">continue</span>

        <span class="k">elif</span> <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">perc_decrease_threshold</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">error_occured</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;The total of </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> seems to have decreased from last time</span><span class="se">\n</span><span class="s1">&#39;</span>\
                                    <span class="sa">f</span><span class="s1">&#39; Prev Value = </span><span class="si">{</span><span class="n">old_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s1"> , New Value = </span><span class="si">{</span><span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">value</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">perc_increase_threshold</span><span class="o">/</span><span class="mi">100</span><span class="p">):</span>
            <span class="n">error_occured</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;The total of </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> has increased by more than</span><span class="se">\n</span><span class="s1">&#39;</span>\
                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">perc_increase_threshold</span><span class="si">}</span><span class="s1">% from last time</span><span class="se">\n</span><span class="s1">&#39;</span>\
                                    <span class="sa">f</span><span class="s1">&#39; Prev Value = </span><span class="si">{</span><span class="n">old_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s1">, New Value = </span><span class="si">{</span><span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="c1"># If cols_to_group is specified, then group by those columns and store the info in the dict</span>
    <span class="k">if</span> <span class="n">cols_to_group</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cols_to_group</span><span class="p">)[</span><span class="n">cols_to_check</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>

    <span class="c1">#The &quot;Columns&quot; and the &quot;info&quot; columns take up a low of space, so we only keep the last 5 entries in the db</span>
    <span class="k">if</span> <span class="n">check_cols_set</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> 
        <span class="n">cols_to_reduce_data</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">,</span><span class="s1">&#39;columns&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cols_to_reduce_data</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>

    <span class="c1"># If manual override is set to False, then add a new row to the historic db with the new values</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">manual_override</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error_occured</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Comparison with historic df </span><span class="si">{</span><span class="n">name_of_df</span><span class="si">}</span><span class="s1">: &#39;</span> <span class="o">+</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span> <span class="o">+</span> <span class="n">error_message</span><span class="p">)</span> <span class="c1"># If error messages has been added to then log it</span>
        <span class="k">if</span> <span class="n">raise_exceptions</span> <span class="ow">and</span> <span class="n">error_occured</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error_occured</span><span class="p">:</span>
            <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;manual_override&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">db_with_new_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">historic_db</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">new_dict</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">db_with_new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">db_with_new_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">cols_to_reduce_data</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">db_with_new_row</span><span class="p">,</span> <span class="n">name_of_table</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># If manual override is set to True, then add a new row to the historic db with the new values</span>
        <span class="c1">#If the previous entry was not a manual override, then add a new row with the new &quot;correct&quot; value</span>
        <span class="k">if</span> <span class="n">old_dict</span><span class="p">[</span><span class="s1">&#39;manual_override&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Manual Override set to True, adding new row to historic db with different values now deemed to be correct&#39;</span><span class="p">)</span> 
            <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;manual_override&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">db_with_new_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">historic_db</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">new_dict</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">db_with_new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">db_with_new_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">cols_to_reduce_data</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_postgresql</span><span class="p">(</span><span class="n">db_with_new_row</span><span class="p">,</span> <span class="n">name_of_table</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">old_dict</span><span class="p">[</span><span class="s1">&#39;manual_override&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span><span class="c1"># If the previous entry was a manual override, don&#39;t let multiple overrides happen in a row to stop someone forgetting they put manual override on and leaving it running in the script</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Manual override already in place, not adding another row, please check the new value is&#39;</span>\
                                <span class="s1">&#39;correct and set manual override back to False&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">error_message</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.quality_assessments.QualityAssessments.duplicates_qa" class="doc doc-heading">
<code class="highlight language-python"><span class="n">duplicates_qa</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name_of_df</span><span class="p">,</span> <span class="n">perc_dupes_thresh</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cols_to_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cols_to_add</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;duplicates&#39;</span><span class="p">,</span> <span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Checks for duplicates in a dataframe and returns the duplicates or the dataframe without duplicates.</p>
<p>The function first checks to see whether the input dataframe is paid or organic data. If it is paid data then the columns to check for duplicates are
['date','platform','country','media_type','cohort','message','ad_name','spend'].</p>
<p>For organic data the standard columns it will check for are ['platform', 'country','media_type' ,'message','url']</p>
<p>You can specify other columns to check for duplicates by passing a list to the cols_to_check argument. You can also add to the standard columns by passing
a list to the cols_to_add argument.</p>
<p>You can specify whether to return the original df, the df with duplicates removed or just the duplicates or nothing by passing 'original', 
'duplicates' or 'duplicates_removed' or 'nothing' to the return_type argument.</p>
<p>If the return type is duplicates_removed, an error message will also be returned, with the error message being blank if no duplicates are found. This can be passed
to a notification function for example.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code><span title="pandas">pd</span>.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>The Dataframe to be checked for duplicates</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>name_of_df</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the dataframe to be used for logging purposes</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>perc_dupes_thresh</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The percentage of duplicates that are allowed before an error is raised. Defaults to 3.</p></td>
          <td>
                <code>3</code>
          </td>
        </tr>
        <tr>
          <td><code>cols_to_check</code></td>
          <td>
                <code>Optional[list]</code>
          </td>
          <td><p>The columns to check for duplicates. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>cols_to_add</code></td>
          <td>
                <code>Optional[list]</code>
          </td>
          <td><p>The columns to add to the standard cols_to_check to duplicates check. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>return_type</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The type of return. Either 'duplicates' or 'duplicates_removed'. Defaults to 'duplicates'.</p></td>
          <td>
                <code>&#39;duplicates&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>raise_exceptions</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If true raise an exception if duplicates are found. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>Exception</code>
          </td>
          <td><p>If raise_exceptions = True and duplicates are found</p></td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>pd.DataFrame: Returns the duplicates,the df without duplicates or the original df depending on the return_type</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/quality_assessments.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">duplicates_qa</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">name_of_df</span><span class="p">,</span> 
        <span class="n">perc_dupes_thresh</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cols_to_check</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">cols_to_add</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;duplicates&#39;</span><span class="p">,</span> 
        <span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks for duplicates in a dataframe and returns the duplicates or the dataframe without duplicates.</span>

<span class="sd">    The function first checks to see whether the input dataframe is paid or organic data. If it is paid data then the columns to check for duplicates are</span>
<span class="sd">    [&#39;date&#39;,&#39;platform&#39;,&#39;country&#39;,&#39;media_type&#39;,&#39;cohort&#39;,&#39;message&#39;,&#39;ad_name&#39;,&#39;spend&#39;].</span>

<span class="sd">    For organic data the standard columns it will check for are [&#39;platform&#39;, &#39;country&#39;,&#39;media_type&#39; ,&#39;message&#39;,&#39;url&#39;]</span>

<span class="sd">    You can specify other columns to check for duplicates by passing a list to the cols_to_check argument. You can also add to the standard columns by passing</span>
<span class="sd">    a list to the cols_to_add argument.</span>

<span class="sd">    You can specify whether to return the original df, the df with duplicates removed or just the duplicates or nothing by passing &#39;original&#39;, </span>
<span class="sd">    &#39;duplicates&#39; or &#39;duplicates_removed&#39; or &#39;nothing&#39; to the return_type argument.</span>

<span class="sd">    If the return type is duplicates_removed, an error message will also be returned, with the error message being blank if no duplicates are found. This can be passed</span>
<span class="sd">    to a notification function for example.</span>


<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): The Dataframe to be checked for duplicates</span>
<span class="sd">        name_of_df (str): The name of the dataframe to be used for logging purposes</span>
<span class="sd">        perc_dupes_thresh (int, optional): The percentage of duplicates that are allowed before an error is raised. Defaults to 3.</span>
<span class="sd">        cols_to_check (Optional[list], optional): The columns to check for duplicates. Defaults to None.</span>
<span class="sd">        cols_to_add (Optional[list], optional): The columns to add to the standard cols_to_check to duplicates check. Defaults to None.</span>
<span class="sd">        return_type (str, optional): The type of return. Either &#39;duplicates&#39; or &#39;duplicates_removed&#39;. Defaults to &#39;duplicates&#39;.</span>
<span class="sd">        raise_exceptions (bool, optional): If true raise an exception if duplicates are found. Defaults to True.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If raise_exceptions = True and duplicates are found</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Returns the duplicates,the df without duplicates or the original df depending on the return_type&quot;&quot;&quot;</span>

    <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Num of rows in </span><span class="si">{</span><span class="n">name_of_df</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">num_rows</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">paid_or_organic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">identify_paid_or_organic</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Paid or Organic? : </span><span class="si">{</span><span class="n">paid_or_organic</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cols_to_check</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">paid_or_organic</span> <span class="o">==</span> <span class="s1">&#39;Paid&#39;</span><span class="p">:</span>
            <span class="c1">#Include date in paid duplicate check because the same ad is repeated across consequitve days</span>
            <span class="c1">#Spend is a good indicator of duplicates in paid data</span>
            <span class="k">if</span> <span class="s1">&#39;spend_usd&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">spend_col</span> <span class="o">=</span> <span class="s1">&#39;spend_usd&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spend_col</span> <span class="o">=</span> <span class="s1">&#39;spend&#39;</span>

            <span class="n">cols_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;media_type&#39;</span><span class="p">,</span> <span class="s1">&#39;cohort&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;ad_name&#39;</span><span class="p">,</span> <span class="n">spend_col</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">paid_or_organic</span> <span class="o">==</span> <span class="s1">&#39;Organic&#39;</span><span class="p">:</span>
            <span class="n">cols_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;media_type&#39;</span> <span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;date_row_added&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">cols_to_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;date_row_added&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cols_to_add</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cols_to_check</span> <span class="o">=</span> <span class="n">cols_to_check</span> <span class="o">+</span> <span class="n">cols_to_add</span>

    <span class="c1">#detect whether a column has the word &#39;age&#39; in it and if so add that column to the cols_to_check</span>
    <span class="c1"># age_columns = [x for x in df.columns if (&#39;age&#39; in x) and (&#39;message&#39; not in x)]</span>
    <span class="c1"># if len(age_columns) &gt; 0:</span>
    <span class="c1">#     logger.info(f&#39;Age columns detected: {age_columns}&#39;)</span>
    <span class="c1">#     cols_to_check = cols_to_check + age_columns</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols_to_check</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">num_duplicates</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">cols_to_check</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_duplicates</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">name_of_df</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">cols_to_check</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">perc_dupes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">cols_to_check</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span> <span class="o">/</span> <span class="n">num_rows</span>
    <span class="n">exceed_thresh</span> <span class="o">=</span> <span class="n">perc_dupes</span> <span class="o">&gt;</span> <span class="n">perc_dupes_thresh</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;% Dupes of whole subset - </span><span class="si">{</span><span class="n">name_of_df</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">perc_dupes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">exceed_thresh</span><span class="p">:</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;% Dupes in </span><span class="si">{</span><span class="n">name_of_df</span><span class="si">}</span><span class="s1"> exceeds </span><span class="si">{</span><span class="n">perc_dupes_thresh</span><span class="si">}</span><span class="s1">%&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">raise_exceptions</span> <span class="ow">and</span> <span class="n">exceed_thresh</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;duplicates&#39;</span><span class="p">:</span> 
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">cols_to_check</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">cols_to_check</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;duplicates_removed&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">cols_to_check</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">error_message</span>

    <span class="k">elif</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;original&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">elif</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;nothing&#39;</span><span class="p">:</span>
        <span class="k">return</span> 
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.quality_assessments.QualityAssessments.naming_convention_checker" class="doc doc-heading">
<code class="highlight language-python"><span class="n">naming_convention_checker</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">gsheet_name</span><span class="p">,</span> <span class="n">naming_convention</span><span class="p">,</span> <span class="n">campaignname_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adgroupname_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adname_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">campaign_col</span><span class="o">=</span><span class="s1">&#39;campaign_name&#39;</span><span class="p">,</span> <span class="n">adgroup_col</span><span class="o">=</span><span class="s1">&#39;group_name&#39;</span><span class="p">,</span> <span class="n">adname_col</span><span class="o">=</span><span class="s1">&#39;ad_name&#39;</span><span class="p">,</span> <span class="n">spend_col</span><span class="o">=</span><span class="s1">&#39;spend_usd&#39;</span><span class="p">,</span> <span class="n">start_char</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">middle_char</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">end_char</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">platform_col</span><span class="o">=</span><span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="n">check_meta_platform</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Checks for naming convention errors in a given DataFrame and outputs the errors to a Google Sheet.</p>
<p>The function takes in a DataFrame containing paid data with columns for campaign name, ad group name, and ad name, 
as well as a DataFrame containing the accepted tags and values for each level of naming (campaign, ad group, ad name). 
Dictionarys for each level fo checking are required this specifies what tags should be checked for, e.g. should a check
for the correct values in 'platform' be performed. If a dictionary for a certain level is not provided that level will
not be checked. The function will output a table in a Google Sheet showing all errors in naming conventions, 
with a tab for each level of errors.</p>
<p>The Google Sheet should be set up with a tab name for each level of errors to check for, 
i.e. 'CampaignNameErrors', 'AdGroupNameErrors', 'AdNameErrors'.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code>DataFrame</code>
          </td>
          <td><p>The DataFrame containing paid data with campaign name, ad group name, and ad name columns.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>naming_convention</code></td>
          <td>
                <code>DataFrame</code>
          </td>
          <td><p>The DataFrame containing the accepted tags and values for each level of naming.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>campaignname_dict</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionary of the tags to be checked for the campaign name, with the column label as the key and the shortcode as the value.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>adgroupname_dict</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionary of the tags to be checked for the ad group name, with the column label as the key and the shortcode as the value.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>adname_dict</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionary of the tags to be checked for the ad name, with the column label as the key and the shortcode as the value.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>campaign_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The column in the input DataFrame that corresponds to the campaign name. Defaults to 'campaign_name'.</p></td>
          <td>
                <code>&#39;campaign_name&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>adgroup_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The column in the input DataFrame that corresponds to the ad group name. Defaults to 'group_name'.</p></td>
          <td>
                <code>&#39;group_name&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>adname_col</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The column in the input DataFrame that corresponds to the ad name. Defaults to 'name'.</p></td>
          <td>
                <code>&#39;ad_name&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>start_char</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The starting character for the tag in the naming convention. Defaults to '_'.</p></td>
          <td>
                <code>&#39;_&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>middle_char</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The character that separates the tag from the value in the naming convention. Defaults to ':'.</p></td>
          <td>
                <code>&#39;:&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>end_char</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The ending character for the tag in the naming convention. Defaults to '_'.</p></td>
          <td>
                <code>&#39;_&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>Writes to a Google Sheet a table with the index being a unique instance of the campaign.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/quality_assessments.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">naming_convention_checker</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">gsheet_name</span><span class="p">,</span> 
        <span class="n">naming_convention</span><span class="p">,</span> 
        <span class="n">campaignname_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adgroupname_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">adname_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">campaign_col</span><span class="o">=</span><span class="s1">&#39;campaign_name&#39;</span><span class="p">,</span> 
        <span class="n">adgroup_col</span><span class="o">=</span><span class="s1">&#39;group_name&#39;</span><span class="p">,</span> <span class="n">adname_col</span><span class="o">=</span><span class="s1">&#39;ad_name&#39;</span><span class="p">,</span>
        <span class="n">spend_col</span><span class="o">=</span><span class="s1">&#39;spend_usd&#39;</span><span class="p">,</span> <span class="n">start_char</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> 
        <span class="n">middle_char</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">end_char</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span>
        <span class="n">platform_col</span><span class="o">=</span><span class="s1">&#39;platform&#39;</span><span class="p">,</span> 
        <span class="n">check_meta_platform</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks for naming convention errors in a given DataFrame and outputs the errors to a Google Sheet.</span>

<span class="sd">    The function takes in a DataFrame containing paid data with columns for campaign name, ad group name, and ad name, </span>
<span class="sd">    as well as a DataFrame containing the accepted tags and values for each level of naming (campaign, ad group, ad name). </span>
<span class="sd">    Dictionarys for each level fo checking are required this specifies what tags should be checked for, e.g. should a check</span>
<span class="sd">    for the correct values in &#39;platform&#39; be performed. If a dictionary for a certain level is not provided that level will</span>
<span class="sd">    not be checked. The function will output a table in a Google Sheet showing all errors in naming conventions, </span>
<span class="sd">    with a tab for each level of errors.</span>

<span class="sd">    The Google Sheet should be set up with a tab name for each level of errors to check for, </span>
<span class="sd">    i.e. &#39;CampaignNameErrors&#39;, &#39;AdGroupNameErrors&#39;, &#39;AdNameErrors&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (DataFrame): The DataFrame containing paid data with campaign name, ad group name, and ad name columns.</span>
<span class="sd">        naming_convention (DataFrame): The DataFrame containing the accepted tags and values for each level of naming.</span>
<span class="sd">        campaignname_dict (dict, optional): A dictionary of the tags to be checked for the campaign name, with the column label as the key and the shortcode as the value.</span>
<span class="sd">        adgroupname_dict (dict, optional): A dictionary of the tags to be checked for the ad group name, with the column label as the key and the shortcode as the value.</span>
<span class="sd">        adname_dict (dict, optional): A dictionary of the tags to be checked for the ad name, with the column label as the key and the shortcode as the value.</span>
<span class="sd">        campaign_col (str, optional): The column in the input DataFrame that corresponds to the campaign name. Defaults to &#39;campaign_name&#39;.</span>
<span class="sd">        adgroup_col (str, optional): The column in the input DataFrame that corresponds to the ad group name. Defaults to &#39;group_name&#39;.</span>
<span class="sd">        adname_col (str, optional): The column in the input DataFrame that corresponds to the ad name. Defaults to &#39;name&#39;.</span>
<span class="sd">        start_char (str, optional): The starting character for the tag in the naming convention. Defaults to &#39;_&#39;.</span>
<span class="sd">        middle_char (str, optional): The character that separates the tag from the value in the naming convention. Defaults to &#39;:&#39;.</span>
<span class="sd">        end_char (str, optional): The ending character for the tag in the naming convention. Defaults to &#39;_&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Writes to a Google Sheet a table with the index being a unique instance of the campaign.&quot;&quot;&quot;</span>

    <span class="n">conv_level_tuple</span> <span class="o">=</span> <span class="p">((</span><span class="n">campaignname_dict</span><span class="p">,</span> <span class="n">campaign_col</span><span class="p">,</span> <span class="s1">&#39;CampaignNameErrors&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">adgroupname_dict</span><span class="p">,</span> <span class="n">adgroup_col</span><span class="p">,</span> <span class="s1">&#39;AdGroupNameErrors&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">adname_dict</span><span class="p">,</span> <span class="n">adname_col</span><span class="p">,</span> <span class="s1">&#39;AdNameErrors&#39;</span><span class="p">))</span>
    <span class="c1"># df = clean.clean_column_names(df)</span>
    <span class="c1">#Obtain the column names of all the Keys available in the convention tracker sheet</span>
    <span class="c1">#https://docs.google.com/spreadsheets/d/1Wtwd6xT9zRLhPICWSWDNZ2mXBy74_xszLVX2ZqO_odo/edit#gid=605935420</span>
    <span class="n">key_values_conv_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; Key&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">naming_convention</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39; Key&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">remove_empties_from_list</span><span class="p">(</span><span class="n">input_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Obtaining a list of keys from the tracker sheet column often results in multiple empty</span>
<span class="sd">            strings, this function removes them from the list&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">input_list</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">return_value</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">acceptable_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This checks for each campaign, group_name or ad_name string, for a certain tag e.g.&#39;pl&#39;</span>
<span class="sd">        whether the tag is even present and if so whether a correct value is present&quot;&quot;&quot;</span>
        <span class="n">search_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">start_char</span><span class="si">}{</span><span class="n">tag</span><span class="si">}{</span><span class="n">middle_char</span><span class="si">}</span><span class="s1">(.*?)</span><span class="si">{</span><span class="n">end_char</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">search_result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">search_string</span><span class="p">,</span> <span class="n">string</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="c1">#add a underscore at so search string has an endpoint to find</span>
        <span class="k">if</span> <span class="n">search_result</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;NoKey&#39;</span>
        <span class="k">elif</span> <span class="n">search_result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;NoKey&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acceptable_values</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;CorrectKeyPresent&quot;</span>
            <span class="k">if</span> <span class="n">search_result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">acceptable_values</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Correct&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Incorrect Value&#39;</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conv_level_tuple</span><span class="p">):</span>
        <span class="n">checking_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;video_views&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">cols_to_sum</span> <span class="o">=</span> <span class="p">[</span><span class="n">spend_col</span><span class="p">,</span> <span class="s1">&#39;video_views&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols_to_sum</span> <span class="o">=</span> <span class="n">spend_col</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">agg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_sum</span><span class="p">}</span>
            <span class="n">agg_dict</span><span class="p">[</span><span class="n">platform_col</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;first&#39;</span>
            <span class="n">output_df</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_dict</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">check_meta_platform</span><span class="p">:</span>
                <span class="n">checking_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;platform_meta_check&#39;</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">check_meta_platform_function</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">platform_col</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Facebook&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">middle_char</span><span class="si">}</span><span class="s1">IG</span><span class="si">{</span><span class="n">end_char</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="n">adname_col</span><span class="p">]:</span>
                            <span class="k">return</span> <span class="s1">&#39;IG in ad name but platform is Facebook&#39;</span>
                    <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">platform_col</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Instagram&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">middle_char</span><span class="si">}</span><span class="s1">FB</span><span class="si">{</span><span class="n">end_char</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="n">adname_col</span><span class="p">]:</span>
                            <span class="k">return</span> <span class="s1">&#39;FB in ad name but platform is Instagram&#39;</span>

                <span class="n">output_df</span><span class="p">[</span><span class="s1">&#39;platform_meta_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">check_meta_platform_function</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#For each level of the naming convention, i.e. campaign, adgroup, adname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_df</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="n">cols_to_sum</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c1">#no convention dict provided therefore ignore</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#For each label and tag in the required set </span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">key_values_conv_cols</span><span class="p">:</span>
                <span class="n">acceptable_values</span><span class="o">=</span> <span class="n">remove_empties_from_list</span><span class="p">(</span><span class="n">naming_convention</span><span class="p">[</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39; Key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">output_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_df</span><span class="p">[</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">return_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">acceptable_values</span><span class="p">))</span>
                <span class="n">checking_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_df</span><span class="p">[</span><span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">return_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
                <span class="n">checking_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (&quot;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>

        <span class="n">output_df</span> <span class="o">=</span> <span class="n">output_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">checking_cols</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_gsheet</span><span class="p">(</span><span class="n">workbook_name</span> <span class="o">=</span> <span class="n">gsheet_name</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span> <span class="n">level</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">df</span> <span class="o">=</span> <span class="n">output_df</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="veetility.quality_assessments.QualityAssessments.null_values_checker" class="doc doc-heading">
<code class="highlight language-python"><span class="n">null_values_checker</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols_to_group</span><span class="p">,</span> <span class="n">gsheet_name</span><span class="p">,</span> <span class="n">tab_name</span><span class="p">,</span> <span class="n">cols_to_ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">null_definitions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_method</span><span class="o">=</span><span class="s1">&#39;gsheet&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Takes in a dataframe and columns to groupby and checks how many null values or null equivalents
there are in the rest of the columns.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>df</code></td>
          <td>
                <code>pandas.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>The Input Dataframe of any type where you want to check for nulls.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cols_to_group</code></td>
          <td>
                <code>list of str</code>
          </td>
          <td><p>The list of columns to perform a groupby operation with the null 
                        percentage counts will be a percentage of nulls in these groupbys.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cols_to_ignore</code></td>
          <td>
                <code>list of str</code>
          </td>
          <td><p>The list of columns to ignore when checking for nulls. Default is None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>gsheet_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the google sheet workbook to pass to the google sheet function.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tab_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The name of the tab in the google sheet workbook to pass to the google sheet function.
                            The google sheet must be setup with this tab already created.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>null_definitions</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>A list containing elements to be defined as a null value.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>output_method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>A string identifying whether the output is to be sent to a Google sheet 
                        ('gsheet') or returned as a dataframe ('Dataframe').</p></td>
          <td>
                <code>&#39;gsheet&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>null_count_df</code></td>          <td>
                <code>pandas.<span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td><p>Dataframe showing the percentage of nulls in each column grouped 
                           by the 'cols_to_group'.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>veetility/quality_assessments.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">null_values_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">,</span>
                        <span class="n">cols_to_group</span><span class="p">,</span>
                        <span class="n">gsheet_name</span><span class="p">,</span>
                        <span class="n">tab_name</span><span class="p">,</span>
                        <span class="n">cols_to_ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">null_definitions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">output_method</span><span class="o">=</span><span class="s1">&#39;gsheet&#39;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes in a dataframe and columns to groupby and checks how many null values or null equivalents</span>
<span class="sd">    there are in the rest of the columns.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pandas.DataFrame): The Input Dataframe of any type where you want to check for nulls.</span>
<span class="sd">        cols_to_group (list of str): The list of columns to perform a groupby operation with the null </span>
<span class="sd">                                    percentage counts will be a percentage of nulls in these groupbys.</span>
<span class="sd">        cols_to_ignore (list of str): The list of columns to ignore when checking for nulls. Default is None.</span>
<span class="sd">        gsheet_name (str): The name of the google sheet workbook to pass to the google sheet function.</span>
<span class="sd">        tab_name (str): The name of the tab in the google sheet workbook to pass to the google sheet function.</span>
<span class="sd">                                        The google sheet must be setup with this tab already created.</span>
<span class="sd">        null_definitions (list): A list containing elements to be defined as a null value.</span>
<span class="sd">        output_method (str): A string identifying whether the output is to be sent to a Google sheet </span>
<span class="sd">                                    (&#39;gsheet&#39;) or returned as a dataframe (&#39;Dataframe&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        null_count_df (pandas.DataFrame): Dataframe showing the percentage of nulls in each column grouped </span>
<span class="sd">                                       by the &#39;cols_to_group&#39;.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">null_definitions</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">null_definitions</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;None&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">cols_to_ignore</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cols_to_ignore</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">null</span> <span class="ow">in</span> <span class="n">null_definitions</span><span class="p">:</span> 
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="s1">&#39;NullValue&#39;</span><span class="p">)</span>

    <span class="n">null_count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">cols_to_group</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">other_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols_to_group</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols_to_ignore</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">other_cols</span><span class="p">:</span>
        <span class="n">col_groupby</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cols_to_group</span><span class="p">)[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;NullValue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">/</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">null_count_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">null_count_df</span><span class="p">,</span> <span class="n">col_groupby</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_method</span> <span class="o">==</span> <span class="s1">&#39;gsheet&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">write_to_gsheet</span><span class="p">(</span><span class="n">gsheet_name</span><span class="p">,</span> <span class="n">tab_name</span><span class="p">,</span> <span class="n">null_count_df</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">output_method</span> <span class="o">==</span> <span class="s1">&#39;Dataframe&#39;</span><span class="p">:</span> 
        <span class="k">return</span> <span class="n">null_count_df</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
    
  </body>
</html>